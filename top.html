<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script type="module">
        import { login, logout, monitorAuth, loadFromCloud } from "./character/firestore.js";

        const LOCAL_IMG_BASE = "./images/character/";
        const PHOTO_BASE = "./images/photo/";
        const DEFAULT_THEME = "#00ffcc";
        
        let currentUser = null;
        let charDataList = [];
        let currentIndex = 0;
        let typeWriterTimeout1 = null;
        let typeWriterTimeout2 = null;
        let isDuo = false; 

        let particleMaterial;
        let targetColor = new THREE.Color(DEFAULT_THEME);

        const fallbackData = [{
            name: "System",
            color: "#00ffcc",
            remarks: "アーカイブへようこそ。",
            image: "https://via.placeholder.com/800x1200/111/333?text=STANDBY"
        }];

        // --- DOM Elements ---
        const imgEl1 = document.getElementById('char-img-1');
        const imgEl2 = document.getElementById('char-img-2');
        const bubble1 = document.getElementById('bubble-1');
        const bubble2 = document.getElementById('bubble-2');
        const nameLabel1 = document.getElementById('name-label-1');
        const nameLabel2 = document.getElementById('name-label-2');
        const textContainer1 = document.getElementById('text-1');
        const textContainer2 = document.getElementById('text-2');
        const rootStyles = document.documentElement.style;

        // --- Screen Fit ---
        function fitContent() {
            const content = document.getElementById('content-body');
            const winW = window.innerWidth, winH = window.innerHeight;
            const baseW = 1280, baseH = 720;

            if (winH > winW) { // Portrait
                content.style.width = `${baseW}px`; content.style.height = `${baseH}px`;
                content.style.transform = `rotate(90deg) translateY(-100%) scale(${winH / baseW})`;
                content.style.transformOrigin = "top left";
            } else { // Landscape
                const scale = Math.min(winW / baseW, winH / baseH);
                content.style.width = `${baseW}px`; content.style.height = `${baseH}px`;
                content.style.transform = `scale(${scale})`;
                content.style.transformOrigin = "top left";
                content.style.left = `${(winW - baseW * scale) / 2}px`;
                content.style.top = `${(winH - baseH * scale) / 2}px`;
            }
        }
        window.addEventListener('resize', fitContent);
        window.addEventListener('load', fitContent);

        // --- Dialogue Logic ---
        function getDuoConversation(char1, char2) {
            if (!char1 || !char2) return null;
            
            // AにBとの会話があるか
            if (char1.duo_conversations) {
                const pairData = char1.duo_conversations.find(p => p.partner === char2.name);
                if (pairData && pairData.scripts && pairData.scripts.length > 0) {
                    const script = pairData.scripts[Math.floor(Math.random() * pairData.scripts.length)];
                    return { text1: script.a, text2: script.b };
                }
            }
            // BにAとの会話があるか(逆)
            if (char2.duo_conversations) {
                const pairData = char2.duo_conversations.find(p => p.partner === char1.name);
                if (pairData && pairData.scripts && pairData.scripts.length > 0) {
                    const script = pairData.scripts[Math.floor(Math.random() * pairData.scripts.length)];
                    return { text1: script.b, text2: script.a }; // 左右反転
                }
            }
            return null;
        }

        function getSoloDialogue(selfChar, isDuoMode) {
            const currentSan = (selfChar.vitals && selfChar.vitals.san) ? parseInt(selfChar.vitals.san) : 99;
            if (currentSan <= 20 && selfChar.dialogue_lowsan) return selfChar.dialogue_lowsan;
            if (isDuoMode && selfChar.dialogue_duo) return selfChar.dialogue_duo;
            
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 11 && selfChar.dialogue_morning) return selfChar.dialogue_morning;
            if (selfChar.dialogue_day && hour >= 11 && hour < 18) return selfChar.dialogue_day;
            if ((hour >= 18 || hour < 5) && selfChar.dialogue_night) return selfChar.dialogue_night;

            return selfChar.dialogue_default || selfChar.remarks || selfChar.txtRoleplay || "……。";
        }

        function resolveImage(charName, cloudUrl) {
            return new Promise((resolve) => {
                if (!charName) { resolve(cloudUrl || fallbackData[0].image); return; }
                const localPath = `${LOCAL_IMG_BASE}${charName}.png`;
                const img = new Image();
                img.onload = () => resolve(localPath);
                img.onerror = () => resolve(cloudUrl || `https://via.placeholder.com/800x1200/111/333?text=${encodeURIComponent(charName)}`);
                img.src = localPath;
            });
        }

        // --- Main Update ---
        async function updateDisplay() {
            const char1 = charDataList[currentIndex];
            const nextIdx = (currentIndex + 1) % charDataList.length;
            const char2 = charDataList[nextIdx];

            // リセット
            imgEl1.classList.remove('visible');
            if (isDuo) imgEl2.classList.remove('visible');
            bubble1.classList.remove('show');
            bubble2.classList.remove('show');

            // 画像パス解決
            const src1 = await resolveImage(char1.name, char1.image);
            let src2 = null;
            if (isDuo) src2 = await resolveImage(char2.name, char2.image);

            // テーマカラー設定
            const theme = char1.color || char1.inpThemeColor || DEFAULT_THEME;
            rootStyles.setProperty('--accent-color', theme);
            if (!document.body.classList.contains('mode-white')) targetColor.set(theme);

            // 台詞決定
            let text1 = "", text2 = "";
            if (isDuo) {
                const convSet = getDuoConversation(char1, char2);
                if (convSet) {
                    text1 = convSet.text1;
                    text2 = convSet.text2;
                } else {
                    text1 = getSoloDialogue(char1, true);
                    text2 = getSoloDialogue(char2, true);
                }
            } else {
                text1 = getSoloDialogue(char1, false);
            }
            if(text1) text1 = text1.replace(/<br>/g, "\n");
            if(text2) text2 = text2.replace(/<br>/g, "\n");

            // 画像・台詞表示処理
            
            // 1. 画像セット
            imgEl1.src = src1;
            imgEl1.onload = () => imgEl1.classList.add('visible');
            
            // キャラ1の台詞 (0.6秒後に強制表示)
            nameLabel1.textContent = char1.name.toUpperCase();
            setTimeout(() => {
                bubble1.classList.add('show');
                startTypewriter(text1, textContainer1, 1);
            }, 600);

            if (isDuo) {
                // 2. 二人目の画像セット
                imgEl2.src = src2;
                imgEl2.onload = () => imgEl2.classList.add('visible');
                
                // キャラ2の台詞 (0.8秒後に強制表示)
                nameLabel2.textContent = char2.name.toUpperCase();
                setTimeout(() => {
                    bubble2.classList.add('show');
                    // 枠色設定
                    const theme2 = char2.color || char2.inpThemeColor || "#fff";
                    bubble2.style.borderLeftColor = theme2;
                    nameLabel2.style.color = theme2;
                    
                    startTypewriter(text2, textContainer2, 2);
                }, 800);
            }
        }

        function startTypewriter(text, container, id) {
            if (!text) text = "……。";
            container.textContent = "";
            let timerVar = (id === 1) ? typeWriterTimeout1 : typeWriterTimeout2;
            if (timerVar) clearTimeout(timerVar);
            
            let i = 0;
            function type() {
                if (i < text.length) {
                    container.textContent += text.charAt(i); i++;
                    const next = setTimeout(type, 30);
                    if (id === 1) typeWriterTimeout1 = next; else typeWriterTimeout2 = next;
                }
            }
            type();
        }

        // --- Other Systems ---
        const bgmPlayer = document.getElementById('bgm-player');
        window.toggleBGM = () => {
            const btn = document.getElementById('btn-play');
            if (bgmPlayer.paused) { 
                bgmPlayer.play().then(()=>{ btn.textContent='pause'; btn.classList.add('playing'); }).catch(e=>console.log(e)); 
            } else { 
                bgmPlayer.pause(); btn.textContent='play_arrow'; btn.classList.remove('playing'); 
            }
        };
        window.changeVolume = (v) => { bgmPlayer.volume = v; };
        
        window.toggleBgModal = () => document.getElementById('bg-modal').classList.toggle('open');
        window.setBgMode = (mode, photoIdx) => {
            const body = document.body;
            body.classList.remove('mode-black', 'mode-white', 'mode-photo');
            document.documentElement.style.setProperty('--bg-image-url', 'none');
            if (mode === 'black') { body.classList.add('mode-black'); updateParticlesForBg('dark'); }
            else if (mode === 'white') { body.classList.add('mode-white'); updateParticlesForBg('light'); }
            else if (mode === 'photo') { 
                body.classList.add('mode-photo'); 
                document.documentElement.style.setProperty('--bg-image-url', `url('${PHOTO_BASE}${photoIdx}.png')`);
                updateParticlesForBg('dark');
            }
            toggleBgModal();
        };
        const bgGrid = document.getElementById('bg-grid');
        for (let i = 1; i <= 5; i++) {
            const div = document.createElement('div'); div.className = 'bg-option';
            div.style.backgroundImage = `url('${PHOTO_BASE}${i}.png')`;
            div.onclick = () => window.setBgMode('photo', i);
            bgGrid.appendChild(div);
        }

        // Particles
        function createParticles() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            function getTexture() {
                const c = document.createElement('canvas'); c.width = 32; c.height = 32;
                const ctx = c.getContext('2d');
                const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
                g.addColorStop(0, 'rgba(255,255,255,1)'); g.addColorStop(0.4, 'rgba(255,255,255,0.5)'); g.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = g; ctx.fillRect(0,0,32,32); return new THREE.Texture(c);
            }
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 5000; i++) vertices.push(THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000));
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            particleMaterial = new THREE.PointsMaterial({ 
                color: new THREE.Color(DEFAULT_THEME), size: 5, map: getTexture(), 
                transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending, depthWrite: false 
            });
            particleMaterial.map.needsUpdate = true;
            const points = new THREE.Points(geometry, particleMaterial);
            scene.add(points); camera.position.z = 1000;

            function animate() {
                requestAnimationFrame(animate);
                points.rotation.x += 0.0003; points.rotation.y += 0.0005;
                if (!document.body.classList.contains('mode-white')) particleMaterial.color.lerp(targetColor, 0.05);
                renderer.render(scene, camera);
            }
            animate();
            window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        }
        function updateParticlesForBg(type) {
            if (type === 'light') {
                particleMaterial.blending = THREE.NormalBlending; particleMaterial.opacity = 0.4;
                particleMaterial.color.setHex(0x555555); targetColor.setHex(0x555555);
            } else {
                particleMaterial.blending = THREE.AdditiveBlending; particleMaterial.opacity = 0.8;
                const char = charDataList[currentIndex];
                const theme = char ? (char.color || char.inpThemeColor || DEFAULT_THEME) : DEFAULT_THEME;
                targetColor.set(theme);
            }
            particleMaterial.needsUpdate = true;
        }

        // News
        async function initNews() {
            const el = document.getElementById('news-content');
            const paths = ['./report.json', './TOP/report.json', '../TOP/report.json'];
            let data = null;
            for (const path of paths) {
                try {
                    const res = await fetch(`${path}?t=${Date.now()}`);
                    if (res.ok) { data = await res.json(); break; }
                } catch (e) {}
            }
            if (!data || !data.length) {
                el.textContent = "Welcome to Uchiyoso Archive."; el.classList.add('active'); return;
            }
            const cycle = () => {
                el.classList.remove('active');
                setTimeout(() => {
                    el.textContent = data[Math.floor(Math.random() * data.length)];
                    el.classList.add('active');
                }, 500);
            };
            cycle(); setInterval(cycle, 6000);
        }

        // Auth & Mode
        const userDisplay = document.getElementById('user-display');
        const connectBtn = document.getElementById('main-connect-btn');
        monitorAuth(
            async (user) => {
                currentUser = user;
                userDisplay.textContent = (user.displayName || "MEMBER").toUpperCase();
                connectBtn.textContent = "NEXT";
                const data = await loadFromCloud();
                if (data && Object.keys(data).length > 0) charDataList = Object.values(data);
                else charDataList = [{ name: "No Data", remarks: "データがありません。", color: "#555" }];
                currentIndex = Math.floor(Math.random() * charDataList.length);
                updateDisplay();
            },
            () => {
                currentUser = null; userDisplay.textContent = "GUEST"; connectBtn.textContent = "CONNECT";
                charDataList = fallbackData; currentIndex = 0; updateDisplay();
            }
        );

        window.handleConnect = () => {
            if (bgmPlayer.paused) { try { toggleBGM(); } catch(e){} }
            if (!currentUser) login(); else nextChar();
        };
        window.handleCharClick = () => { if (currentUser) nextChar(); };
        
        function nextChar() {
            if (charDataList.length <= 1) return;
            currentIndex = (currentIndex + 1) % charDataList.length;
            updateDisplay();
        }

        window.setMode = (mode) => {
            isDuo = (mode === 'duo');
            document.getElementById('btn-solo').classList.toggle('active', !isDuo);
            document.getElementById('btn-duo').classList.toggle('active', isDuo);
            const stage = document.getElementById('char-stage');
            const body = document.body;
            if (isDuo) {
                stage.classList.add('duo-mode'); body.classList.add('mode-duo'); body.classList.remove('mode-solo');
                document.getElementById('char-img-2').style.display = 'block';
            } else {
                stage.classList.remove('duo-mode'); body.classList.add('mode-solo'); body.classList.remove('mode-duo');
                document.getElementById('char-img-2').style.display = 'none';
                document.getElementById('bubble-2').classList.remove('show');
            }
            updateDisplay();
        };

        createParticles(); initNews();
    </script>