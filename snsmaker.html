<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>|SNS Maker v1.0 Chocolat Mer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --line-bg: #849ebf;
            --line-green: #8de055;
            --line-text: #242424;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: #e0e5ec;
            min-height: 100vh;
        }

        /* Glass Panel */
        .editor-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Phone Frame - Enlarged */
        .phone-frame {
            width: 450px;
            height: 1000px;
            border-radius: 55px;
            border: 16px solid #1c1c1e;
            background: #fff;
            position: relative;
            overflow: hidden;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.5);
            flex-shrink: 0;
            z-index: 1;
        }

        .notch {
            position: absolute;
            top: 0; left: 50%; transform: translateX(-50%);
            width: 160px; height: 36px; background: #1c1c1e;
            border-bottom-left-radius: 22px; border-bottom-right-radius: 22px;
            z-index: 50;
        }
        
        .status-bar-bg {
            background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0) 100%);
            z-index: 40;
            height: 54px;
        }
        
        .app-header {
            height: 100px;
            padding-top: 50px; 
            background: rgba(132, 158, 191, 0.95);
            backdrop-filter: blur(4px);
            z-index: 30;
        }

        .chat-area-container {
            background-color: var(--line-bg);
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        .bg-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0);
            pointer-events: none;
            z-index: 0;
        }

        /* --- BUBBLE STYLE --- */
        .bubble-wrapper {
            display: flex;
            align-items: flex-start;
            max-width: 100%;
        }

        .bubble {
            position: relative;
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            min-height: 38px;
            display: flex;
            align-items: center;
            max-width: 300px;
            word-wrap: break-word;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            flex-shrink: 0;
            z-index: 1;
        }

        .bubble-left {
            background: #ffffff;
            color: var(--line-text);
            margin-left: 6px;
            border-top-left-radius: 0; 
        }
        .bubble-left::before {
            content: ""; position: absolute; top: 0; left: -6px; width: 0; height: 0;
            border-top: 0px solid transparent;
            border-right: 6px solid #ffffff;
            border-bottom: 6px solid transparent;
        }

        .bubble-right {
            background: var(--line-green);
            color: var(--line-text);
            margin-right: 6px;
            border-top-right-radius: 0;
        }
        .bubble-right::before {
            content: ""; position: absolute; top: 0; right: -6px; width: 0; height: 0;
            border-top: 0px solid transparent;
            border-left: 6px solid var(--line-green);
            border-bottom: 6px solid transparent;
        }

        /* --- CALL HISTORY BUBBLES --- */
        .call-history-bubble {
            border-radius: 18px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 180px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }

        .call-history-bubble.left {
            background: #ffffff;
            color: #242424;
            margin-left: 6px;
            border-top-left-radius: 0;
        }
        .call-history-bubble.left::before {
            content: ""; position: absolute; top: 0; left: -6px; width: 0; height: 0;
            border-top: 0px solid transparent;
            border-right: 6px solid #ffffff;
            border-bottom: 6px solid transparent;
        }

        .call-history-bubble.right {
            background: var(--line-green);
            color: #242424;
            margin-right: 6px;
            border-top-right-radius: 0;
        }
        .call-history-bubble.right::before {
            content: ""; position: absolute; top: 0; right: -6px; width: 0; height: 0;
            border-top: 0px solid transparent;
            border-left: 6px solid var(--line-green);
            border-bottom: 6px solid transparent;
        }

        .call-icon-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        .call-history-bubble.left .call-icon-circle { background: #f0f0f0; color: #242424; }
        .call-history-bubble.right .call-icon-circle { background: rgba(0,0,0,0.1); color: #242424; }
        
        .call-active-widget {
            background: #242424;
            color: white;
            border-radius: 20px;
            padding: 14px;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .meta-text {
            font-size: 9px; color: #fff; line-height: 1.2;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        
        .header-count { box-shadow: none !important; text-shadow: none !important; }
        .footer-icon { font-size: 1.5rem; color: #2e353d; cursor: pointer; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        [contenteditable="true"]:focus { outline: 2px solid #a78bfa; background: rgba(255,255,255,0.3); border-radius: 4px; }
    </style>
</head>
<body class="flex items-center justify-center p-4 lg:p-8">

    <div class="flex flex-col lg:flex-row gap-8 w-full max-w-[1600px] items-start justify-center h-full">

        <div class="editor-panel w-full lg:w-[480px] p-6 flex flex-col gap-6 max-h-[95vh] overflow-y-auto no-scrollbar">
            
            <div class="border-b pb-4 border-gray-300">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-file-export text-purple-600"></i> Editor v12.2
                </h2>
                <p class="text-xs text-gray-500 mt-1">Footer Input Fix</p>
            </div>

            <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                <label class="text-xs font-bold text-purple-600 uppercase tracking-wider mb-2 block">Project Data</label>
                <div class="flex gap-2">
                    <button onclick="saveProjectData()" class="flex-1 bg-white border border-purple-300 text-purple-700 text-xs font-bold py-2 rounded-lg hover:bg-purple-100 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-download"></i> „Éá„Éº„Çø‰øùÂ≠ò(.json)
                    </button>
                    <label class="flex-1 cursor-pointer bg-purple-600 border border-transparent text-white text-xs font-bold py-2 rounded-lg hover:bg-purple-700 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-upload"></i> „Éá„Éº„ÇøË™≠Ëæº
                        <input type="file" id="json-upload" accept=".json" class="hidden">
                    </label>
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Speaker & Members</label>
                <div class="flex gap-3 overflow-x-auto pb-4 items-end" id="char-list"></div>
                <button onclick="addNewCharacter()" class="w-full mt-2 border border-dashed border-purple-400 text-purple-600 text-xs font-bold py-2 rounded-lg hover:bg-purple-50 transition">
                    <i class="fa-solid fa-plus"></i> Êñ∞„Åó„ÅÑ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíËøΩÂä†
                </button>
            </div>

            <div class="bg-gray-100 p-4 rounded-xl border border-gray-200">
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Background</label>
                <div class="flex flex-col gap-3">
                    <div class="flex gap-2">
                        <label class="flex-1 cursor-pointer bg-white border border-gray-300 text-gray-600 text-xs font-bold py-2 rounded-lg hover:bg-gray-50 transition flex items-center justify-center gap-2">
                            <i class="fa-regular fa-image"></i> ËÉåÊôØÁîªÂÉè
                            <input type="file" id="bg-upload" accept="image/*" class="hidden">
                        </label>
                        <button onclick="resetBg()" class="px-3 bg-white border border-gray-300 text-gray-600 rounded-lg text-xs">
                            <i class="fa-solid fa-rotate-left"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">Êöó„Åï:</span>
                        <input type="range" id="bg-opacity" min="0" max="0.8" step="0.1" value="0" class="flex-1 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
            </div>

            <div class="bg-gray-100 p-1 rounded-lg flex text-sm font-bold text-gray-500">
                <button onclick="setMode('text')" id="tab-text" class="flex-1 py-2 rounded-md bg-white text-gray-800 shadow-sm transition">üí¨ „ÉÜ„Ç≠„Çπ„Éà</button>
                <button onclick="setMode('sticker')" id="tab-sticker" class="flex-1 py-2 rounded-md hover:bg-white/50 transition">üòä „Çπ„Çø„É≥„Éó</button>
                <button onclick="setMode('call')" id="tab-call" class="flex-1 py-2 rounded-md hover:bg-white/50 transition">üìû ÈÄöË©±</button>
            </div>

            <div id="input-text-area" class="block">
                <textarea id="message-input" rows="2" class="w-full p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-green-400 outline-none text-sm" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..."></textarea>
            </div>

            <div id="input-sticker-area" class="hidden">
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <img src="https://placehold.co/200x200/png?text=OK!" onclick="selectSticker(this)" class="cursor-pointer rounded border-2 border-transparent hover:border-green-500 transition">
                    <img src="https://placehold.co/200x200/png?text=LOVE" onclick="selectSticker(this)" class="cursor-pointer rounded border-2 border-transparent hover:border-green-500 transition">
                    <img src="https://placehold.co/200x200/png?text=Shock" onclick="selectSticker(this)" class="cursor-pointer rounded border-2 border-transparent hover:border-green-500 transition">
                </div>
                <div class="text-xs text-gray-500 mt-2">‚ÄªÁîªÂÉè‰øùÂ≠ò„ÅÆÂâç„Å´„ÄÅËá™ÂàÜ„ÅÆÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Çπ„Çø„É≥„ÉóÂåñ„ÇÇÂèØËÉΩ„Åß„Åô„ÄÇ</div>
                <input type="file" id="sticker-upload" accept="image/*" class="mt-2 text-xs w-full">
            </div>

            <div id="input-call-area" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <select id="call-status" class="p-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-purple-400">
                        <option value="active">üü¢ ÈÄöË©±‰∏≠</option>
                        <option value="voice">üìû Èü≥Â£∞ÈÄöË©±</option>
                        <option value="cancel">üö´ „Ç≠„É£„É≥„Çª„É´</option>
                        <option value="noanswer">üî¥ ÂøúÁ≠î„Å™„Åó</option>
                    </select>
                    <input type="text" id="call-duration" value="12:34" class="p-2 border rounded-lg text-sm bg-white" placeholder="ÊôÇÈñì/„ÉÜ„Ç≠„Çπ„Éà">
                </div>
            </div>

            <div class="flex gap-2 pt-2">
                <button onclick="addToChat()" class="flex-1 bg-gradient-to-r from-green-400 to-green-500 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-xl transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> ÈÄÅ‰ø°
                </button>
                <button onclick="undoLast()" class="px-5 bg-gray-200 text-gray-600 font-bold rounded-xl hover:bg-gray-300 transition" title="1„Å§Êàª„Çã">
                    <i class="fa-solid fa-rotate-left"></i>
                </button>
            </div>

            <div class="pt-2">
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">ÁâπÊÆäÊåøÂÖ•</label>
                <div class="flex gap-2">
                    <button onclick="addDate('‰ªäÊó•')" class="flex-1 bg-white border border-gray-300 text-gray-600 text-xs font-bold py-2 rounded-lg hover:bg-gray-50 transition">‰ªäÊó•</button>
                    <button onclick="addDate('Êò®Êó•')" class="flex-1 bg-white border border-gray-300 text-gray-600 text-xs font-bold py-2 rounded-lg hover:bg-gray-50 transition">Êò®Êó•</button>
                    <button onclick="addDate(prompt('„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ','2025/12/24'))" class="flex-1 bg-white border border-gray-300 text-gray-600 text-xs font-bold py-2 rounded-lg hover:bg-gray-50 transition">Ëá™Áî±</button>
                </div>
            </div>

            <hr class="border-gray-200">

            <div class="space-y-2">
                <button onclick="downloadPhoneView()" class="w-full border-2 border-gray-800 text-gray-800 font-bold py-3 rounded-xl hover:bg-gray-800 hover:text-white transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-mobile-screen"></i> „Çπ„Éû„ÉõÂÖ®‰Ωì„Çí‰øùÂ≠ò
                </button>
                <button onclick="downloadScreenShot()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-crop-simple"></i> ÁîªÈù¢„ÅÆ„Åø‰øùÂ≠ò („Çπ„ÇØ„Ç∑„ÉßÈ¢®)
                </button>
                <button onclick="downloadFullChat()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl hover:bg-gray-900 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-scroll"></i> ‰ºöË©±ÂÖ®‰Ωì„Çí‰øùÂ≠ò (Á∏¶Èï∑)
                </button>
            </div>
        </div>

        <div class="phone-frame flex flex-col shadow-2xl transition-all duration-300">
            <div class="notch"></div>
            
            <div class="status-bar-bg w-full flex justify-between items-end px-7 pb-5 absolute top-0 left-0 right-0 pointer-events-none">
                <span id="sb-time" class="text-white text-[15px] font-bold pointer-events-auto leading-none mb-0.5" contenteditable="true">12:34</span>
                <div class="flex gap-1.5 text-white items-center">
                    <i class="fa-solid fa-signal text-[14px]"></i>
                    <i class="fa-solid fa-wifi text-[14px]"></i>
                    <i class="fa-solid fa-battery-full text-[20px]"></i>
                </div>
            </div>

            <div class="app-header flex items-end px-4 pb-3 justify-between sticky top-0 border-b border-black/5">
                <div class="flex items-center gap-1 text-white cursor-pointer hover:opacity-70 pb-1">
                    <i class="fa-solid fa-chevron-left text-2xl"></i>
                </div>
                
                <div class="text-white font-bold text-lg flex-1 ml-4 outline-none header-count pb-1" contenteditable="true" spellcheck="false" id="header-name">È±∏</div>
                
                <div class="flex items-center gap-6 text-white pb-1 mr-1">
                    <i class="fa-solid fa-magnifying-glass text-xl"></i>
                    <i class="fa-solid fa-phone text-xl"></i>
                    <i class="fa-solid fa-bars text-2xl"></i>
                </div>
            </div>

            <div id="capture-area" class="flex-1 chat-area-container overflow-y-auto p-4 space-y-1 no-scrollbar flex flex-col pb-4">
                <div class="bg-overlay" id="bg-overlay-layer"></div>
                
                <div class="flex justify-center my-2 relative z-10">
                    <span class="bg-black/10 text-white text-[10px] px-3 py-1 rounded-full cursor-text date-label" contenteditable="true">‰ªäÊó•</span>
                </div>

                <div class="flex justify-start items-end gap-2 relative z-10">
                    <img src="images/icons/lineicon-syu.png" onerror="this.src='https://placehold.co/100x100/orange/white?text=S'" class="w-11 h-11 rounded-full mb-auto border border-gray-300 bg-white object-cover">
                    <div>
                        <div class="bubble-wrapper">
                            <div class="bubble bubble-left" contenteditable="true">„Çµ„É≥„Éó„É´</div>
                            <div class="flex flex-col justify-end min-w-[30px] ml-1">
                                <span class="meta-text text-[9px] text-white/80" contenteditable="true">18:20</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end items-end gap-1 mb-1 group relative z-10">
                     <div class="call-active-widget flex items-center justify-between z-10">
                         <div class="flex items-center gap-3 z-10">
                            <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center animate-pulse">
                                <i class="fa-solid fa-phone text-white"></i>
                            </div>
                            <div>
                                <div class="text-white text-xs font-bold" contenteditable="true">ÈÄöË©±‰∏≠</div>
                                <div class="text-white/80 text-[10px]" contenteditable="true">05:24</div>
                            </div>
                         </div>
                    </div>
                </div>

            </div>

            <div class="bg-white px-3 py-2 pb-6 border-t border-gray-200 flex items-center gap-4 shrink-0 z-20">
                <i class="fa-solid fa-plus footer-icon text-2xl"></i>
                <i class="fa-solid fa-camera footer-icon text-2xl"></i>
                <i class="fa-regular fa-image footer-icon text-2xl"></i>
                
                <div class="flex-1 bg-[#f2f2f2] rounded-full h-10 flex items-center px-3 justify-end relative cursor-text">
                    <div class="absolute left-3 right-8 text-gray-800 text-sm overflow-hidden h-8 top-1 outline-none leading-8" contenteditable="true"></div>
                    <i class="fa-regular fa-face-smile text-gray-500 text-xl cursor-pointer"></i>
                </div>
                <i class="fa-solid fa-microphone footer-icon text-xl"></i>
            </div>
        </div>

    </div>

    <script>
        let characters = [
            { id: 'me', name: 'Ëá™ÂàÜ', type: 'me', icon: '' },
            { id: 'char1', name: 'È±∏', type: 'other', icon: 'images/icons/lineicon-syu.png' },
            { id: 'char2', name: 'Yua', type: 'other', icon: 'images/icons/lineicon-yua.png' }
        ];

        let state = { selectedCharId: 'me', mode: 'text', selectedStickerSrc: '' };

        function init() { 
            renderCharList(); 
            updateTime();
            setInterval(updateTime, 1000);
        }

        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const el = document.getElementById('sb-time');
            if (document.activeElement !== el) {
                el.innerText = timeStr;
            }
        }

        function renderCharList() {
            const container = document.getElementById('char-list');
            container.innerHTML = '';
            characters.forEach(char => {
                const isSelected = char.id === state.selectedCharId;
                const div = document.createElement('div');
                div.className = `cursor-pointer flex flex-col items-center min-w-[50px] transition ${isSelected ? 'scale-110 opacity-100' : 'opacity-60'}`;
                div.onclick = () => { 
                    state.selectedCharId = char.id; 
                    renderCharList(); 
                    if(char.type === 'other') document.getElementById('header-name').innerText = char.name;
                };
                
                let iconHtml;
                if (char.type === 'me') {
                    iconHtml = `<div class="w-11 h-11 rounded-full bg-green-500 border-2 border-white flex items-center justify-center text-white text-[10px] shadow font-bold">Ëá™ÂàÜ</div>`;
                } else {
                    iconHtml = `<img src="${char.icon}" onerror="this.src='https://placehold.co/100x100/gray/white?text=${char.name.charAt(0)}'" class="w-11 h-11 rounded-full border-2 border-white shadow object-cover">`;
                }

                div.innerHTML = `${iconHtml}<span class="text-[9px] text-gray-500 mt-1 font-bold truncate max-w-[50px]">${char.name}</span>`;
                container.appendChild(div);
            });
        }

        function addNewCharacter() {
            const name = prompt("„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:", "Êñ∞„Ç≠„É£„É©");
            if (!name) return;
            const iconUrl = prompt("„Ç¢„Ç§„Ç≥„É≥ÁîªÂÉè„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:", "");
            const finalIcon = iconUrl ? iconUrl : `https://placehold.co/100x100/gray/white?text=${name.charAt(0)}`;
            characters.push({ id: 'char' + Date.now(), name: name, type: 'other', icon: finalIcon });
            renderCharList();
        }

        function setMode(mode) {
            state.mode = mode;
            ['text', 'sticker', 'call'].forEach(m => {
                document.getElementById(`tab-${m}`).className = m === mode 
                    ? 'flex-1 py-2 rounded-md bg-white text-gray-800 shadow-sm transition' 
                    : 'flex-1 py-2 rounded-md hover:bg-white/50 transition';
                document.getElementById(`input-${m}-area`).style.display = m === mode ? 'block' : 'none';
            });
        }

        function selectSticker(imgEl) {
            document.querySelectorAll('#input-sticker-area img').forEach(img => img.classList.remove('border-green-500'));
            imgEl.classList.add('border-green-500');
            state.selectedStickerSrc = imgEl.src;
        }
        
        document.getElementById('sticker-upload').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.selectedStickerSrc = e.target.result;
                    alert("„Çπ„Çø„É≥„ÉóÁî®ÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ");
                }
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        function addDate(label) {
            if(!label) return;
            const container = document.getElementById('capture-area');
            const div = document.createElement('div');
            div.className = "flex justify-center my-4 relative z-10";
            div.innerHTML = `<span class="bg-black/10 text-white text-[10px] px-3 py-1 rounded-full cursor-text date-label" contenteditable="true">${label}</span>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addToChat() {
            const container = document.getElementById('capture-area');
            const char = characters.find(c => c.id === state.selectedCharId);
            const isMe = char.type === 'me';
            const timeStr = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            
            let contentHtml = '';

            if (state.mode === 'text') {
                const text = document.getElementById('message-input').value.trim().replace(/\n/g, '<br>');
                if (!text) return;
                const bubbleClass = isMe ? 'bubble-right' : 'bubble-left';
                contentHtml = `<div class="bubble ${bubbleClass}" contenteditable="true">${text}</div>`;
                document.getElementById('message-input').value = '';
            }
            else if (state.mode === 'sticker') {
                if (!state.selectedStickerSrc) return;
                contentHtml = `<img src="${state.selectedStickerSrc}" class="rounded-lg max-w-[140px] relative z-10">`;
            }
            else if (state.mode === 'call') {
                const status = document.getElementById('call-status').value;
                const duration = document.getElementById('call-duration').value;
                
                if (status === 'active') {
                    contentHtml = `
                        <div class="call-active-widget flex items-center justify-between z-10">
                             <div class="flex items-center gap-3 z-10">
                                <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center animate-pulse">
                                    <i class="fa-solid fa-phone text-white"></i>
                                </div>
                                <div>
                                    <div class="text-white text-xs font-bold" contenteditable="true">ÈÄöË©±‰∏≠</div>
                                    <div class="text-white/80 text-[10px]" contenteditable="true">${duration}</div>
                                </div>
                             </div>
                        </div>`;
                } 
                else {
                    let iconClass = ''; let title = '';
                    if (status === 'voice') {
                        iconClass = 'fa-solid fa-phone'; title = 'Èü≥Â£∞ÈÄöË©±';
                    } else if (status === 'cancel') {
                        iconClass = 'fa-solid fa-phone-slash'; title = '„Ç≠„É£„É≥„Çª„É´';
                    } else if (status === 'noanswer') {
                        iconClass = 'fa-solid fa-phone-slash'; title = 'ÂøúÁ≠î„Å™„Åó';
                    }
                    const sideClass = isMe ? 'right' : 'left';
                    contentHtml = `
                        <div class="call-history-bubble ${sideClass}">
                            <div class="call-icon-circle">
                                <i class="${iconClass}"></i>
                            </div>
                            <div class="flex flex-col">
                                <div class="text-sm font-bold" contenteditable="true">${title}</div>
                                <div class="text-[10px] opacity-70" contenteditable="true">${duration}</div>
                            </div>
                        </div>
                    `;
                }
            }

            const msgRow = document.createElement('div');
            msgRow.className = isMe ? "flex justify-end items-end gap-1 mb-1 group relative z-10" : "flex justify-start items-end gap-2 mb-1 group relative z-10";

            if (isMe) {
                 if(state.mode === 'call' && document.getElementById('call-status').value === 'active') {
                     msgRow.innerHTML = `${contentHtml}`;
                } else {
                    msgRow.innerHTML = `
                        <div class="flex flex-col items-end min-w-[30px] text-right pb-1">
                            <span class="meta-text text-[9px] text-white mb-[1px] cursor-pointer" contenteditable="true">Êó¢Ë™≠</span>
                            <span class="meta-text text-[9px] text-white/80 cursor-pointer" contenteditable="true">${timeStr}</span>
                        </div>
                        <div class="bubble-wrapper">${contentHtml}</div>
                    `;
                }
            } else {
                 if(state.mode === 'call' && document.getElementById('call-status').value === 'active') {
                     msgRow.innerHTML = `${contentHtml}`;
                } else {
                    msgRow.innerHTML = `
                        <img src="${char.icon}" onerror="this.src='https://placehold.co/100x100/gray/white?text=${char.name.charAt(0)}'" class="w-11 h-11 rounded-full mb-auto border border-gray-300 bg-white object-cover">
                        <div>
                            <div class="flex items-end gap-1 bubble-wrapper">
                                ${contentHtml}
                                <div class="flex flex-col justify-end min-w-[30px] ml-1 pb-1">
                                    <span class="meta-text text-[9px] text-white/80 cursor-pointer" contenteditable="true">${timeStr}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            container.appendChild(msgRow);
            container.scrollTop = container.scrollHeight;
        }

        function undoLast() {
            const container = document.getElementById('capture-area');
            const children = Array.from(container.children);
            const lastMsg = children.reverse().find(el => el.id !== 'bg-overlay-layer');
            if (lastMsg) container.removeChild(lastMsg);
        }

        // --- BACKGROUND ---
        document.getElementById('bg-upload').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('capture-area').style.backgroundImage = `url(${e.target.result})`;
                }
                reader.readAsDataURL(e.target.files[0]);
            }
        });
        document.getElementById('bg-opacity').addEventListener('input', function(e) {
            document.getElementById('bg-overlay-layer').style.backgroundColor = `rgba(0,0,0,${e.target.value})`;
        });
        function resetBg() {
            document.getElementById('capture-area').style.backgroundImage = 'none';
        }

        // --- JSON SAVE & LOAD ---
        function saveProjectData() {
            const captureArea = document.getElementById('capture-area');
            const data = {
                characters: characters,
                htmlContent: captureArea.innerHTML,
                backgroundStyle: captureArea.style.backgroundImage,
                overlayColor: document.getElementById('bg-overlay-layer').style.backgroundColor
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const link = document.createElement('a');
            link.setAttribute("href", dataStr);
            link.setAttribute("download", `sns_project_${Date.now()}.json`);
            document.body.appendChild(link);
            link.click();
            link.remove();
        }

        document.getElementById('json-upload').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if(data.characters) {
                            characters = data.characters;
                            renderCharList();
                        }
                        if(data.htmlContent) {
                            document.getElementById('capture-area').innerHTML = data.htmlContent;
                        }
                        if(data.backgroundStyle) {
                            document.getElementById('capture-area').style.backgroundImage = data.backgroundStyle;
                        }
                        if(data.overlayColor) {
                             document.getElementById('bg-overlay-layer').style.backgroundColor = data.overlayColor;
                        }
                        alert("„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ");
                    } catch(err) {
                        alert("Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: „Éï„Ç°„Ç§„É´ÂΩ¢Âºè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                    }
                }
                reader.readAsText(e.target.files[0]);
            }
        });

        // --- CAPTURE LOGIC (Revised) ---

        // „Éë„Éá„Ç£„É≥„Ç∞„Å´„Çà„Çã‰ΩçÁΩÆË£úÊ≠£Èñ¢Êï∞ (ÂâçÂõû„ÅÆv12.1„Éô„Éº„Çπ)
        function adjustTextPosition(clonedDoc) {
             const bubbles = clonedDoc.querySelectorAll('.bubble');
             bubbles.forEach(b => {
                 b.style.alignItems = 'flex-start';
                 b.style.paddingTop = '1px';
                 b.style.paddingBottom = '15px';
                 b.style.lineHeight = '1.2';
                 b.style.transform = 'none';
             });

             const dateLabels = clonedDoc.querySelectorAll('.date-label');
             dateLabels.forEach(l => {
                 l.style.display = 'inline-flex';
                 l.style.alignItems = 'flex-start';
                 l.style.paddingTop = '0px';
                 l.style.paddingBottom = '4px';
                 l.style.transform = 'none';
             });
        }

        function downloadPhoneView() {
            const target = document.querySelector('.phone-frame');
            html2canvas(target, { 
                scale: 3, 
                backgroundColor: null, 
                useCORS: true, 
                allowTaint: false,
                scrollX: 0, 
                scrollY: 0,
                imageTimeout: 15000,
                onclone: (clonedDoc) => {
                    adjustTextPosition(clonedDoc);
                    // „Çπ„Éû„Éõ„ÅÆÂΩ¢Áä∂„ÇíÁ∂≠ÊåÅ„Åô„Çã„Åü„ÇÅ„ÄÅ„Éï„É¨„Éº„É†ÂâäÈô§Âá¶ÁêÜ„ÅØË°å„Çè„Å™„ÅÑ
                }

            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `SNS_PHONE_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => alert("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ"));
        }

        function downloadScreenShot() {
            const target = document.querySelector('.phone-frame');
            
            html2canvas(target, { 
                scale: 3, 
                backgroundColor: null, 
                useCORS: true, 
                allowTaint: false,
                scrollX: 0, 
                scrollY: 0,
                imageTimeout: 15000,
                onclone: (clonedDoc) => {
                    adjustTextPosition(clonedDoc);

                    // ÁîªÈù¢„ÅÆ„Åø‰øùÂ≠ò„ÅÆÂ†¥Âêà„ÅØ„Éï„É¨„Éº„É†„ÇíÂâäÈô§
                    const clonedFrame = clonedDoc.querySelector('.phone-frame');
                    clonedFrame.style.border = 'none';
                    clonedFrame.style.borderRadius = '0';
                    clonedFrame.style.boxShadow = 'none';
                    
                    const notch = clonedDoc.querySelector('.notch');
                    if(notch) notch.style.display = 'none';
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `SNS_SCREEN_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => alert("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ"));
        }

        function downloadFullChat() {
            const target = document.getElementById('capture-area');
            html2canvas(target, {
                backgroundColor: null,
                scale: 3, 
                useCORS: true, 
                allowTaint: false,
                scrollX: 0, 
                scrollY: 0,
                height: target.scrollHeight, 
                windowHeight: target.scrollHeight, 
                imageTimeout: 15000,
                onclone: (clonedDoc) => {
                    const clonedNode = clonedDoc.getElementById('capture-area');
                    if (clonedNode) {
                        clonedNode.style.height = 'auto';
                        clonedNode.style.overflow = 'visible';
                        clonedNode.style.position = 'static';
                    }
                    adjustTextPosition(clonedDoc);
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `SNS_FULLCHAT_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            }).catch(err => alert("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ"));
        }

        init();
    </script>
</body>
</html>

