<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE LOG BOOK</title>
    
    <!-- „Éï„Ç©„É≥„ÉàË™≠„ÅøËæº„Åø -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <!-- ÂÖ±ÈÄö„Éò„ÉÉ„ÉÄ„Éº -->
    <link href="../edit/header.css" rel="stylesheet">

    <style>
        /* --- ‰∏ñÁïåË¶≥: „Ç¢„É≥„ÉÜ„Ç£„Éº„ÇØ„Å™Êõ∏Êñé --- */
        body { 
            background-color: #1a1512; 
            background-image: radial-gradient(#2a201a 1px, transparent 1px);
            background-size: 30px 30px;
            color: #2b2b2b; 
            font-family: 'Shippori Mincho', serif; 
            margin: 0; padding: 0; 
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- Êú¨‰Ωì: È≠îÂ∞éÊõ∏/Êó•Ë™å (ÂπÖÂ∫É) --- */
        .book-wrapper {
            position: relative;
            margin: 40px auto 80px;
            width: 1400px; /* ÂπÖ„ÇíÊã°Âºµ */
            max-width: 96vw;
        }

        .book-container {
            background: #fdfbf7;
            box-shadow: 
                0 0 0 5px #3e2723, /* Ë°®Á¥ô„Ç≥„Éê */
                0 20px 60px rgba(0,0,0,0.8), 
                inset 0 0 150px rgba(139, 69, 19, 0.1); /* Á¥ô„ÅÆË≥™ÊÑü */
            border-radius: 4px;
            display: flex;
            position: relative;
            overflow: hidden;
            min-height: 850px;
            z-index: 1;
        }

        /* „Çª„É≥„Çø„Éº„ÅÆÂΩ±ÔºàÁ∂¥„ÅòÁõÆÔºâ */
        .book-container::before {
            content: ""; position: absolute; left: 50%; top: 0; bottom: 0; width: 60px; margin-left: -30px;
            background: linear-gradient(to right, rgba(0,0,0,0), rgba(0,0,0,0.15) 40%, rgba(0,0,0,0.25) 50%, rgba(0,0,0,0.15) 60%, rgba(0,0,0,0));
            z-index: 10; pointer-events: none;
        }

        /* --- „Éö„Éº„Ç∏„É¨„Ç§„Ç¢„Ç¶„Éà --- */
        .page { flex: 1; padding: 40px 50px; position: relative; box-sizing: border-box; }
        .page-left { border-right: 1px solid #e0dcd0; background: url('https://www.transparenttextures.com/patterns/aged-paper.png'); }
        .page-right { background: url('https://www.transparenttextures.com/patterns/aged-paper.png'); }

        /* --- ‰ªòÁÆãÔºà„Çø„ÉñÔºâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ --- */
        .tabs-container {
            position: absolute;
            top: 60px; right: -50px; /* Êú¨„ÅÆÂ§ñÂÅ¥„Å´Âá∫„Åô */
            width: 60px;
            z-index: 0;
            display: flex; flex-direction: column; gap: 15px;
        }
        
        .tab {
            width: 70px; height: 50px;
            background: #d7ccc8;
            border-radius: 0 5px 5px 0;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: 0.3s;
            display: flex; align-items: center; justify-content: center;
            writing-mode: vertical-rl;
            font-family: 'Cinzel', serif; font-size: 0.8rem; font-weight: bold; color: #5d4037;
            letter-spacing: 2px;
            position: relative; left: -10px;
        }
        .tab:hover { transform: translateX(5px); }
        .tab.active { 
            background: #8b5a2b; color: #fff; 
            width: 85px; transform: translateX(5px);
            box-shadow: 4px 4px 10px rgba(0,0,0,0.4);
        }
        /* ÂêÑ„Çø„Éñ„ÅÆËâ≤ÂàÜ„Åë */
        .tab[data-target="section-story"] { background: #e0f2f1; color: #004d40; } .tab[data-target="section-story"].active { background: #00695c; color: #fff; }
        .tab[data-target="section-result"] { background: #ffebee; color: #b71c1c; } .tab[data-target="section-result"].active { background: #c62828; color: #fff; }
        .tab[data-target="section-detail"] { background: #e8eaf6; color: #1a237e; } .tab[data-target="section-detail"].active { background: #283593; color: #fff; }
        .tab[data-target="section-memo"] { background: #fff3e0; color: #e65100; } .tab[data-target="section-memo"].active { background: #ef6c00; color: #fff; }


        /* --- Âè≥„Éö„Éº„Ç∏„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑÂàá„ÇäÊõø„Åà --- */
        .tab-content { display: none; animation: fadeIn 0.5s; height: 100%; position: relative; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- „Çø„Ç§„Éù„Ç∞„É©„Éï„Ç£ --- */
        h1.title-input-wrapper { margin: 0 0 30px; position: relative; }
        input.scenario-title {
            width: 100%; text-align: center; font-family: 'Shippori Mincho', serif; font-size: 1.8rem; font-weight: bold;
            border: none; background: transparent; padding: 10px 0; 
            border-bottom: 3px double #5d4037; color: #3e2723;
        }
        input.scenario-title:placeholder-shown { font-style: italic; opacity: 0.5; }
        input.scenario-title:focus { outline: none; border-color: #d4b346; }

        h2 {
            font-family: 'Cinzel', serif; font-size: 1.1rem; color: #5d4037; 
            border-bottom: 1px solid #bcaaa4; margin: 20px 0 15px; padding-bottom: 5px;
        }
        
        /* --- „Éï„Ç©„Éº„É† --- */
        .form-row { margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; color: #795548; font-family: 'Cinzel', serif; font-weight: bold; margin-bottom: 4px; }
        
        input[type="text"], input[type="date"], input[type="number"], input[type="url"], select {
            width: 100%; background: rgba(0,0,0,0.03); border: none; border-bottom: 1px dashed #8d6e63;
            padding: 8px 5px; font-family: 'Shippori Mincho', serif; font-size: 1rem; color: #333; transition: 0.3s;
            box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus { outline: none; background: rgba(139, 90, 43, 0.1); border-bottom-style: solid; }
        
        textarea {
            width: 100%; background: #fcfcfc; border: 1px solid #d7ccc8; border-radius: 4px;
            padding: 10px; font-family: 'Shippori Mincho', serif; font-size: 0.95rem; line-height: 1.8;
            resize: vertical; min-height: 100px; box-sizing: border-box;
            background-image: linear-gradient(transparent 95%, #eee 95%); background-size: 100% 1.8em;
        }

        /* --- „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏ÊäûÔºà2‰∫∫ÂØæÂøúÔºâ --- */
        .char-select-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;
            padding: 15px; border: 2px solid #d7ccc8; border-radius: 4px; background: rgba(255,255,255,0.4);
            min-height: 100px;
        }
        .char-portrait {
            display: flex; flex-direction: column; align-items: center; cursor: pointer; opacity: 0.5; transition: 0.3s; position: relative;
        }
        .char-portrait:hover { opacity: 0.8; transform: translateY(-3px); }
        
        /* ÈÅ∏ÊäûÁä∂ÊÖã */
        .char-portrait.selected { opacity: 1; transform: scale(1.05); }
        .char-portrait img {
            width: 60px; height: 60px; border-radius: 50%; object-fit: cover; 
            border: 3px solid #bcaaa4; background: #eee; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            transition: 0.3s;
        }
        .char-portrait.selected img { border-color: #8b5a2b; box-shadow: 0 0 0 3px #8b5a2b; }
        .char-portrait span { font-size: 0.7rem; margin-top: 5px; font-weight: bold; text-align: center; color: #5d4037; line-height: 1.2; }
        
        /* ÂΩπÂâ≤„Éê„ÉÉ„Ç∏ (PC/KPC) */
        .role-badge {
            position: absolute; top: -5px; right: -5px; 
            background: #d32f2f; color: #fff; font-size: 0.6rem; padding: 2px 6px; border-radius: 10px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3); font-family: 'Cinzel', serif;
            display: none;
        }
        .char-portrait.selected .role-badge { display: block; }
        .char-portrait.role-pc .role-badge { background: #1976d2; content: "PC"; } /* Èùí */
        .char-portrait.role-kpc .role-badge { background: #d32f2f; content: "KPC"; } /* Ëµ§ */


        /* --- „Çπ„Çø„É≥„ÉóÊºîÂá∫ --- */
        .stamp-box {
            position: absolute; bottom: 20px; right: 20px; 
            font-family: 'Cinzel', serif; font-weight: bold; font-size: 3rem; 
            border: 4px solid; padding: 5px 30px; border-radius: 8px;
            opacity: 0.2; transform: rotate(-10deg); pointer-events: none;
            transition: 0.5s;
        }
        .stamp-cleared { color: #2e7d32; border-color: #2e7d32; opacity: 0.8; }
        .stamp-lost { color: #b71c1c; border-color: #b71c1c; opacity: 0.8; }

        /* --- ÁîªÂÉè„Éó„É¨„Éì„É•„Éº --- */
        .img-polaroid {
            background: #fff; padding: 8px 8px 25px 8px; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            transform: rotate(-1deg); text-align: center; transition: 0.3s; cursor: pointer;
            border: 1px solid #eee;
        }
        .img-polaroid:hover { transform: scale(1.02) rotate(0deg); z-index: 10; }
        .img-frame { width: 100%; height: 140px; background: #eee; overflow: hidden; display:flex; align-items:center; justify-content:center; }
        .img-frame img { width: 100%; height: 100%; object-fit: cover; }

        /* --- ‰øùÂ≠ò„Éú„Çø„É≥ --- */
        .btn-seal {
            position: absolute; bottom: 40px; right: 40px;
            width: 120px; height: 120px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #a1887f, #5d4037);
            color: #fff; font-family: 'Cinzel', serif; font-size: 1rem;
            border: 4px double #d7ccc8; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            cursor: pointer; transition: 0.3s; z-index: 20;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-seal:hover { transform: scale(1.1); background: radial-gradient(circle at 30% 30%, #8d6e63, #3e2723); }
        .btn-seal span { font-size: 1.5rem; display: block; }

        /* „Ç∞„É™„ÉÉ„Éâ */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
    <script type="module">import { initHeader } from "../edit/header.js"; initHeader();</script>

    <div class="book-wrapper">
        <!-- ‰ªòÁÆã„Çø„Éñ -->
        <div class="tabs-container">
            <div class="tab active" onclick="switchTab('section-story', this)">STORY</div>
            <div class="tab" onclick="switchTab('section-result', this)">RESULT</div>
            <div class="tab" onclick="switchTab('section-detail', this)">DETAIL</div>
            <div class="tab" onclick="switchTab('section-memo', this)">MEMO</div>
        </div>

        <div class="book-container">
            <!-- ‚ñ† Â∑¶„Éö„Éº„Ç∏ÔºöÂü∫Êú¨ÊÉÖÂ†±ÔºÜÂèÇÂä†ËÄÖ -->
            <div class="page page-left">
                <h1 class="title-input-wrapper">
                    <input type="text" id="inpTitle" class="scenario-title" placeholder="SCENARIO TITLE">
                </h1>

                <!-- „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû (2‰∫∫ÂØæÂøú) -->
                <h2>Protagonists <span style="font-size:0.7rem; color:#888;">(Click to Select PC & KPC)</span></h2>
                <div id="charSelectArea" class="char-select-grid">
                    <div style="grid-column:1/-1; text-align:center; padding:20px;">Loading Characters...</div>
                </div>
                <div style="text-align:right; font-size:0.75rem; color:#8b5a2b; margin-top:5px;">
                    ‚ÄªÈÅ∏ÊäûÈ†Ü„Å´ <span style="background:#1976d2; color:#fff; padding:0 4px; border-radius:4px;">PC</span> <span style="background:#d32f2f; color:#fff; padding:0 4px; border-radius:4px;">KPC</span> „Å®„Å™„Çä„Åæ„Åô
                </div>

                <!-- Âü∫Êú¨„É≠„Ç∞ -->
                <h2>Mission Log</h2>
                <div class="grid-2">
                    <div class="form-row"><label>DATE</label><input type="date" id="inpDate"></div>
                    <div class="form-row"><label>SYSTEM</label>
                        <select id="inpSystem">
                            <option value="CoC6">Call of Cthulhu (6th)</option>
                            <option value="CoC7">Call of Cthulhu (7th)</option>
                            <option value="Emoklore">„Ç®„É¢„ÇØ„É≠„Ç¢TRPG</option>
                            <option value="Other">Other System</option>
                        </select>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-row"><label>GM / KEEPER</label><input type="text" id="inpGM"></div>
                    <div class="form-row"><label>PLAYERS</label><input type="number" id="inpPlCount" value="1"></div>
                </div>
                <div class="form-row">
                    <label>ATTRIBUTES (ÊôÇÈñì/ÂΩ¢Âºè/ËàûÂè∞„Å™„Å©)</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                        <input type="text" id="inpDuration" placeholder="Time">
                        <select id="inpFormat"><option value="Voice">Voice</option><option value="Text">Text</option></select>
                        <input type="text" id="inpStage" placeholder="Stage">
                    </div>
                </div>

                <!-- ÁîªÂÉè -->
                <h2>Imagery</h2>
                <div class="grid-2">
                    <div>
                        <div class="img-polaroid" id="dropTrailer">
                            <div class="img-frame"><img id="previewTrailer" src=""></div>
                            <div style="font-size:0.7rem; color:#888; margin-top:5px;">TRAILER</div>
                        </div>
                        <input type="text" id="inpImgTrailer" placeholder="URL..." style="font-size:0.7rem; margin-top:5px; width:100%;">
                    </div>
                    <div>
                        <div class="img-polaroid" id="dropRoom">
                            <div class="img-frame"><img id="previewRoom" src=""></div>
                            <div style="font-size:0.7rem; color:#888; margin-top:5px;">MEMORY</div>
                        </div>
                        <input type="text" id="inpImgRoom" placeholder="URL..." style="font-size:0.7rem; margin-top:5px; width:100%;">
                    </div>
                </div>
            </div>

            <!-- ‚ñ† Âè≥„Éö„Éº„Ç∏Ôºö„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            <div class="page page-right">
                
                <!-- 1. STORY (Ê¶ÇË¶Å) -->
                <div id="section-story" class="tab-content active">
                    <h2>Scenario Overview</h2>
                    <div class="form-row"><label>TYPE / HO</label><input type="text" id="inpType" placeholder="ÁßòÂåøHO / „Ç∑„ÉÜ„Ç£ / R18G Á≠â"></div>
                    <div class="form-row"><label>URL (Distribution)</label><input type="url" id="inpUrlShop"></div>
                    <div class="form-row">
                        <label>INTRODUCTION / SYNOPSIS</label>
                        <textarea id="inpOverview" style="height:250px;" placeholder="„Ç∑„Éä„É™„Ç™„ÅÆÊ¶ÇË¶Å„ÄÅ„ÅÇ„Çâ„Åô„Åò„ÄÅÂ∞éÂÖ•„Å™„Å©..."></textarea>
                    </div>
                    <div class="form-row">
                        <label>WARNINGS / NOTES</label>
                        <textarea id="inpWarnings" style="height:100px;" placeholder="Ê≥®ÊÑè‰∫ãÈ†Ö„ÄÅÂú∞Èõ∑„ÉÅ„Çß„ÉÉ„ÇØ..."></textarea>
                    </div>
                </div>

                <!-- 2. RESULT (ÁµêÊûú) -->
                <div id="section-result" class="tab-content">
                    <h2>Mission Result</h2>
                    <div style="text-align:center; padding:30px; border:2px solid #d7ccc8; margin-bottom:20px;">
                        <label>FINAL STATUS</label>
                        <select id="inpResult" onchange="updateStamp()" style="font-size:1.5rem; text-align:center; padding:10px; border-bottom:2px solid #8b5a2b; background:transparent;">
                            <option value="Cleared">ÁîüÈÇÑ (CLEARED)</option>
                            <option value="Lost">„É≠„Çπ„Éà (LOST)</option>
                            <option value="Retired">„É™„Çø„Ç§„Ç¢ (RETIRED)</option>
                            <option value="Unknown">‰∏çÊòé (UNKNOWN)</option>
                        </select>
                        <div style="margin-top:15px;">
                            <input type="text" id="inpEndName" placeholder="Ending Name (e.g. End A)" style="text-align:center;">
                        </div>
                    </div>

                    <div class="form-row">
                        <label>CHARACTER STATUS CHANGE</label>
                        <select id="inpCharStatus">
                            <option value="Continue">Á∂ôÁ∂ö (Status Quo)</option>
                            <option value="New">Êñ∞Ë¶è‰ΩúÊàê (New Character)</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label>LOST DETAIL / AFTER EFFECT</label>
                        <textarea id="inpLostDetail" style="height:120px;" placeholder="„É≠„Çπ„ÉàÁêÜÁî±„ÄÅÂæåÈÅ∫Áóá„ÄÅ‰∏çÂÆö„ÅÆÁãÇÊ∞ó„ÅÆÂÜÖÂÆπ..."></textarea>
                    </div>

                    <!-- „Çπ„Çø„É≥„ÉóË°®Á§∫„Ç®„É™„Ç¢ -->
                    <div id="stampDisplay" class="stamp-box">CLEARED</div>
                </div>

                <!-- 3. DETAIL (Ë©≥Á¥∞) -->
                <div id="section-detail" class="tab-content">
                    <h2>Rewards & Growth</h2>
                    <div class="grid-2">
                        <div class="form-row"><label>SAN REWARD</label><input type="text" id="inpSanReward" placeholder="+10 (50‚Üí60)"></div>
                        <div class="form-row"><label>MONEY / ASSETS</label><input type="text" id="inpItemReward"></div>
                    </div>
                    <div class="form-row">
                        <label>GROWTH SKILLS</label>
                        <textarea id="inpGrowth" placeholder="ÁõÆÊòü+5, Âõ≥Êõ∏È§®+3..."></textarea>
                    </div>
                    
                    <h2>Encounters</h2>
                    <div class="form-row">
                        <label>MYTHOS ENTITIES</label>
                        <textarea id="inpEntities" style="height:80px;"></textarea>
                    </div>
                    <div class="form-row">
                        <label>SPELLS / ARTIFACTS</label>
                        <textarea id="inpSpells" style="height:80px;"></textarea>
                    </div>
                </div>

                <!-- 4. MEMO („É°„É¢) -->
                <div id="section-memo" class="tab-content">
                    <h2>Personal Notes</h2>
                    <div class="form-row">
                        <label>PUBLIC COMMENT (Ë°®„ÅÆÊÑüÊÉ≥)</label>
                        <textarea id="inpPublicMemo" style="height:150px;" placeholder="SNSÁ≠â„ÅßÂÖ¨Èñã„Åß„Åç„ÇãÊÑüÊÉ≥..."></textarea>
                    </div>
                    <div class="form-row">
                        <label>SECRET NOTES („Éç„Çø„Éê„É¨„ÉªÁßòÂåø)</label>
                        <textarea id="inpSecretMemo" style="height:250px; background-color:rgba(0,0,0,0.05);" placeholder="GM„ÉªPLÈñì„ÅÆ„Åø„ÅÆÁßòÂØÜ„ÄÅ„Éç„Çø„Éê„É¨„ÇíÂê´„ÇÄÊÑüÊÉ≥..."></textarea>
                    </div>
                </div>

                <!-- ‰øùÂ≠ò„Éú„Çø„É≥ (Â∏∏„Å´Âè≥‰∏ã„Å´Ë°®Á§∫) -->
                <button id="btnSave" class="btn-seal"><span>üíæ</span>SEAL</button>
                
                <div class="sync-box" style="position:absolute; bottom:10px; right:180px; font-size:0.75rem; text-align:right;">
                    <label style="cursor:pointer; color:#5d4037;">
                        <input type="checkbox" id="chkSync" checked> „Ç≠„É£„É©„ÇØ„Çø„Éº„Ç∑„Éº„Éà„Å∏ËøΩË®òÈÄ£Êê∫
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { loadFromCloud, saveToCloud, monitorAuth, saveScenario } 
            from "../character/firestore.js";
        import { createScenarioRecord, syncScenarioToCharacter } 
            from "../character/data/scenario.js";
        import { resolveCharacterImage } 
            from "../character/data/schema.js";

        const getEl = (id) => document.getElementById(id);
        let allChars = {};
        
        // Ë§áÊï∞ÈÅ∏ÊäûÁî®ÈÖçÂàó
        let selectedMemberIds = []; // [id1, id2, ...]

        let currentUid = null;

        // „Çø„ÉñÂàá„ÇäÊõø„ÅàÈñ¢Êï∞ („Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å∏)
        window.switchTab = (targetId, tabEl) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            getEl(targetId).classList.add('active');
            tabEl.classList.add('active');
        };

        // „Çπ„Çø„É≥„ÉóÊõ¥Êñ∞
        window.updateStamp = () => {
            const val = getEl('inpResult').value;
            const stamp = getEl('stampDisplay');
            stamp.className = 'stamp-box'; // reset
            
            if(val === 'Cleared') {
                stamp.textContent = "CLEARED";
                stamp.classList.add('stamp-cleared');
            } else if(val === 'Lost') {
                stamp.textContent = "LOST";
                stamp.classList.add('stamp-lost');
            } else if(val === 'Retired') {
                stamp.textContent = "RETIRED";
                stamp.classList.add('stamp-lost'); // Ëâ≤„ÅØËµ§Á≥ªÁµ±
                stamp.style.opacity = '0.5';
            } else {
                stamp.style.opacity = '0';
            }
        };

        // „Ç≠„É£„É©ÈÅ∏Êäû„É≠„Ç∏„ÉÉ„ÇØÔºàË§áÊï∞ÈÅ∏ÊäûÔºâ
        const toggleCharSelection = (div, charId) => {
            const idx = selectedMemberIds.indexOf(charId);
            
            if (idx === -1) {
                // ËøΩÂä† (ÊúÄÂ§ß2‰∫∫„Åæ„Åß„Å™„Å©„ÅÆÂà∂Èôê„ÇíÂÖ•„Çå„Çã„Å™„Çâ„Åì„Åì)
                selectedMemberIds.push(charId);
                div.classList.add('selected');
            } else {
                // Ëß£Èô§
                selectedMemberIds.splice(idx, 1);
                div.classList.remove('selected');
            }
            updateRoleBadges();
        };

        // „Éê„ÉÉ„Ç∏Êõ¥Êñ∞ (1‰∫∫ÁõÆ=PC, 2‰∫∫ÁõÆ=KPC „Å®‰ªÆÂÆö„Åó„Å¶Ë°®Á§∫)
        const updateRoleBadges = () => {
            document.querySelectorAll('.char-portrait').forEach(div => {
                const uid = div.dataset.uid;
                const index = selectedMemberIds.indexOf(uid);
                
                div.classList.remove('role-pc', 'role-kpc');
                const badge = div.querySelector('.role-badge');
                
                if (index === 0) {
                    div.classList.add('role-pc');
                    badge.textContent = "PC";
                } else if (index > 0) {
                    div.classList.add('role-kpc');
                    badge.textContent = "KPC"; // 2‰∫∫ÁõÆ‰ª•Èôç„ÅØKPCÊâ±„ÅÑ
                }
            });
        };

        // ÂàùÊúüÂåñ
        monitorAuth(async (user) => {
            const area = getEl('charSelectArea');
            if(!user) {
                area.innerHTML = '<div style="grid-column:1/-1; text-align:center;">Login Required</div>';
                return;
            }
            currentUid = user.uid;

            try {
                console.log("Loading Chars...");
                const storeData = await loadFromCloud();
                
                // „Éá„Éº„Çø„ÅåÁ©∫„ÄÅ„Åæ„Åü„ÅØÂèñÂæóÂ§±ÊïóÊôÇ„ÅÆ„Éè„É≥„Éâ„É™„É≥„Ç∞
                if (!storeData || Object.keys(storeData).length === 0) {
                    area.innerHTML = '<div style="grid-column:1/-1; text-align:center;">No Characters Found.</div>';
                    return;
                }

                allChars = storeData;
                area.innerHTML = '';

                // „Ç≠„É£„É©„É™„Çπ„ÉàÁîüÊàê
                for(const c of Object.values(allChars)) {
                    const div = document.createElement('div');
                    div.className = 'char-portrait';
                    div.dataset.uid = c.id || c.name; // ID„Å®„Åó„Å¶‰ΩøÁî®

                    let imgUrl = "https://via.placeholder.com/60?text=?";
                    try { imgUrl = await resolveCharacterImage(c.name, c.icon, 'icon'); } catch(e){}

                    div.innerHTML = `
                        <div class="role-badge"></div>
                        <img src="${imgUrl}">
                        <span>${c.name}</span>
                    `;
                    
                    div.onclick = () => toggleCharSelection(div, c.id || c.name);
                    area.appendChild(div);
                }

            } catch(e) {
                console.error(e);
                area.innerHTML = `<div style="grid-column:1/-1; color:red;">Load Error: ${e.message}</div>`;
            }
        });

        // ÁîªÂÉèD&D
        const setupImg = (boxId, inpId, imgId) => {
            const box = getEl(boxId);
            box.addEventListener('dragover', e=>{e.preventDefault();});
            box.addEventListener('drop', e=>{
                e.preventDefault();
                const file = e.dataTransfer.files[0];
                if(file){
                    const r = new FileReader();
                    r.onload=v=>{ getEl(inpId).value=v.target.result; getEl(imgId).src=v.target.result; };
                    r.readAsDataURL(file);
                }
            });
            getEl(inpId).addEventListener('change', e => getEl(imgId).src = e.target.value);
        };
        setupImg('dropTrailer', 'inpImgTrailer', 'previewTrailer');
        setupImg('dropRoom', 'inpImgRoom', 'previewRoom');

        // ‰øùÂ≠ò„Éú„Çø„É≥
        getEl('btnSave').addEventListener('click', async () => {
            const title = getEl('inpTitle').value;
            if(!title) { alert('„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            if(selectedMemberIds.length === 0 && !confirm('„Ç≠„É£„É©„ÇØ„Çø„ÉºÊú™ÈÅ∏Êäû„Åß„Åô„ÄÇË®òÈå≤„Åó„Åæ„Åô„ÅãÔºü')) return;

            const btn = getEl('btnSave');
            btn.innerHTML = "<span>‚è≥</span>Saving...";

            // „Éá„Éº„ÇøÂèéÈõÜ
            const rawInput = {
                title: title,
                system: getEl('inpSystem').value,
                date: getEl('inpDate').value,
                duration: getEl('inpDuration').value,
                stage: getEl('inpStage').value,
                type: getEl('inpType').value,
                gm: getEl('inpGM').value,
                players: getEl('inpPlCount').value,
                format: getEl('inpFormat').value,
                
                members: selectedMemberIds, // ÈÖçÂàó„Åß‰øùÂ≠ò
                
                charStatus: getEl('inpCharStatus').value,
                result: getEl('inpResult').value,
                lostDetail: getEl('inpLostDetail').value,
                images: { trailer: getEl('inpImgTrailer').value, room: getEl('inpImgRoom').value },
                urls: { shop: getEl('inpUrlShop').value, room: getEl('inpUrlRoom').value },
                details: { overview: getEl('inpOverview').value }, 
                endName: getEl('inpEndName').value,
                rewards: { san: getEl('inpSanReward').value, items: getEl('inpItemReward').value },
                entities: getEl('inpEntities').value, 
                spells: getEl('inpSpells').value, 
                growth: getEl('inpGrowth').value,
                memos: { public: getEl('inpPublicMemo').value, secret: getEl('inpSecretMemo').value }
            };

            try {
                // 1. „Ç∑„Éä„É™„Ç™‰øùÂ≠ò
                const scenarioData = createScenarioRecord(rawInput, currentUid);
                const newId = await saveScenario(scenarioData);

                // 2. „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÄ£Êê∫ („É´„Éº„ÉóÂá¶ÁêÜ)
                if(selectedMemberIds.length > 0 && getEl('chkSync').checked) {
                    let updatedCount = 0;
                    
                    // ÈÅ∏Êäû„Åï„Çå„ÅüÂÖ®„Ç≠„É£„É©„Å´ÂØæ„Åó„Å¶Êõ¥Êñ∞„Çí„Åã„Åë„Çã
                    for(const mid of selectedMemberIds) {
                        const targetChar = Object.values(allChars).find(c => (c.id === mid) || (c.name === mid));
                        if(targetChar) {
                            const updatedChar = syncScenarioToCharacter(targetChar, scenarioData, newId);
                            // „É≠„Éº„Ç´„É´„Å®„Çµ„Éº„Éê„Éº‰∏°ÊñπÊõ¥Êñ∞
                            allChars[targetChar.name] = updatedChar;
                            await saveToCloud(updatedChar);
                            updatedCount++;
                        }
                    }
                    alert(`Ë®òÈå≤ÂÆå‰∫ÜÔºÅ\n„Ç∑„Éä„É™„Ç™„Å®„ÄÅ${updatedCount}‰∫∫„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„ÉºÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇ`);
                } else {
                    alert('„Ç∑„Éä„É™„Ç™Ë®òÈå≤ÂÆå‰∫ÜÔºÅ');
                }
                btn.innerHTML = "<span>‚úî</span>SEALED";
            } catch(e) {
                alert('Error: ' + e.message);
                btn.innerHTML = "<span>‚úï</span>Failed";
            }
        });

        updateStamp(); // init
    </script>
</body>
</html>