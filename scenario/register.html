<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE LOG</title>
    
    <!-- ファンタジー・アンティーク調のフォント -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&family=Pinyon+Script&display=swap" rel="stylesheet">
    
    <!-- パスの調整（環境に合わせて変更してください） -->
    <link href="../edit/header.css" rel="stylesheet">

    <style>
        /* --- 世界観: 暗い書斎の机 --- */
        body { 
            background-color: #0f0e0d; 
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png'); /* 木目調などのテクスチャがあると尚良し */
            color: #2b2b2b; 
            font-family: 'Shippori Mincho', serif; 
            margin: 0; padding: 0; 
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- 本体: 古い魔導書/航海日誌 --- */
        .book-container {
            width: 1200px; max-width: 96vw;
            background: #fdfbf7;
            margin: 40px auto 80px;
            box-shadow: 
                0 0 0 4px #3e2723, /* 表紙のコバ */
                0 20px 50px rgba(0,0,0,0.8), 
                inset 0 0 120px rgba(139, 69, 19, 0.15); /* 紙の焼け */
            border-radius: 2px;
            display: flex;
            position: relative;
            overflow: hidden;
            min-height: 850px;
        }

        /* センターの綴じ目（影） */
        .book-container::before {
            content: ""; position: absolute; left: 50%; top: 0; bottom: 0; width: 80px; margin-left: -40px;
            background: linear-gradient(to right, rgba(0,0,0,0.05), rgba(0,0,0,0.2) 45%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.2) 55%, rgba(0,0,0,0.05));
            z-index: 10; pointer-events: none;
        }

        .page { flex: 1; padding: 50px 60px; position: relative; box-sizing: border-box; }
        .page-left { border-right: 1px solid #dcd6cc; }

        @media (max-width: 950px) {
            .book-container { flex-direction: column; width: 100%; box-shadow: none; margin: 0; }
            .book-container::before { display: none; }
            .page-left { border-right: none; border-bottom: 2px dashed #ccc; }
        }

        /* --- タイポグラフィ --- */
        h1.scenario-title-label {
            font-family: 'Cinzel', serif; font-size: 0.9rem; color: #8b5a2b; letter-spacing: 2px; text-align: center; margin: 0;
            border-bottom: 1px solid #8b5a2b; display: inline-block; width: 100%;
        }
        input.scenario-title-input {
            width: 100%; text-align: center; font-family: 'Shippori Mincho', serif; font-size: 2rem; font-weight: bold;
            border: none; background: transparent; padding: 10px 0; margin-bottom: 30px;
            border-bottom: 3px double #3e2723; color: #1a1a1a;
        }
        input.scenario-title-input::placeholder { color: #ccc; font-style: italic; }
        input.scenario-title-input:focus { outline: none; border-color: #d4b346; }

        h2 {
            font-family: 'Cinzel', serif; font-size: 1.2rem; color: #5d4037; border-bottom: 1px solid #bcaaa4;
            margin-top: 30px; margin-bottom: 15px; padding-bottom: 5px; display: flex; align-items: center; gap: 10px;
        }
        h2::before { content: "◆"; color: #8b5a2b; font-size: 0.8rem; }

        /* --- 共通入力スタイル --- */
        .form-row { margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; color: #795548; font-family: 'Cinzel', sans-serif; font-weight: bold; margin-bottom: 4px; }
        
        input[type="text"], input[type="date"], input[type="number"], input[type="url"], select {
            width: 100%; background: rgba(0,0,0,0.02); border: none; border-bottom: 1px dashed #8d6e63;
            padding: 6px 5px; font-family: 'Shippori Mincho', serif; font-size: 1rem; color: #333; transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { outline: none; background: rgba(139, 90, 43, 0.08); border-bottom-style: solid; }
        
        textarea {
            width: 100%; background: url('https://www.transparenttextures.com/patterns/lined-paper.png'); /* 罫線風背景など */
            background-color: rgba(255,255,255,0.5);
            border: 1px solid #d7ccc8; padding: 10px; font-family: 'Shippori Mincho', serif; font-size: 0.95rem; line-height: 1.8;
            resize: vertical; min-height: 80px; border-radius: 2px;
        }

        /* --- キャラクター選択（肖像画風） --- */
        .char-select-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px;
            padding: 15px; border: 2px solid #d7ccc8; border-radius: 4px; background: rgba(255,255,255,0.3);
            min-height: 110px;
        }
        .char-portrait {
            display: flex; flex-direction: column; align-items: center; cursor: pointer; opacity: 0.6; transition: 0.3s; position: relative;
        }
        .char-portrait:hover { opacity: 1; transform: translateY(-3px); }
        .char-portrait.selected { opacity: 1; transform: scale(1.05); }
        .char-portrait.selected img { border-color: #d4b346; box-shadow: 0 0 0 2px #d4b346; }
        .char-portrait img {
            width: 70px; height: 70px; border-radius: 50%; object-fit: cover; 
            border: 3px solid #bcaaa4; background: #eee; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        .char-portrait span { font-size: 0.75rem; margin-top: 5px; font-weight: bold; text-align: center; color: #5d4037; }

        /* --- 結果スタンプ演出 --- */
        .result-section { position: relative; padding: 20px; border: 3px double #8d6e63; margin-top: 20px; text-align: center; }
        .stamp-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg);
            font-family: 'Cinzel', serif; font-weight: bold; font-size: 4rem; 
            border: 5px solid; padding: 10px 40px; border-radius: 10px;
            opacity: 0; pointer-events: none; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 5; mix-blend-mode: multiply;
        }
        .stamp-cleared { color: #2e7d32; border-color: #2e7d32; } /* 緑 */
        .stamp-lost { color: #b71c1c; border-color: #b71c1c; } /* 赤 */
        .stamp-retired { color: #555; border-color: #555; }
        
        .stamp-visible { opacity: 0.7; transform: translate(-50%, -50%) rotate(-15deg) scale(1); }

        /* --- 画像エリア --- */
        .img-preview-box {
            width: 100%; height: 160px; background: #f0f0f0; border: 1px solid #ccc;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            margin-bottom: 5px; position: relative;
        }
        .img-preview-box::after { content:"NO IMAGE"; color:#ccc; font-size:0.8rem; position:absolute; z-index:0; }
        .img-preview-box img { width: 100%; height: 100%; object-fit: cover; z-index:1; position:relative; }

        /* --- 保存ボタン（蝋封） --- */
        .btn-seal {
            background: radial-gradient(circle at 30% 30%, #d32f2f, #8b0000);
            color: #fff; font-family: 'Cinzel', serif; font-size: 1.2rem;
            border: none; width: 160px; height: 160px; border-radius: 50%;
            margin: 40px auto 0; display: block; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4), inset 0 0 20px rgba(0,0,0,0.2);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            transition: 0.3s; position: relative;
        }
        .btn-seal::before {
            content: ""; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 2px dashed rgba(255,255,255,0.3); border-radius: 50%;
        }
        .btn-seal:hover { transform: scale(1.05); box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
        .btn-seal:active { transform: scale(0.95); }

        .sync-box { font-size: 0.75rem; color: #666; text-align: center; margin-top: 15px; }

        /* グリッド */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
    </style>
</head>
<body>
    <script type="module">import { initHeader } from "../edit/header.js"; initHeader();</script>

    <div class="book-container">
        <!-- ■ 左ページ：冒険の始まり（基本情報） -->
        <div class="page page-left">
            <h1 class="scenario-title-label">SCENARIO TITLE</h1>
            <input type="text" id="inpTitle" class="scenario-title-input" placeholder="シナリオタイトルを入力...">

            <!-- キャラクター選択 -->
            <h2>The Protagonists <span style="font-size:0.7rem; color:#888; font-weight:normal;">(参加PCを選択)</span></h2>
            <div id="charSelectArea" class="char-select-grid">
                <div style="grid-column:1/-1; text-align:center; color:#888; padding:10px;">Loading Characters...</div>
            </div>
            <div class="form-row" style="text-align:right; margin-top:5px;">
                <label style="display:inline-block; margin-right:10px;">Status:</label>
                <select id="inpCharStatus" style="width:auto; display:inline-block;">
                    <option value="Continue">継続探索者</option>
                    <option value="New">新規探索者</option>
                </select>
            </div>

            <!-- 基本通過情報 -->
            <h2>Mission Log <span style="font-size:0.7rem; color:#888; font-weight:normal;">(基本情報)</span></h2>
            <div class="grid-2">
                <div class="form-row"><label>DATE</label><input type="date" id="inpDate"></div>
                <div class="form-row"><label>SYSTEM</label>
                    <select id="inpSystem">
                        <option value="CoC6">Call of Cthulhu (6th)</option>
                        <option value="CoC7">Call of Cthulhu (7th)</option>
                        <option value="Emoklore">エモクロアTRPG</option>
                        <option value="Other">Other System</option>
                    </select>
                </div>
            </div>
            <div class="grid-2">
                <div class="form-row"><label>GM / KEEPER</label><input type="text" id="inpGM"></div>
                <div class="form-row"><label>PLAYERS</label><input type="number" id="inpPlCount" value="1"></div>
            </div>
            <div class="grid-2">
                <div class="form-row"><label>TIME / DURATION</label><input type="text" id="inpDuration" placeholder="12時間 / 夜3日"></div>
                <div class="form-row"><label>STAGE</label><input type="text" id="inpStage" placeholder="現代日本 / クローズド"></div>
            </div>

            <!-- シナリオ情報 -->
            <h2>Scenario Intel <span style="font-size:0.7rem; color:#888; font-weight:normal;">(シナリオ詳細)</span></h2>
            <div class="grid-2">
                <div class="form-row">
                    <label>TRAILER / IMAGE</label>
                    <div class="img-preview-box" id="dropTrailer"><img id="previewTrailer" src=""></div>
                    <input type="text" id="inpImgTrailer" placeholder="URL..." style="font-size:0.7rem;">
                </div>
                <div>
                    <div class="form-row"><label>TYPE / HO</label><input type="text" id="inpType" placeholder="秘匿HO / シティ"></div>
                    <div class="form-row"><label>SHOP / URL</label><input type="url" id="inpUrlShop"></div>
                    <div class="form-row"><label>OVERVIEW (概要)</label><textarea id="inpOverview" style="height:75px;" placeholder="シナリオのあらすじ等..."></textarea></div>
                </div>
            </div>

        </div>

        <!-- ■ 右ページ：結末と報酬（詳細・結果） -->
        <div class="page page-right">
            
            <!-- 結果（スタンプ演出） -->
            <h2>The Verdict <span style="font-size:0.7rem; color:#888; font-weight:normal;">(結末)</span></h2>
            <div class="result-section">
                <!-- スタンプ要素 -->
                <div id="stamp" class="stamp-overlay">CLEARED</div>
                
                <div class="form-row">
                    <label style="text-align:center; font-size:1rem; margin-bottom:10px;">MISSION RESULT</label>
                    <select id="inpResult" style="text-align:center; font-size:1.2rem; font-weight:bold; border:none; background:#f4f0e6; padding:10px;">
                        <option value="Cleared">生還 (CLEARED)</option>
                        <option value="Lost">ロスト (LOST)</option>
                        <option value="Retired">リタイア (RETIRED)</option>
                        <option value="Unknown">不明 (UNKNOWN)</option>
                    </select>
                </div>
                <div class="form-row">
                    <input type="text" id="inpEndName" placeholder="Ending Name (e.g. End A: xxx)" style="text-align:center;">
                </div>
            </div>
            
            <!-- ロスト詳細（条件付き表示でもよいが、常時表示で薄くする） -->
            <div class="form-row" style="margin-top:10px;">
                <label>LOST REASON / AFTER EFFECT</label>
                <input type="text" id="inpLostDetail" placeholder="ロスト理由・後遺症・不定の狂気など...">
            </div>

            <!-- 感想 -->
            <h2>Personal Log <span style="font-size:0.7rem; color:#888; font-weight:normal;">(感想・手記)</span></h2>
            <div class="form-row">
                <label>PUBLIC REPORT (表の顔・公開用)</label>
                <textarea id="inpPublicMemo" style="height:60px;"></textarea>
            </div>
            <div class="form-row">
                <label>PRIVATE NOTES (秘匿・ネタバレ)</label>
                <textarea id="inpSecretMemo" style="height:60px; background-color: rgba(0,0,0,0.05);"></textarea>
            </div>

            <!-- 報酬・詳細 -->
            <h2>Spoils & Encounters <span style="font-size:0.7rem; color:#888; font-weight:normal;">(報酬・詳細)</span></h2>
            <div class="grid-3">
                <div class="form-row"><label>SAN REWARD</label><input type="text" id="inpSanReward" placeholder="+10 (50→60)"></div>
                <div class="form-row" style="grid-column:span 2;"><label>ITEMS / MONEY</label><input type="text" id="inpItemReward"></div>
            </div>
            
            <details>
                <summary>詳細ログを開く (遭遇・魔術・成長)</summary>
                <div style="padding-top:10px;">
                    <div class="form-row"><label>ENCOUNTERED (遭遇)</label><textarea id="inpEntities"></textarea></div>
                    <div class="form-row"><label>SPELLS / ARTIFACTS</label><textarea id="inpSpells"></textarea></div>
                    <div class="form-row"><label>GROWTH SKILLS</label><textarea id="inpGrowth" placeholder="目星+5, 図書館+2..."></textarea></div>
                    
                    <!-- 部屋写真など -->
                    <div class="form-row">
                        <label>ROOM ARCHIVE</label>
                        <div class="img-preview-box" id="dropRoom" style="height:100px;"><img id="previewRoom" src=""></div>
                        <input type="text" id="inpImgRoom" placeholder="Room/Log Image URL..." style="font-size:0.7rem;">
                    </div>
                </div>
            </details>

            <!-- 保存 -->
            <button id="btnSave" class="btn-seal">SEAL<br><span style="font-size:0.8rem">Record Log</span></button>
            
            <div class="sync-box">
                <label style="cursor:pointer;">
                    <input type="checkbox" id="chkSync" checked> 
                    キャラクターシートの経歴・所持品を自動更新する
                </label>
            </div>

        </div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { loadFromCloud, saveToCloud, monitorAuth, saveScenario } 
            from "../character/firestore.js";
        import { createScenarioRecord, syncScenarioToCharacter } 
            from "../character/data/scenario.js";
        import { resolveCharacterImage } 
            from "../character/data/schema.js";

        const getEl = (id) => document.getElementById(id);
        let allChars = {};
        let selectedCharId = null;
        let currentUid = null;

        // --- スタンプ演出 ---
        const updateStamp = () => {
            const val = getEl('inpResult').value;
            const stamp = getEl('stamp');
            stamp.className = 'stamp-overlay stamp-visible'; // base
            
            if(val === 'Cleared') {
                stamp.textContent = "CLEARED";
                stamp.classList.add('stamp-cleared');
            } else if(val === 'Lost') {
                stamp.textContent = "LOST";
                stamp.classList.add('stamp-lost');
            } else if(val === 'Retired') {
                stamp.textContent = "RETIRED";
                stamp.classList.add('stamp-retired');
            } else {
                stamp.classList.remove('stamp-visible');
            }
        };
        getEl('inpResult').addEventListener('change', updateStamp);

        // 画像D&D
        const setupImg = (boxId, inpId, imgId) => {
            const box = getEl(boxId);
            box.addEventListener('dragover', e=>{e.preventDefault(); box.style.opacity='0.7';});
            box.addEventListener('dragleave', e=>{e.preventDefault(); box.style.opacity='1';});
            box.addEventListener('drop', e=>{
                e.preventDefault(); box.style.opacity='1';
                const file = e.dataTransfer.files[0];
                if(file){
                    const r = new FileReader();
                    r.onload=v=>{ getEl(inpId).value=v.target.result; getEl(imgId).src=v.target.result; };
                    r.readAsDataURL(file);
                }
            });
            getEl(inpId).addEventListener('change', e => getEl(imgId).src = e.target.value);
        };
        setupImg('dropTrailer', 'inpImgTrailer', 'previewTrailer');
        setupImg('dropRoom', 'inpImgRoom', 'previewRoom');

        // 初期ロード
        monitorAuth(async (user) => {
            const area = getEl('charSelectArea');
            if(!user) { area.innerHTML = '<div style="grid-column:1/-1;text-align:center;">Login Required</div>'; return; }
            currentUid = user.uid;

            try {
                const storeData = await loadFromCloud();
                allChars = storeData || {};
                area.innerHTML = '';
                
                for(const c of Object.values(allChars)) {
                    const div = document.createElement('div');
                    div.className = 'char-portrait';
                    
                    let imgUrl = "https://via.placeholder.com/70?text=?";
                    try { imgUrl = await resolveCharacterImage(c.name, c.icon, 'icon'); } catch(e){}

                    div.innerHTML = `<img src="${imgUrl}"><span>${c.name}</span>`;
                    div.onclick = () => {
                        document.querySelectorAll('.char-portrait').forEach(el=>el.classList.remove('selected'));
                        div.classList.add('selected');
                        selectedCharId = c.id || c.name;
                    };
                    area.appendChild(div);
                }
            } catch(e) { console.error(e); }
        });

        // 保存処理
        getEl('btnSave').addEventListener('click', async () => {
            const title = getEl('inpTitle').value;
            if(!title) { alert('タイトルを記してください (Title is required)'); return; }
            if(!selectedCharId && !confirm('キャラクターが選択されていません。記録しますか？')) return;

            const btn = getEl('btnSave');
            btn.innerHTML = "Sealing...";
            btn.style.opacity = "0.7";

            // 入力データ収集
            const rawInput = {
                title: title,
                system: getEl('inpSystem').value,
                date: getEl('inpDate').value,
                duration: getEl('inpDuration').value,
                stage: getEl('inpStage').value,
                type: getEl('inpType').value,
                gm: getEl('inpGM').value,
                players: getEl('inpPlCount').value,
                format: getEl('inpFormat').value,
                
                members: selectedCharId ? [selectedCharId] : [],
                charStatus: getEl('inpCharStatus').value,
                result: getEl('inpResult').value,
                lostDetail: getEl('inpLostDetail').value,

                images: { trailer: getEl('inpImgTrailer').value, room: getEl('inpImgRoom').value },
                urls: { shop: getEl('inpUrlShop').value, room: getEl('inpUrlRoom').value },
                
                details: { overview: getEl('inpOverview').value }, // 必要なら story, warnings追加
                
                endName: getEl('inpEndName').value,
                rewards: { san: getEl('inpSanReward').value, items: getEl('inpItemReward').value },
                entities: getEl('inpEntities').value, 
                spells: getEl('inpSpells').value, 
                growth: getEl('inpGrowth').value,
                
                memos: { public: getEl('inpPublicMemo').value, secret: getEl('inpSecretMemo').value }
            };

            try {
                // 1. データ作成
                const scenarioData = createScenarioRecord(rawInput, currentUid);
                // 2. DB保存
                const newId = await saveScenario(scenarioData);

                // 3. キャラ更新
                if(selectedCharId && getEl('chkSync').checked) {
                    const targetChar = Object.values(allChars).find(c => (c.id === selectedCharId) || (c.name === selectedCharId));
                    if(targetChar) {
                        const updatedChar = syncScenarioToCharacter(targetChar, scenarioData, newId);
                        allChars[targetChar.name] = updatedChar;
                        await saveToCloud(updatedChar);
                        alert('記録完了。魔導書（キャラシ）に追記されました。');
                    }
                } else {
                    alert('記録が完了しました。');
                }
                
                btn.innerHTML = "SEALED";
            } catch(e) {
                alert('エラー: ' + e.message);
                btn.innerHTML = "SEAL<br>Failed";
            }
        });

        // 初期スタンプ更新
        updateStamp();
    </script>
</body>
</html>