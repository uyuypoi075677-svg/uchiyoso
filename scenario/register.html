<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REGISTER SCENARIO LOG</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Zen+Kaku+Gothic+New:wght@300;500;700&display=swap" rel="stylesheet">
    <!-- 既存のCSSを流用 -->
    <link href="../detail/style.css" rel="stylesheet">
    <style>
        body { padding: 20px; max-width: 800px; margin: 0 auto; }
        .form-panel { background: rgba(12, 14, 18, 0.95); padding: 30px; border: 1px solid var(--border); box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .form-group { margin-bottom: 20px; }
        label { display: block; color: var(--secondary); font-family: var(--font-head); margin-bottom: 5px; font-size: 0.9rem; }
        input[type="text"], input[type="date"], textarea, select {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid #444; color: #fff; padding: 10px; font-family: var(--font-body);
        }
        input:focus, textarea:focus { border-color: var(--secondary); outline: none; }
        
        /* キャラクター選択エリア */
        .char-select-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;
            max-height: 300px; overflow-y: auto; border: 1px solid #333; padding: 10px;
        }
        .char-checkbox { display: none; }
        .char-label {
            display: block; padding: 10px; background: rgba(255,255,255,0.03); border: 1px solid #444;
            cursor: pointer; text-align: center; font-size: 0.8rem; transition: 0.2s;
        }
        .char-label:hover { background: rgba(255,255,255,0.1); }
        .char-checkbox:checked + .char-label {
            background: var(--secondary); color: #000; border-color: var(--secondary); font-weight: bold;
        }

        .submit-btn {
            background: var(--primary); color: #fff; border: none; padding: 15px; width: 100%;
            font-family: var(--font-head); font-size: 1.2rem; cursor: pointer; margin-top: 20px;
        }
        .submit-btn:hover { box-shadow: 0 0 15px var(--primary); }
        .back-link { display: block; margin-top: 20px; text-align: center; color: #888; text-decoration: none; }
    </style>
</head>
<body>
    <div class="scanlines"></div>

    <h1 style="font-family:'Orbitron'; color:#fff; text-align:center; margin-bottom:20px;">SCENARIO ENTRY</h1>

    <div class="form-panel">
        <div class="form-group">
            <label>SCENARIO TITLE</label>
            <input type="text" id="inpTitle" placeholder="シナリオ名を入力">
        </div>

        <div class="form-group">
            <label>SYSTEM</label>
            <select id="inpSystem">
                <option value="CoC6">Call of Cthulhu (6th)</option>
                <option value="CoC7">Call of Cthulhu (7th)</option>
                <option value="Emoklore">Emoklore</option>
                <option value="Other">Other</option>
            </select>
        </div>

        <div class="form-group">
            <label>PLAY DATE</label>
            <input type="date" id="inpDate">
        </div>

        <div class="form-group">
            <label>GAME MASTER (KP/DL)</label>
            <input type="text" id="inpGM" placeholder="GM名">
        </div>

        <div class="form-group">
            <label>RESULT</label>
            <select id="inpResult">
                <option value="Cleared">End A (Cleared/Alive)</option>
                <option value="Lost">Lost (Dead/Insane)</option>
                <option value="Retired">Retired</option>
                <option value="Unknown">Unknown</option>
            </select>
        </div>

        <div class="form-group">
            <label>PARTICIPATING MEMBERS (SELECT YOUR CHARACTERS)</label>
            <div id="charSelector" class="char-select-grid">
                <div style="color:#888; text-align:center; grid-column:1/-1;">Loading Characters...</div>
            </div>
        </div>

        <div class="form-group">
            <label>MEMO / IMPRESSIONS</label>
            <textarea id="inpMemo" rows="4" placeholder="概要や感想など..."></textarea>
        </div>

        <button id="btnRegister" class="submit-btn">REGISTER LOG</button>
    </div>

    <a href="../index.html" class="back-link">BACK TO TOP</a>

    <script type="module">
        import { monitorAuth, loadFromCloud, saveScenario } from "../character/firestore.js"; 
        // パスは階層に合わせて調整してください (例: ../firestore.js か ../character/firestore.js か)

        const charSelector = document.getElementById('charSelector');
        let currentUserData = null;

        // 1. 認証チェック＆キャラクター一覧取得
        monitorAuth(async (user) => {
            if (!user) {
                alert("ログインが必要です");
                window.location.href = "../index.html";
                return;
            }
            currentUserData = user;

            // キャラクター読み込み
            const data = await loadFromCloud();
            if (!data) {
                charSelector.innerHTML = '<div style="color:#888;">No characters found.</div>';
                return;
            }

            charSelector.innerHTML = '';
            // データ形式に応じて配列化
            const charList = Object.values(data);
            
            charList.forEach(char => {
                // IDがない場合は仮生成（Firestore保存時にIDがついているはず）
                const cid = char.id || char.name; 
                
                const wrapper = document.createElement('div');
                wrapper.innerHTML = `
                    <input type="checkbox" id="chk_${cid}" class="char-checkbox" value="${cid}">
                    <label for="chk_${cid}" class="char-label">
                        <div style="font-weight:bold;">${char.name}</div>
                        <div style="font-size:0.7rem; color:#888;">${char.job || 'Unknown'}</div>
                    </label>
                `;
                charSelector.appendChild(wrapper);
            });
        });

        // 2. 登録処理
        document.getElementById('btnRegister').addEventListener('click', async () => {
            const title = document.getElementById('inpTitle').value;
            if(!title) { alert("シナリオ名を入力してください"); return; }

            // 選択されたキャラIDを取得
            const selectedChars = [];
            document.querySelectorAll('.char-checkbox:checked').forEach(chk => {
                selectedChars.push(chk.value);
            });

            if(selectedChars.length === 0) {
                if(!confirm("キャラクターが選択されていません。登録しますか？")) return;
            }

            const scenarioData = {
                title: title,
                system: document.getElementById('inpSystem').value,
                date: document.getElementById('inpDate').value,
                gm: document.getElementById('inpGM').value,
                result: document.getElementById('inpResult').value,
                memo: document.getElementById('inpMemo').value,
                members: selectedChars // ここで紐付け
            };

            try {
                await saveScenario(scenarioData);
                alert("シナリオログを登録しました！");
                // フォームリセット等の処理
                document.getElementById('inpTitle').value = "";
                document.getElementById('inpMemo').value = "";
            } catch(e) {
                alert("登録エラー: " + e.message);
            }
        });
    </script>
</body>
</html>