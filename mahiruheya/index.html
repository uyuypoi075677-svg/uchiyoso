<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Room: Remastered v4</title>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ui-bg: rgba(255, 255, 255, 0.95);
            --primary: #5D4037;
            --accent: #FF7043;
            --text: #3E2723;
            --font: "Pixelify Sans", sans-serif;
        }

        body {
            margin: 0; padding: 0;
            background-color: #000;
            font-family: var(--font);
            overflow: hidden;
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
        }

        /* „Ç≤„Éº„É†„Çπ„ÉÜ„Éº„Ç∏ */
        #game-stage {
            position: relative;
            background-repeat: no-repeat;
            background-size: 100% 100%;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            width: 800px; height: 450px; /* JS„Åß„É™„Çµ„Ç§„Ç∫ */
        }
        /* Â§ú„Éï„Ç£„É´„Çø„Éº */
        #game-stage.night-mode::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 10, 30, 0.6);
            pointer-events: none; z-index: 12; transition: background 0.5s;
            mix-blend-mode: multiply;
        }

        /* „Ç≠„É£„É©„ÇØ„Çø„Éº */
        #character {
            position: absolute;
            background-repeat: no-repeat;
            image-rendering: pixelated; 
            transform-origin: bottom center;
            z-index: 10; cursor: pointer; pointer-events: auto; 
        }

        /* Âêπ„ÅçÂá∫„Åó„Éª„Ç®„Éï„Çß„ÇØ„Éà */
        .emote {
            position: absolute; top: -110px;
            left: 50%; transform: translateX(-50%);
            width: 80px; height: 80px;
            background: #fff; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 50px;
            border: 4px solid var(--text);
            opacity: 0; pointer-events: none; z-index: 20;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .show { opacity: 1; animation: popUp 0.3s forwards; }
        @keyframes popUp { from { transform: translateX(-50%) scale(0); } to { transform: translateX(-50%) scale(1); } }

        /* Áã¨„ÇäË®Ä„Éê„É´„Éº„É≥ */
        #speech-bubble {
            position: absolute; top: -120px;
            left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.98);
            border: 4px solid var(--text); padding: 12px 24px;
            border-radius: 16px; 
            font-size: 24px; font-weight: bold;
            white-space: nowrap; color: var(--text);
            opacity: 0; pointer-events: none; z-index: 21; transition: opacity 0.3s;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        #speech-bubble::after {
            content: ''; position: absolute; bottom: -10px; left: 50%; margin-left: -10px;
            border-width: 10px 10px 0; border-style: solid; border-color: var(--text) transparent;
        }

        /* „Ç®„Éï„Çß„ÇØ„Éà„ÉÜ„Ç≠„Çπ„Éà */
        #fx {
            position: absolute; top: -80px; left: 50%; transform: translateX(-50%);
            font-size: 60px;
            white-space: nowrap; opacity: 0; transition: all 0.5s; z-index: 20;
            text-shadow: 3px 3px 0 #fff, -2px -2px 0 #fff;
            font-weight: bold;
        }

        /* „Éõ„ÉÉ„Éà„Çπ„Éù„ÉÉ„Éà */
        .hotspot { 
            position: absolute; 
            cursor: pointer; 
            z-index: 5;
            transition: all 0.3s ease;
            border-radius: 20px;
        }
        
        .hotspot:hover {
            background-color: rgba(255, 255, 255, 0.15); 
            box-shadow: 0 0 20px 5px rgba(255, 255, 255, 0.2);
        }

        .hotspot:hover::after {
            content: attr(title);
            position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
            background: var(--text); color: #fff; padding: 6px 12px; font-size: 16px;
            border-radius: 6px; white-space: nowrap; pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 30;
        }

        /* „ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆ„Ç≠„É©„Ç≠„É© */
        .click-star {
            position: absolute; pointer-events: none; z-index: 99;
            color: #FFD54F; font-size: 24px;
            animation: starAnim 0.6s ease-out forwards;
        }
        @keyframes starAnim {
            0% { transform: scale(0.5) rotate(0deg); opacity: 1; }
            100% { transform: scale(1.5) rotate(90deg); opacity: 0; }
        }
       
        /* --- ÂÆ∂ÂÖ∑ÈÖçÁΩÆ (%) --- */
        #zone-bed { top: 18%; left: 4%; width: 17%; height: 26%; }
        #zone-lamp { top: 22%; left: 5%; width: 5%; height: 8%; z-index: 15; border-radius: 50%; }
        #zone-timer { top: 22%; left: 22%; width: 6%; height: 10%; z-index: 15; }
        
        #zone-read { top: 12%; left: 36%; width: 10%; height: 20%; }
        #zone-cook { top: 12%; left: 63%; width: 22%; height: 20%; }
        #zone-fridge { top: 10%; left: 88%; width: 10%; height: 25%; }
        #zone-table { top: 44%; left: 70%; width: 18%; height: 22%; }
        #zone-desk { top: 72%; left: 4%; width: 20%; height: 22%; }
        #zone-sofa { top: 70%; left: 88%; width: 10%; height: 20%; }

        /* ÂÖâÊ∫êË®≠ÂÆö */
        #lamp-light {
            position: absolute;
            top: 7%; left: -1%;
            width: 14%; height: 22%;
            background: radial-gradient(circle at center, rgba(255, 220, 150, 0.8) 0%, rgba(255, 220, 150, 0) 70%);
            border-radius: 50%; z-index: 14; opacity: 0; transition: opacity 0.5s; pointer-events: none;
            mix-blend-mode: hard-light;
        }
        #lamp-light.on { opacity: 1; }

        #pc-light {
            position: absolute;
            top: 68%; left: 8%;
            width: 15%; height: 20%;
            background: radial-gradient(ellipse at center bottom, rgba(150, 200, 255, 0.7) 0%, rgba(0, 0, 0, 0) 80%);
            z-index: 14; opacity: 0; transition: opacity 0.5s; pointer-events: none;
            mix-blend-mode: hard-light;
        }
        #game-stage.night-mode #pc-light { opacity: 1; }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 500;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; color: white;
        }
        .card { background: white; color: #333; padding: 30px; border-radius: 20px; text-align: center; border: 4px solid var(--primary); min-width: 250px; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        
        button {
            padding: 8px 12px; font-family: var(--font); border: none; font-size: 14px;
            background: var(--primary); color: white; border-radius: 8px; cursor: pointer;
            box-shadow: 0 3px 0 #3e2723; transition: transform 0.1s;
        }
        button:active { transform: translateY(3px); box-shadow: none; }
        button:hover { filter: brightness(1.1); }
        select, input[type=range] { font-family: var(--font); padding: 5px; border-radius: 5px; border: 2px solid var(--primary); }

        /* UI„Éê„Éº */
        #ui-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 800px; background: var(--ui-bg); border-radius: 30px; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); gap: 15px; flex-wrap: wrap;
        }
        .ui-group { display: flex; align-items: center; gap: 10px; }
        .bar-wrap { width: 80px; height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; margin-top: 2px; }
        .bar-fill { height: 100%; width: 50%; background: #4CAF50; transition: width 0.3s; }
        .bgm-controls { display: flex; align-items: center; gap: 5px; }
        #bgm-vol { width: 60px; }
    </style>
</head>
<body>

<div id="game-stage">
    <div id="lamp-light"></div>
    <div id="pc-light"></div>

    <div id="zone-bed" class="hotspot" onclick="game.handleInput('bed', event)" title="Bed"></div>
    <div id="zone-lamp" class="hotspot" onclick="game.handleInput('lamp', event)" title="Lamp Switch"></div>
    <div id="zone-timer" class="hotspot" onclick="game.handleInput('timer', event)" title="Alarm Clock"></div>
    <div id="zone-read" class="hotspot" onclick="game.handleInput('read', event)" title="Books"></div>
    <div id="zone-cook" class="hotspot" onclick="game.handleInput('cook', event)" title="Kitchen"></div>
    <div id="zone-fridge" class="hotspot" onclick="game.handleInput('fridge', event)" title="Fridge"></div>
    <div id="zone-table" class="hotspot" onclick="game.handleInput('eat', event)" title="Table"></div>
    <div id="zone-desk" class="hotspot" onclick="game.handleInput('work', event)" title="Desk"></div>
    <div id="zone-sofa" class="hotspot" onclick="game.handleInput('relax', event)" title="Sofa"></div>

    <div id="character" style="display: none;" onclick="game.pet(event)">
        <div id="emote" class="emote">‚ùó</div>
        <div id="speech-bubble"></div>
        <div id="fx"></div>
    </div>

    <div id="menu-fridge" class="modal">
        <div class="card">
            <h3 style="margin:0">Refrigerator</h3>
            <p style="font-size:12px">„É°„Éã„É•„Éº„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</p>
            <div class="btn-grid">
                <button onclick="game.selectFood('üçô', 15)">üçô<br><small>Rice</small></button>
                <button onclick="game.selectFood('üçû', 10)">üçû<br><small>Toast</small></button>
                <button onclick="game.selectFood('ü•©', 40)">ü•©<br><small>Steak</small></button>
            </div>
            <button onclick="game.closeModals()" style="margin-top:15px; background:#999; font-size:12px;">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <div id="menu-timer" class="modal">
        <div class="card">
            <h3>‚è∞ Timer</h3>
            <div id="timer-disp" style="font-size:40px; font-weight:bold; margin:10px;">00:00</div>
            <div style="display:flex; gap:5px; justify-content:center; margin-bottom:15px;">
                <button onclick="game.timerAdd(1)" style="font-size:12px;">+1m</button>
                <button onclick="game.timerAdd(5)" style="font-size:12px;">+5m</button>
                <button onclick="game.timerReset()" style="font-size:12px; background:#f44336;">Reset</button>
            </div>
            <button onclick="game.timerStart()" style="width:100%; background:var(--accent);">START / STOP</button>
            <button onclick="game.closeModals()" style="margin-top:10px; background:transparent; color:#888; box-shadow:none;">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <div id="menu-start" class="modal" style="display: flex;">
        <div class="card">
            <h1 style="color:var(--primary); margin-bottom:10px;">Pixel Room</h1>
            <p style="margin-bottom:20px; font-size:14px;">‰ªäÊó•„ÇÇ‰∏ÄÊó•„Çí„ÅØ„Åò„ÇÅ„Åæ„Åó„Çá„ÅÜ</p>
            <button onclick="game.loadDefaultChar()">GAME START</button>
        </div>
    </div>
</div>

<div id="ui-bar">
    <div class="ui-group">
        <div><small>HUNGER</small><div class="bar-wrap"><div id="bar-h" class="bar-fill"></div></div></div>
        <div><small>HAPPY</small><div class="bar-wrap"><div id="bar-f" class="bar-fill"></div></div></div>
    </div>
    
    <div class="ui-group bgm-controls">
        <button id="btn-night" onclick="game.toggleNightMode()">‚òÄÔ∏è Day</button>
        <select id="bgm-select" onchange="game.changeBgm(this.value)">
            <option value="">üéµ BGM Off</option>
            <option value="„Éî„ÇØ„Çª„É´„Éª„Ç≠„É£„É≥„Éá„Ç£.mp3">üç¨ Candy</option>
            <option value="„Åª„ÅÆ„Åº„ÅÆ„Éû„Éº„Ç±„ÉÉ„Éà.mp3">üõí Market</option>
            <option value="„Å©„Çä„Éº„ÇÄ„Éë„É©„É°„Éº„Çø„Éº.mp3">üí§ Dream</option>
        </select>
        <input type="range" id="bgm-vol" min="0" max="1" step="0.1" value="0.1" oninput="game.setVolume(this.value)" title="Volume">
    </div>
</div>

<script>
    const WALL_Y_RATIO = 0.38;

    class Game {
        constructor() {
            this.stage = document.getElementById('game-stage');
            this.char = document.getElementById('character');
            this.bg = new Image();
            this.bg.src = 'images/background/gamebg-heya1.png';
            this.bg.onerror = () => { this.bg.src = 'images/background/gamebg-heya1.png'; };
            this.bg.onload = () => this.resize();

            this.stats = { h: 70, f: 70 };
            this.pos = { x: 0, y: 0 };
            this.target = { x: 0, y: 0 };
            this.sprite = { w:0, h:0, frame:1, dir:0, lastTime:0 };
            this.isMoving = false;
            this.isBusy = false;
            this.isLampOn = false;
            this.isNight = false;
            this.timer = { val: 0, id: null, run: false };
            
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            this.bgm = new Audio();
            this.bgm.loop = true;
            this.bgm.volume = 0.1;

            setInterval(() => this.randomChatter(), 8000);

            this.initEvents();
            requestAnimationFrame(t => this.loop(t));
            setInterval(() => this.autoWander(), 3000);
        }

        initEvents() {
            window.addEventListener('resize', () => this.resize());
            this.stage.addEventListener('pointerdown', (e) => {
                if (this.audioCtx.state === 'suspended') {
                    this.audioCtx.resume();
                }

                if(e.target === this.stage) { 
                    const r = this.stage.getBoundingClientRect();
                    this.createSparkle(e.clientX, e.clientY);
                    this.handleInput('move', e, e.clientX - r.left, e.clientY - r.top);
                }
            });
        }

        playSE(type) {
            if (!this.audioCtx) return;
            const osc = this.audioCtx.createOscillator();
            const gain = this.audioCtx.createGain();
            osc.connect(gain);
            gain.connect(this.audioCtx.destination);

            const now = this.audioCtx.currentTime;
            
            if (type === 'click') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'action') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.2);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'pet') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(1000, now);
                osc.frequency.linearRampToValueAtTime(1500, now + 0.1);
                osc.frequency.linearRampToValueAtTime(2000, now + 0.2);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        toggleNightMode() {
            this.playSE('click');
            this.isNight = !this.isNight;
            this.stage.classList.toggle('night-mode', this.isNight);
            document.getElementById('btn-night').textContent = this.isNight ? 'üåô Night' : '‚òÄÔ∏è Day';
            this.isLampOn = this.isNight;
            document.getElementById('lamp-light').classList.toggle('on', this.isLampOn);
            if(this.isNight) this.showFx('Night Mode');
        }

        changeBgm(src) {
            this.playSE('click');
            if(src) {
                this.bgm.src = src;
                this.bgm.play().catch(e => console.log("BGMÂÜçÁîü„Ç®„É©„Éº"));
            } else {
                this.bgm.pause();
            }
        }

        setVolume(val) { this.bgm.volume = val; }

        loadDefaultChar() {
            this.playSE('action');
            if (this.audioCtx.state === 'suspended') this.audioCtx.resume();
            
            const img = new Image();
            img.src = "images/hoko/mahiru.png";
            img.onload = () => {
                this.sprite.w = img.width / 3;
                this.sprite.h = img.height / 4;
                this.char.style.width = this.sprite.w + 'px';
                this.char.style.height = this.sprite.h + 'px';
                this.char.style.backgroundImage = `url(${img.src})`;
                this.char.style.transform = `scale(${120 / this.sprite.h})`;
                this.resize();
                this.pos = { x: parseInt(this.stage.style.width)/2, y: parseInt(this.stage.style.height)*0.7 };
                this.target = { ...this.pos };
                this.char.style.display = 'block';
                document.getElementById('menu-start').style.display = 'none';
            };
            img.onerror = () => alert("„Ç≠„É£„É©„ÇØ„Çø„Éº „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ");
        }

        resize() {
            if(!this.bg.width) return;
            const ratio = this.bg.naturalWidth / this.bg.naturalHeight;
            const w = window.innerWidth, h = window.innerHeight;
            let fw, fh;
            if (w/h > ratio) { fh = h; fw = h * ratio; } else { fw = w; fh = w / ratio; }
            this.stage.style.width = fw + 'px';
            this.stage.style.height = fh + 'px';
            this.stage.style.backgroundImage = `url(${this.bg.src})`;
        }

        handleInput(type, e, tx, ty) {
            if(this.isBusy) return;
            this.playSE('click');

            if(e) this.createSparkle(e.clientX, e.clientY);

            this.showEmote('‚ùó');
            setTimeout(() => {
                if(type === 'move') this.setTarget(tx, ty);
                else this.moveToObject(type);
            }, 200);
        }

        setTarget(x, y) {
            const h = parseInt(this.stage.style.height);
            const w = parseInt(this.stage.style.width);
            this.target.x = Math.max(0, Math.min(w, x));
            this.target.y = Math.max(h * WALL_Y_RATIO, Math.min(h * 0.95, y));
            this.isMoving = true;
        }

        moveToObject(type) {
            // ‰øÆÊ≠£ÁÆáÊâÄÔºö„Ç¢„ÇØ„Ç∑„Éß„É≥Âêç„Å®ID„ÅåÁï∞„Å™„ÇãÂ†¥Âêà„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíËøΩÂä†
            const zoneMap = { eat: 'table', work: 'desk', relax: 'sofa' };
            const id = zoneMap[type] || type;
            
            const zone = document.getElementById('zone-' + id);
            if(!zone) return;
            const r = zone.getBoundingClientRect();
            const sr = this.stage.getBoundingClientRect();
            this.setTarget((r.left - sr.left) + r.width/2, (r.top - sr.top) + r.height);
            this.pendingAction = type;
        }

        autoWander() {
            if(this.isMoving || this.isBusy || Math.random() > 0.6) return;
            const r = 50;
            this.setTarget(this.pos.x + (Math.random()-0.5)*r, this.pos.y + (Math.random()-0.5)*r);
        }
        
        randomChatter() {
            if(this.isBusy || document.getElementById('menu-start').style.display !== 'none') return;
            if(Math.random() > 0.4) return;

            let msgs = ["...", "„Åµ„ÅÜ", "‚ô™", "„Éí„Éû„Å†„Å™"];
            if(this.stats.h < 30) msgs = ["„Åä„Å™„Åã„Åô„ÅÑ„Åü", "„Åê„ÅÖ...", "„Åî„ÅØ„Çì..."];
            if(this.stats.f < 30) msgs = ["ÈÄÄÂ±à...", "ÈÅä„Å≥„Åü„ÅÑ", "„Åü„ÇÅÊÅØ"];
            if(this.isNight) msgs = ["Áú†„ÅÑ„Åã„ÇÇ", "Êöó„ÅÑ„Å≠", "Èùô„Åã..."];
            
            const msg = msgs[Math.floor(Math.random() * msgs.length)];
            const b = document.getElementById('speech-bubble');
            b.textContent = msg;
            b.style.opacity = 1;
            setTimeout(() => b.style.opacity = 0, 3000);
        }

        createSparkle(x, y) {
            const s = document.createElement('div');
            s.className = 'click-star';
            s.textContent = '‚ú¶';
            s.style.left = (x - 10) + 'px';
            s.style.top = (y - 10) + 'px';
            document.body.appendChild(s);
            setTimeout(() => s.remove(), 600);
        }

        loop(t) {
            if(this.char.style.display !== 'none') {
                const dx = this.target.x - this.pos.x, dy = this.target.y - this.pos.y;
                if(Math.sqrt(dx*dx + dy*dy) > 4) {
                    this.isMoving = true;
                    const angle = Math.atan2(dy, dx);
                    this.pos.x += Math.cos(angle)*4; this.pos.y += Math.sin(angle)*4;
                    const deg = angle*(180/Math.PI);
                    this.sprite.dir = (deg>-45&&deg<=45)?2:(deg>45&&deg<=135)?0:(deg>135||deg<=-135)?1:3;
                    if(t-this.sprite.lastTime>150) { this.sprite.frame=(this.sprite.frame+1)%3; this.sprite.lastTime=t; }
                } else {
                    if(this.isMoving) {
                        this.isMoving = false; this.sprite.frame = 1;
                        if(this.pendingAction) { this.doAction(this.pendingAction); this.pendingAction = null; }
                    }
                }
                this.draw();
            }
            requestAnimationFrame(t => this.loop(t));
        }

        draw() {
            this.char.style.left = (this.pos.x - this.sprite.w/2) + 'px';
            this.char.style.top = (this.pos.y - this.sprite.h) + 'px';
            this.char.style.zIndex = Math.floor(this.pos.y);
            this.char.style.backgroundPosition = `-${this.sprite.frame*this.sprite.w}px -${this.sprite.dir*this.sprite.h}px`;
        }

        doAction(type) {
            this.playSE('action');

            if(type === 'lamp') {
                this.isLampOn = !this.isLampOn;
                document.getElementById('lamp-light').classList.toggle('on', this.isLampOn);
                this.showFx(this.isLampOn ? 'ON' : 'OFF');
                return;
            }
            if(type === 'fridge') { document.getElementById('menu-fridge').style.display='flex'; return; }
            if(type === 'timer') { document.getElementById('menu-timer').style.display='flex'; return; }

            this.isBusy = true;
            const fx = { eat:'üòã', read:'üìñ', cook:'üç≥', work:'üíª', relax:'üéµ', bed:'üí§' };
            this.showFx(fx[type] || '‚ú®');
            
            const chats = { eat:'„Åä„ÅÑ„Åó„ÅÑÔºÅ', read:'„Åµ„ÇÄ„Åµ„ÇÄ', cook:'„Åß„Åç„ÅüÔºÅ', work:'ÈõÜ‰∏≠...', relax:'Ê•µÊ•Ω„Äú', bed:'„Åä„ÇÑ„Åô„Åø' };
            if(chats[type]) {
                const b = document.getElementById('speech-bubble');
                b.textContent = chats[type];
                b.style.opacity = 1;
                setTimeout(() => b.style.opacity = 0, 2000);
            }

            setTimeout(() => { 
                if(type === 'bed') this.stats.h -= 5;
                if(type === 'cook') this.stats.f += 10;
                this.isBusy = false; this.updateUI(); 
            }, 2000);
        }
        
        selectFood(icon, val) {
            this.playSE('action');
            this.closeModals(); this.isBusy = true; this.showFx(icon);
            setTimeout(() => { this.stats.h = Math.min(100, this.stats.h + val); this.isBusy = false; this.updateUI(); }, 1500);
        }

        pet(e) { 
            if(e) e.stopPropagation(); 
            this.playSE('pet');
            this.showFx('‚ù§Ô∏è'); 
            this.createSparkle(e.clientX, e.clientY);
            this.stats.f = Math.min(100, this.stats.f + 5); 
            this.updateUI(); 
        }
        showEmote(emoji) { const e = document.getElementById('emote'); e.textContent = emoji; e.classList.add('show'); setTimeout(() => e.classList.remove('show'), 1000); }
        showFx(text) { const f = document.getElementById('fx'); f.textContent = text; f.style.opacity = 1; f.style.top = "-80px"; setTimeout(() => { f.style.opacity = 0; f.style.top = "-70px"; }, 1500); }
        updateUI() { document.getElementById('bar-h').style.width = this.stats.h + '%'; document.getElementById('bar-f').style.width = this.stats.f + '%'; }
        closeModals() { 
            this.playSE('click');
            document.querySelectorAll('.modal').forEach(m => { if(m.id !== 'menu-start') m.style.display = 'none'; }); 
        }
        timerAdd(m) { this.playSE('click'); this.timer.val += m*60; this.updateTimerDisp(); }
        timerReset() { this.playSE('click'); this.timer.val = 0; clearInterval(this.timer.id); this.timer.run = false; this.updateTimerDisp(); }
        timerStart() { this.playSE('click'); if(this.timer.run) { clearInterval(this.timer.id); this.timer.run = false; } else if(this.timer.val > 0) { this.timer.run = true; this.timer.id = setInterval(() => { this.timer.val--; this.updateTimerDisp(); if(this.timer.val <= 0) { this.timerReset(); alert("‚è∞ „Éî„Éî„ÉîÔºÅÊôÇÈñì„Åß„ÅôÔºÅ"); } }, 1000); } }
        updateTimerDisp() { document.getElementById('timer-disp').textContent = `${Math.floor(this.timer.val/60).toString().padStart(2,'0')}:${(this.timer.val%60).toString().padStart(2,'0')}`; }
    }

    const game = new Game();
</script>
</body>
</html>