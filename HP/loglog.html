<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TACTICAL LOG VIEWER v17.2 | HUD & VISUALS</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;600;700&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            /* Theme Variables */
            --theme-hue: 180;
            --primary-color: hsl(var(--theme-hue), 100%, 50%);
            --bg-base: #02050a;
            --bg-panel: rgba(5, 12, 20, 0.95);
            
            /* NEON PALETTE */
            --neon-alert: #ff003c;   /* Red/Fumble */
            --neon-green: #0aff0a;   /* Green/Success */
            --neon-purple: #d600ff;  /* Purple/Special */
            --neon-orange: #ffaa00;  /* Orange/Init */
            --neon-cyan: #00f3ff;    /* Cyan/Critical */
            
            --text-main: #e0faff;
            --grid-line: hsla(var(--theme-hue), 100%, 50%, 0.08);
            --scan-line: hsla(var(--theme-hue), 100%, 50%, 0.03);

            /* Area Colors */
            --col-left: #d600ff;   
            --col-center: #0aff0a; 
            --col-right: var(--primary-color);  
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Rajdhani', 'Zen Kaku Gothic New', sans-serif;
            background-color: var(--bg-base);
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 40px 40px;
            color: var(--text-main);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex;
        }

        /* Scanline Effect */
        body::after {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0) 50%, var(--scan-line) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 9999;
        }

        /* --- Initial Boot Loader --- */
        .boot-loader {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 100000; /* ÊúÄÂâçÈù¢ */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-in-out, visibility 0.8s;
        }
        .boot-loader.fade-out {
            opacity: 0; visibility: hidden; pointer-events: none;
        }
        .boot-text {
            font-family: 'Orbitron'; font-size: 1.5rem; letter-spacing: 5px;
            color: var(--primary-color); margin-top: 20px;
            animation: textBlink 1s infinite alternate;
        }
        @keyframes textBlink { from { opacity: 0.4; } to { opacity: 1; } }

        /* --- Upload Overlay --- */
        .upload-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(2, 5, 10, 0.95);
            backdrop-filter: blur(10px);
            z-index: 99999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }

        /* ÊµÆÈÅä„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆÂÆöÁæ© */
        @keyframes floatEffect {
            0% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0); }
        }

        .upload-box {
            border: 2px dashed var(--primary-color);
            background: rgba(0, 20, 30, 0.8);
            /* Padding„ÇíÂ¢ó„ÇÑ„Åó„Å¶ÊúÄÂàù„Åã„ÇâÂ§ß„Åç„ÅèÂõ∫ÂÆö */
            padding: 75px 100px; 
            text-align: center; cursor: pointer; transition: 0.3s;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
            
            /* ÊµÆÈÅä„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈÅ©Áî® */
            animation: floatEffect 3s ease-in-out infinite;
        }
        .upload-box:hover {
            background: rgba(0, 243, 255, 0.1);
            box-shadow: 0 0 50px var(--primary-color); 
            /* transform: scale(1.02); „ÇíÂâäÈô§„Åó„ÄÅÊè∫„Çâ„Åé„ÇíÈò≤Ê≠¢ */
        }
        .hidden { display: none !important; }

        .app-container { display: flex; width: 100%; height: 100%; position: relative; z-index: 10; }

        /* --- Main Screen --- */
        .main-screen {
            flex: 1; display: flex; flex-direction: column; position: relative;
            overflow: hidden; align-items: center;
        }

        .screen-header {
            width: 100%; padding: 15px 30px; border-bottom: 1px solid hsla(var(--theme-hue), 100%, 50%, 0.3);
            display: flex; flex-direction: column; gap: 10px;
            background: linear-gradient(90deg, hsla(var(--theme-hue), 100%, 50%, 0.05), transparent);
            backdrop-filter: blur(5px); flex-shrink: 0;
        }
        
        .header-top { width: 100%; display: flex; justify-content: space-between; align-items: flex-end; }
        .screen-title { font-family: 'Orbitron'; font-size: 1.5rem; color: var(--primary-color); letter-spacing: 2px; text-shadow: 0 0 10px var(--primary-color); }
        .screen-status { font-family: 'Share Tech Mono'; font-size: 0.8rem; color: var(--primary-color); opacity: 0.7; }

        /* Search Bar */
        .search-container {
            display: flex; align-items: center; gap: 10px; margin-left: auto; margin-right: 20px;
        }
        .search-input {
            background: rgba(0,0,0,0.3); border: 1px solid var(--primary-color); color: #fff;
            padding: 5px 10px; font-family: 'Zen Kaku Gothic New'; font-size: 0.9rem;
            width: 200px; transition: 0.3s;
        }
        .search-input:focus { width: 300px; box-shadow: 0 0 10px var(--primary-color); outline: none; }

        .tab-filters { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; width: 100%; }
        .tab-filters::-webkit-scrollbar { height: 4px; }
        .tab-filters::-webkit-scrollbar-thumb { background: var(--primary-color); }
        
        .tab-btn {
            background: rgba(0,0,0,0.3); border: 1px solid #444; color: #888;
            padding: 4px 12px; font-size: 0.8rem; cursor: pointer; white-space: nowrap;
            font-family: 'Rajdhani'; transition: 0.2s;
        }
        .tab-btn:hover { border-color: var(--primary-color); color: #fff; }
        .tab-btn.active { background: var(--primary-color); color: #000; font-weight: bold; box-shadow: 0 0 10px var(--primary-color); }

        /* Chat Area */
        .chat-scroll-area {
            flex: 1; width: 100%; overflow-y: auto; padding: 30px 0;
            scrollbar-width: thin; scrollbar-color: var(--primary-color) var(--bg-base);
            display: flex; flex-direction: column; align-items: center;
        }
        .chat-list {
            width: 100%; max-width: 900px; display: flex; flex-direction: column;
            gap: 24px; 
            padding: 0 20px 100px 20px;
        }

        /* Message Row */
        .message-row {
            display: flex; gap: 15px; position: relative;
            /* opacity: 0; animationÂâäÈô§ */
            /* animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; */
            min-height: min-content;
            
            /* „ÄêËøΩÂä†„Äë„É¨„É≥„ÉÄ„É™„É≥„Ç∞ÊúÄÈÅ©Âåñ */
            content-visibility: auto;
            contain-intrinsic-size: 50px; 
        }
        .message-row.filtered { display: none; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .message-content { display: flex; flex-direction: column; max-width: 100%; }
        
        .bubble {
            padding: 14px 22px; 
            color: #eee; line-height: 1.8; font-size: 0.95rem;
            position: relative; 
            background: var(--char-bg-tint, rgba(20, 30, 40, 0.6));
            border: 1px solid var(--char-border, rgba(255,255,255,0.2));
            backdrop-filter: blur(2px);
            transition: 0.3s;
            overflow-wrap: break-word; 
            word-break: break-word;
        }

        .avatar {
            width: 50px; height: 50px; flex-shrink: 0; background: #000;
            border: 1px solid var(--primary-color);
            clip-path: polygon(20% 0, 100% 0, 100% 80%, 80% 100%, 0 100%, 0 20%);
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; box-shadow: 0 0 5px var(--primary-color);
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .avatar span { font-weight: bold; color: #fff; font-size: 1.2rem; }

        /* Styles */
        .pos-left { align-self: flex-start; max-width: 95%; }
        .pos-left .avatar { display: none; }
        .pos-left .message-content { width: 100%; }
        .pos-left .char-info { color: var(--col-left); font-family: 'Orbitron'; font-size: 0.8rem; margin-bottom: 4px; padding-left: 10px; }
        .pos-left .bubble {
            background: linear-gradient(90deg, rgba(214, 0, 255, 0.15), transparent);
            border: none; border-left: 4px solid var(--col-left);
            border-bottom: 1px solid rgba(214, 0, 255, 0.3); border-radius: 0 4px 4px 0;
        }

        .pos-center { 
            align-self: center; width: 100%; display: flex; justify-content: center; 
            /* „Éû„Éº„Ç∏„É≥(Êû†Â§ñ)„ÇíÊ∏õ„Çâ„Åó„ÄÅ„Éë„Éá„Ç£„É≥„Ç∞(Êû†ÂÜÖ)„ÇíÂ¢ó„ÇÑ„Åô */
            margin: 0 0 10px 0;
            padding-top: 25px; /* „É©„Éô„É´„ÅåË°®Á§∫„Åï„Çå„ÇãÁ©∫Èñì„Çí„ÄåË¶ÅÁ¥†„ÅÆÂÜÖÂÅ¥„Äç„Å®„Åó„Å¶Á¢∫‰øù */
        }
        .pos-center .message-content { align-items: center; width: 100%; }
        .pos-center .bubble {
            background: rgba(0, 20, 10, 0.95);
            border: 1px solid var(--col-center); color: var(--col-center);
            font-family: 'Share Tech Mono', monospace;
            padding: 12px 40px; 
            font-size: 0.95rem; text-align: center; min-width: 320px;
            box-shadow: 0 0 15px rgba(10, 255, 10, 0.15);
            clip-path: polygon(15px 0, calc(100% - 15px) 0, 100% 15px, 100% calc(100% - 15px), calc(100% - 15px) 100%, 15px 100%, 0 calc(100% - 15px), 0 15px);
        }
        .actor-label {
            position: absolute; top: -14px; left: 20px; 
            background: var(--bg-base); border: 1px solid var(--col-center); color: #fff;
            font-size: 0.7rem; padding: 2px 8px; font-family: 'Rajdhani';
            z-index: 5;
            white-space: nowrap; 
        }

        .pos-right { align-self: flex-end; flex-direction: row-reverse; text-align: left; max-width: 85%; }
        .pos-right .message-content { align-items: flex-end; }
        .pos-right .char-info {
            color: var(--char-text-color, #ccc); font-size: 0.8rem; margin-bottom: 4px;
            display: flex; gap: 8px; flex-direction: row-reverse;
            font-family: 'Rajdhani'; font-weight: bold;
        }
        .pos-right .bubble {
            border-right: 3px solid var(--char-border-solid, var(--primary-color));
            clip-path: polygon(15px 0, 100% 0, 100% 100%, 0 100%, 0 15px);
        }

        /* Sidebar */
        .side-panel {
            width: 360px; background: var(--bg-panel); border-left: 2px solid var(--primary-color);
            display: flex; flex-direction: column; padding: 20px;
            box-shadow: -10px 0 40px rgba(0,0,0,0.8); z-index: 50; flex-shrink: 0;
            transition: transform 0.3s;
        }
        .panel-header {
            font-family: 'Orbitron'; color: var(--primary-color); border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px; margin-bottom: 15px; font-size: 1.1rem;
            display: flex; justify-content: space-between; align-items: center;
        }

        .config-zones { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .drop-zone {
            background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 4px;
            min-height: 80px; display: flex; flex-direction: column;
        }
        .zone-header { padding: 5px 10px; font-family: 'Orbitron'; font-size: 0.7rem; color: #000; font-weight: bold; }
        .zone-content { padding: 8px; display: flex; flex-wrap: wrap; gap: 6px; flex: 1; }
        
        .zone-left { border-color: var(--col-left); } .zone-left .zone-header { background: var(--col-left); }
        .zone-center { border-color: var(--col-center); } .zone-center .zone-header { background: var(--col-center); }
        .zone-right { border-color: var(--col-right); } .zone-right .zone-header { background: var(--col-right); }

        .char-tag {
            background: rgba(255,255,255,0.05); border: 1px solid #555; padding: 6px 8px;
            font-size: 0.8rem; cursor: grab; display: flex; align-items: center; gap: 8px; 
            width: 100%; transition: 0.2s; position: relative;
        }
        .char-tag.inactive { opacity: 0.5; border-color: #333; background: rgba(0,0,0,0.5); }
        .char-tag:hover { border-color: #fff; }

        .vis-check { position: relative; cursor: pointer; display: flex; align-items: center; }
        .vis-input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .checkmark {
            height: 16px; width: 16px; background-color: #333; border: 1px solid #666;
            display: inline-block; position: relative;
        }
        .vis-check:hover .vis-input ~ .checkmark { background-color: #444; }
        .vis-input:checked ~ .checkmark { background-color: var(--primary-color); border-color: var(--primary-color); box-shadow: 0 0 5px var(--primary-color); }
        .checkmark:after {
            content: ""; position: absolute; display: none;
            left: 5px; top: 1px; width: 4px; height: 9px;
            border: solid #000; border-width: 0 2px 2px 0; transform: rotate(45deg);
        }
        .vis-input:checked ~ .checkmark:after { display: block; }

        .mini-color { width: 14px; height: 14px; border:none; padding:0; background:none; cursor:pointer; }
        .mini-btn { 
            width: 20px; height: 20px; background:#222; color:#fff; 
            display:flex; justify-content:center; align-items:center; 
            font-size:10px; border:1px solid #555; cursor:pointer; 
        }
        .mini-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }

        .theme-selector { display: flex; gap: 5px; margin-bottom: 15px; }
        .theme-btn { flex: 1; height: 30px; border: 1px solid #555; cursor: pointer; transition: 0.2s; }
        .theme-btn:hover { transform: scale(1.05); border-color: #fff; }

        /* Modal */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100vw; height:100vh;
            background: rgba(2, 5, 10, 0.98); z-index: 10000; display: flex; flex-direction: column; padding: 30px;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--neon-green); padding-bottom: 15px; margin-bottom: 15px;
        }
        .modal-title { font-family: 'Orbitron'; font-size: 1.8rem; color: var(--neon-green); letter-spacing: 2px; }
        .close-btn {
            background: transparent; border: 1px solid var(--neon-alert); color: var(--neon-alert);
            padding: 8px 20px; cursor: pointer; font-family: 'Orbitron'; font-weight: bold;
        }
        
        .filter-bar {
            display: flex; gap: 15px; margin-bottom: 20px; padding: 15px;
            background: rgba(0, 255, 10, 0.05); border: 1px solid rgba(0, 255, 10, 0.3);
            flex-wrap: wrap; justify-content: center; align-items: center;
        }
        .filter-label {
            display: flex; align-items: center; gap: 8px; color: #eee; font-family: 'Rajdhani'; cursor: pointer; user-select: none;
            background: rgba(0,0,0,0.3); padding: 5px 10px; border: 1px solid #444; margin-bottom: 5px;
        }
        .filter-label:hover { border-color: #fff; }
        .filter-label input { accent-color: var(--neon-green); transform: scale(1.2); }
        
        .dice-filter-input {
            background: #111; border: 1px solid var(--neon-green); color: #fff; padding: 5px; 
            font-family: 'Share Tech Mono'; width: 100px;
        }
        .sort-select {
            background: #111; border: 1px solid var(--neon-green); color: #fff; padding: 5px; 
            font-family: 'Rajdhani';
        }

        .analysis-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;
            overflow-y: auto; padding-right: 10px;
            flex: 1; /* „Ç∞„É™„ÉÉ„Éâ„Ç®„É™„Ç¢„ÇíÂ∫É„Åí„Çã */
        }
        .analysis-grid::-webkit-scrollbar { width: 8px; }
        .analysis-grid::-webkit-scrollbar-thumb { background: var(--neon-green); }

        .char-card {
            border: 1px solid var(--neon-green); background: rgba(0, 20, 10, 0.6); padding: 15px;
            display: flex; flex-direction: column;
            
            /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®ÂàùÊúüÁä∂ÊÖã */
            opacity: 0; transform: scale(0.9) translateY(20px);
            animation: cardBoot 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes cardBoot { to { opacity: 1; transform: scale(1) translateY(0); } }

        .card-header {
            font-family: 'Rajdhani'; font-weight: bold; font-size: 1.1rem;
            color: var(--neon-green); border-bottom: 1px solid rgba(0, 255, 10, 0.3);
            margin-bottom: 10px; padding-bottom: 5px;
        }
        .stat-grid {
            display: grid; grid-template-columns: 1fr; gap: 5px 10px; margin-bottom: 10px;
            background: rgba(0,0,0,0.3); padding: 8px; font-size: 0.85rem;
        }
        .stat-item { display: flex; justify-content: space-between; }
        
        .log-section { flex: 1; font-size: 0.85rem; overflow-y: auto; max-height: 400px; }
        
        /* --- Log Item Styling (Color Coding) --- */
        .log-item {
            margin-bottom: 6px; padding: 10px 12px; 
            font-family: 'Zen Kaku Gothic New'; font-size: 0.9rem;
            line-height: 1.5; 
            border-left: 4px solid #555; /* „Éá„Éï„Ç©„É´„ÉàÁ∑ö */
            background: rgba(255,255,255,0.02);
            transition: 0.2s;
            overflow-wrap: break-word; word-break: break-all;
            display: flex; flex-direction: column; gap: 2px;
        }
        .log-item:hover { transform: translateX(5px); }

        /* CRITICAL: Neon Cyan (High Glow) */
        .log-item.is-crit { 
            border-left-color: var(--neon-cyan); 
            background: linear-gradient(90deg, rgba(0, 243, 255, 0.2), transparent);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.1) inset;
            color: #e0faff;
        }
        
        /* FUMBLE: Neon Red (High Glow) */
        .log-item.is-fumble { 
            border-left-color: var(--neon-alert); 
            background: linear-gradient(90deg, rgba(255, 0, 60, 0.2), transparent);
            box-shadow: 0 0 10px rgba(255, 0, 60, 0.1) inset;
            color: #ffcccc;
        }
        
        /* SPECIAL: Neon Purple */
        .log-item.is-special { 
            border-left-color: var(--neon-purple); 
            background: linear-gradient(90deg, rgba(214, 0, 255, 0.15), transparent);
            color: #fce0ff;
        }
        
        /* SUCCESS: Neon Green */
        .log-item.is-success { 
            border-left-color: var(--neon-green); 
            background: linear-gradient(90deg, rgba(10, 255, 10, 0.1), transparent);
            color: #d0ffd0;
        }

        /* INITIAL: Neon Orange */
        .log-item.is-init {
             border-left-color: var(--neon-orange);
             background: linear-gradient(90deg, rgba(255, 170, 0, 0.1), transparent);
             color: #ffecd0;
        }

        /* FAILURE: Muted Gray/Blue */
        .log-item.is-failure { 
            border-left-color: #666; 
            background: rgba(100, 100, 100, 0.1);
            color: #aaa;
        }

        /* „É©„Éô„É´Ôºà[CRIT]„Å™„Å©Ôºâ„ÅÆ„Çπ„Çø„Ç§„É´Ë™øÊï¥ */
        .log-label { font-family: 'Orbitron'; font-weight: bold; font-size: 0.8rem; margin-right: 5px; }

        .scan-btn {
            width: 100%; background: rgba(0, 255, 10, 0.1); border: 1px solid var(--neon-green);
            color: var(--neon-green); padding: 12px; margin-top: 15px; cursor: pointer;
            font-family: 'Orbitron'; letter-spacing: 1px; transition: 0.3s;
        }
        .scan-btn:hover { background: var(--neon-green); color: #000; box-shadow: 0 0 15px var(--neon-green); }

        /* Capture Button */
        .capture-btn {
            width: 100%; background: rgba(0, 243, 255, 0.1); border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan); padding: 12px; margin-top: 10px; cursor: pointer;
            font-family: 'Orbitron'; letter-spacing: 1px; transition: 0.3s;
        }
        .capture-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 15px var(--neon-cyan); }

        /* --- HUD Loading Animation --- */
        .hud-loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 5, 10, 0.9); z-index: 500;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .hud-ring-container {
            position: relative; width: 150px; height: 150px;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 20px;
        }

        .hud-ring {
            position: absolute; border-radius: 50%; border: 2px solid transparent;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
        }

        .hud-ring:nth-child(1) {
            width: 100%; height: 100%; border-top-color: var(--neon-green); border-bottom-color: var(--neon-green);
            animation: spin 2s linear infinite;
        }
        .hud-ring:nth-child(2) {
            width: 80%; height: 80%; border-left-color: var(--neon-cyan); border-right-color: var(--neon-cyan);
            animation: spin 1.5s linear infinite reverse;
        }
        .hud-ring:nth-child(3) {
            width: 60%; height: 60%; border-top-color: var(--neon-purple);
            animation: spin 1s linear infinite;
        }
        .hud-center-dot {
            width: 10px; height: 10px; background: var(--neon-green); border-radius: 50%;
            box-shadow: 0 0 15px var(--neon-green);
            animation: pulse 1s ease-in-out infinite;
        }

        .hud-text {
            font-family: 'Orbitron'; color: var(--neon-green); letter-spacing: 3px; font-size: 1.2rem;
            text-shadow: 0 0 10px var(--neon-green);
            animation: blink 0.5s step-end infinite alternate;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.5; } }
        @keyframes blink { 50% { opacity: 0; } }

        .menu-toggle { display: none; }
        @media(max-width: 900px) {
            .side-panel { position: fixed; right: 0; top: 0; height: 100%; transform: translateX(100%); }
            .side-panel.open { transform: translateX(0); }
            .menu-toggle { display: block; position: fixed; top: 15px; right: 15px; z-index: 200; }
        }
        
        .res-success { color: var(--neon-cyan); font-weight: bold; }
        .res-failure { color: var(--neon-alert); font-weight: bold; }
    </style>
</head>
<body>

    <div id="boot-loader" class="boot-loader">
        <div class="hud-ring-container">
            <div class="hud-ring"></div>
            <div class="hud-ring"></div>
            <div class="hud-ring"></div>
            <div class="hud-center-dot"></div>
        </div>
        <div class="boot-text">SYSTEM INITIALIZING...</div>
    </div>

    <div id="upload-overlay" class="upload-overlay">
        <div class="upload-box" id="upload-box">
            <div style="font-size:3rem; margin-bottom:15px; color:var(--primary-color);">üìÇ</div>
            <div style="font-family:'Orbitron'; font-size:1.5rem; color:var(--primary-color);">SYSTEM BOOT</div>
            <div style="font-family:'Share Tech Mono'; color:#888;">DROP HTML LOG FILE</div>
        </div>
        <input type="file" id="file-input" accept=".html" style="display:none">
    </div>

    <div id="growth-modal" class="modal-overlay hidden">
        <div id="hud-loader" class="hud-loader-overlay hidden">
            <div class="hud-ring-container">
                <div class="hud-ring"></div>
                <div class="hud-ring"></div>
                <div class="hud-ring"></div>
                <div class="hud-center-dot"></div>
            </div>
            <div class="hud-text">SYSTEM ANALYZING...</div>
        </div>

        <div class="modal-header">
            <div class="modal-title">GROWTH & DICE ANALYSIS</div>
            <button class="close-btn" id="close-modal">CLOSE</button>
        </div>
        
        <div class="filter-bar">
            <label class="filter-label"><input type="checkbox" checked id="chk-crit"> <span style="color:var(--neon-cyan)">CRIT</span></label>
            <label class="filter-label"><input type="checkbox" checked id="chk-fumble"> <span style="color:var(--neon-alert)">FUMB</span></label>
            <label class="filter-label"><input type="checkbox" id="chk-special"> <span style="color:var(--neon-purple)">SPEC</span></label>
            <label class="filter-label"><input type="checkbox" id="chk-init"> <span style="color:var(--neon-orange)">INIT</span></label>
            <label class="filter-label"><input type="checkbox" id="chk-success"> <span style="color:var(--neon-green)">SUCCESS</span></label>
            <label class="filter-label"><input type="checkbox" id="chk-failure"> <span style="color:#aaa">FAILURE</span></label>
            
            <label class="filter-label"><input type="checkbox" id="chk-stats" checked> <span style="color:#fff">SHOW SKILL FREQUENCY</span></label>

            <div style="display:flex; align-items:center; gap:5px; margin-left:10px; border-left:1px solid #444; padding-left:10px;">
                <span style="font-family:'Orbitron'; font-size:0.8rem; color:#888;">DICE =</span>
                <input type="number" id="dice-target" class="dice-filter-input" placeholder="ex. 1, 96">
            </div>

            <div style="display:flex; align-items:center; gap:5px; margin-left:10px;">
                <select id="sort-order" class="sort-select">
                    <option value="default">DEFAULT SORT</option>
                    <option value="desc">DICE: HIGH -> LOW</option>
                    <option value="asc">DICE: LOW -> HIGH</option>
                </select>
            </div>
        </div>

        <div class="analysis-grid" id="analysis-grid"></div>
    </div>

    <div class="app-container">
        <div class="main-screen">
            <header class="screen-header">
                <div class="header-top">
                    <div style="display:flex; align-items:flex-end; gap:20px; flex:1;">
                        <div>
                            <div class="screen-title">TACTICAL LOG</div>
                            <div class="screen-status" id="status-text">WAITING FOR DATA...</div>
                        </div>
                        <div class="search-container">
                            <span style="font-family:'Orbitron'; color:var(--primary-color);">SEARCH:</span>
                            <input type="text" id="search-input" class="search-input" placeholder="Keyword...">
                        </div>
                    </div>
                    <button class="menu-toggle" id="menu-toggle" style="background:var(--bg-panel); border:1px solid var(--primary-color); color:var(--primary-color); padding:5px;">CONFIG</button>
                </div>
                <div class="tab-filters" id="tab-filters"></div>
            </header>

            <div class="chat-scroll-area" id="chat-area">
                <div class="chat-list" id="chat-list"></div>
            </div>
        </div>

        <aside class="side-panel" id="side-panel">
            <div class="panel-header">
                <div>CONFIG</div>
                <div style="font-size:0.6rem; cursor:pointer;" id="close-panel">CLOSE [X]</div>
            </div>

            <div style="margin-bottom:15px;">
                <div style="font-size:0.7rem; color:#888; margin-bottom:5px;">THEME COLOR</div>
                <div class="theme-selector">
                    <div class="theme-btn" style="background:#00f3ff;" onclick="setTheme(180)"></div>
                    <div class="theme-btn" style="background:#0aff0a;" onclick="setTheme(120)"></div>
                    <div class="theme-btn" style="background:#ff003c;" onclick="setTheme(345)"></div>
                    <div class="theme-btn" style="background:#d600ff;" onclick="setTheme(280)"></div>
                </div>
            </div>

            <div style="margin-bottom:20px;">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; margin-bottom:10px; font-size:0.85rem;">
                    <input type="checkbox" id="remove-brackets"> Remove „Äå„Äç
                </label>
                <button id="refresh-btn" style="width:100%; background:rgba(255,255,255,0.1); border:1px solid var(--primary-color); color:var(--primary-color); padding:8px; cursor:pointer; font-family:'Orbitron'; margin-bottom:10px;">
                    REFRESH VIEW
                </button>
                <button id="growth-scan-btn" class="scan-btn">‚ö†Ô∏è ANALYSIS MODE</button>
                <button id="capture-btn" class="capture-btn">üì∏ CAPTURE LOG</button>
                <button id="capture-vis-btn" class="capture-btn" style="margin-top:5px; border-color:var(--neon-purple); color:var(--neon-purple);">üëÅÔ∏è CAPTURE VIEW</button>
            </div>

            <div class="config-zones">
                <div class="drop-zone zone-left" data-pos="left">
                    <div class="zone-header">‚óÄ LEFT [ KP / GM ]</div>
                    <div class="zone-content" id="list-left"></div>
                </div>
                <div class="drop-zone zone-center" data-pos="center">
                    <div class="zone-header">‚óè CENTER [ SYSTEM ]</div>
                    <div class="zone-content" id="list-center"></div>
                </div>
                <div class="drop-zone zone-right" data-pos="right">
                    <div class="zone-header">RIGHT [ PC ] ‚ñ∂</div>
                    <div class="zone-content" id="list-right"></div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        const INIT_DB = {
            "ÁõÆÊòü":25, "ËÅû„ÅçËÄ≥":25, "Âõ≥Êõ∏È§®":25, "ÂøúÊÄ•ÊâãÂΩì":30, "„Åì„Å∂„Åó":50, "„Ç≠„ÉÉ„ÇØ":25, "ÁµÑ„Åø‰ªò„Åç":25, "È†≠Á™Å„Åç":10,
            "Êã≥ÈäÉ":20, "„Çµ„Éñ„Éû„Ç∑„É≥„Ç¨„É≥":15, "„Ç∑„Éß„ÉÉ„Éà„Ç¨„É≥":30, "„É©„Ç§„Éï„É´":25, "„Éû„Ç∑„É≥„Ç¨„É≥":15, "ÊäïÊì≤":25, 
            "Èö†„Çå„Çã":10, "Âøç„Å≥Ê≠©„Åç":10, "ËøΩË∑°":10, "ÁôªÊîÄ":40, "Ê∞¥Ê≥≥":25, "Ë∑≥Ë∫ç":25, "ÈÅãËª¢":20, "Ê©üÊ¢∞‰øÆÁêÜ":20, 
            "ÈõªÊ∞ó‰øÆÁêÜ":10, "ÂåªÂ≠¶":5, "„Ç™„Ç´„É´„Éà":5, "„ÇØ„Éà„Ç•„É´„ÉïÁ•ûË©±":0, "Ëä∏Ë°ì":5, "ÁµåÁêÜ":10, "ÂøÉÁêÜÂ≠¶":5, 
            "ÁîüÁâ©Â≠¶":1, "Âú∞Ë≥™Â≠¶":1, "ÈõªÂ≠êÂ∑•Â≠¶":1, "Â§©ÊñáÂ≠¶":1, "ÂçöÁâ©Â≠¶":10, "Áâ©ÁêÜÂ≠¶":1, "Ê≥ïÂæã":5, "Ëñ¨Â≠¶":1, 
            "Ê≠¥Âè≤":20, "Ë®Ä„ÅÑ„Åè„Çã„ÇÅ":5, "‰ø°Áî®":15, "Ë™¨Âæó":15, "ÂÄ§Âàá„Çä":5, "ÈáçÊ©üÊ¢∞Êìç‰Ωú":5, "Á≤æÁ•ûÂàÜÊûê":1, 
            "ËÄÉÂè§Â≠¶":1, "‰∫∫È°ûÂ≠¶":1, "Â§âË£Ö":1, "„Éä„Éì„Ç≤„Éº„Éà":10, "Èö†„Åô":15, "ÂÜôÁúüË°ì":10, "‰πóÈ¶¨":5, "Ë£Ω‰Ωú":5, 
            "ÊìçÁ∏¶":1, "ÂåñÂ≠¶":1, "ÈçµÈñã„Åë":1, "ÊØçÂõΩË™û": 55, "ÂõûÈÅø": 32 
        };

        function normalizeText(str) {
            if (!str) return "";
            return str.replace(/[ÔºÅ-ÔΩû]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            }).replace(/„ÄÄ/g, " ").toLowerCase(); 
        }

        let rawLogData = [];
        let charConfig = {}; 
        let currentTab = 'ALL';
        let uniqueTabs = new Set();

        const uploadBox = document.getElementById('upload-box');
        const fileInput = document.getElementById('file-input');
        const chatList = document.getElementById('chat-list');
        const uploadOverlay = document.getElementById('upload-overlay');
        const statusText = document.getElementById('status-text');
        const tabFilters = document.getElementById('tab-filters');
        
        const listLeft = document.getElementById('list-left');
        const listCenter = document.getElementById('list-center');
        const listRight = document.getElementById('list-right');
        
        const searchInput = document.getElementById('search-input');
        const captureBtn = document.getElementById('capture-btn');
        const captureVisBtn = document.getElementById('capture-vis-btn');

        // --- Window Load (Fonts & Assets) ---
        // „Åô„Åπ„Å¶„ÅÆË™≠„ÅøËæº„Åø„ÅåÁµÇ„Çè„Å£„Å¶„Åã„Çâ„ÄÅÂ∞ë„ÅóÂæÖÊ©ü„Åó„Å¶„É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÇíÊ∂à„Åô
        window.addEventListener('load', () => {
            const bootLoader = document.getElementById('boot-loader');
            // ÊºîÂá∫„Å®„Åó„Å¶1.5ÁßíÂæÖÊ©ü
            setTimeout(() => {
                bootLoader.classList.add('fade-out');
            }, 1500);
        });

        uploadBox.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', e => loadFile(e.target.files[0]));
        document.body.addEventListener('dragover', e => e.preventDefault());
        document.body.addEventListener('drop', e => {
            e.preventDefault();
            if(!uploadOverlay.classList.contains('hidden') && e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);
        });

        // Search Function
        searchInput.addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.message-row');
            rows.forEach(row => {
                if(row.innerText.toLowerCase().includes(keyword)) {
                    row.classList.remove('filtered');
                } else {
                    row.classList.add('filtered');
                }
            });
        });

        // --- Capture Function (FULL LOG) ---
        captureBtn.addEventListener('click', () => {
            statusText.innerText = "CAPTURING...";
            const target = chatList;
            
            html2canvas(target, {
                backgroundColor: '#02050a',
                scale: 2, 
                useCORS: true, 
                allowTaint: false,
                scrollX: 0,
                scrollY: 0,
                height: target.scrollHeight, // ÂÖ®‰Ωì„ÇíÊíÆÂΩ±
                windowHeight: target.scrollHeight, 
                imageTimeout: 15000,
                onclone: (clonedDoc) => {
                    const clonedNode = clonedDoc.getElementById('chat-list');
                    if (clonedNode) {
                        clonedNode.style.height = 'auto';
                        clonedNode.style.overflow = 'visible';
                    }
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `TACTICAL_LOG_FULL_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                statusText.innerText = "CAPTURE COMPLETE";
                setTimeout(() => statusText.innerText = "SYSTEM ONLINE", 2000);
            }).catch(err => {
                console.error(err);
                statusText.innerText = "CAPTURE ERROR";
                alert("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
            });
        });

        // --- Capture Function (VISIBLE VIEW ONLY) ---
        captureVisBtn.addEventListener('click', () => {
            statusText.innerText = "CAPTURING VIEW...";
            
            // ‰øÆÊ≠£: „Çø„Éº„Ç≤„ÉÉ„Éà„ÇíË¶™„Ç®„É™„Ç¢„Åß„ÅØ„Å™„Åè„Äå‰∏≠Ë∫´(chatList)„Äç„Å´Â§âÊõ¥
            const target = chatList;
            const scrollContainer = document.getElementById('chat-area');
            
            // ÁèæÂú®„ÅÆ„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Å®Ë°®Á§∫È´ò„Åï„ÇíÂèñÂæó
            const scrollTop = scrollContainer.scrollTop;
            const viewHeight = scrollContainer.clientHeight;
            const targetWidth = target.offsetWidth;

            html2canvas(target, {
                backgroundColor: '#02050a',
                scale: 2, 
                useCORS: true, 
                allowTaint: false,
                // „ÄêÈáçË¶Å„Äë‰∏≠Ë∫´„Çí„Çø„Éº„Ç≤„ÉÉ„Éà„Å´„Åó„Å§„Å§„ÄÅ„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Åß„Éà„É™„Éü„É≥„Ç∞„Åô„Çã
                y: scrollTop, 
                height: viewHeight,
                width: targetWidth,
                windowWidth: targetWidth,
                imageTimeout: 15000
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `TACTICAL_LOG_VIEW_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                statusText.innerText = "CAPTURE COMPLETE";
                setTimeout(() => statusText.innerText = "SYSTEM ONLINE", 2000);
            }).catch(err => {
                console.error(err);
                statusText.innerText = "CAPTURE ERROR";
                alert("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
            });
        });

        function loadFile(file) {
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                parseHTML(e.target.result);
                initAutoConfig();
                setupTabs();
                renderConfigPanel();
                renderLogs();
                uploadOverlay.classList.add('hidden');
                statusText.innerText = "SYSTEM ONLINE";
            };
            reader.readAsText(file);
        }

        function parseHTML(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const paragraphs = doc.querySelectorAll('body > p');
            rawLogData = [];
            uniqueTabs.clear();

            paragraphs.forEach(p => {
                const color = p.style.color || '#888888';
                const spans = p.querySelectorAll('span');
                if(spans.length < 2) return;
                
                const tab = spans[0].textContent.trim().replace(/[\[\]]/g, '');
                uniqueTabs.add(tab);

                let name = spans.length >= 2 ? spans[1].textContent.trim() : '???';
                let rawText = "";
                
                if(spans.length >= 3) {
                    // „Äê‰øÆÊ≠£„ÄëÊîπË°å„Çí‰øùÊåÅ„Åô„Çã„Åü„ÇÅ„ÅÆÂá¶ÁêÜ
                    // innerHTML„ÇíÂèñÂæó„Åó„ÄÅ<br>„Çø„Ç∞„ÇíÊîπË°å„Ç≥„Éº„Éâ„Å´ÁΩÆÊèõ„Åó„Å¶„Åã„Çâ„ÉÜ„Ç≠„Çπ„ÉàÂåñ„Åô„Çã
                    let htmlContent = spans[2].innerHTML;
                    htmlContent = htmlContent.replace(/<br\s*\/?>/gi, '\n');
                    
                    // ‰∏ÄÊôÇÁöÑ„Å™Ë¶ÅÁ¥†„Çí‰Ωú„Å£„Å¶„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„ÅøÊäΩÂá∫Ôºà„Çø„Ç∞Èô§ÂéªÔºâ
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = htmlContent;
                    rawText = tempDiv.textContent; 
                } else {
                    rawText = p.innerText; 
                }
                
                // trim()„ÅßÂâçÂæå„ÅÆÁ©∫ÁôΩ„ÅØÊ∂à„Åô„Åå„ÄÅ‰∏≠„ÅÆ\n„ÅØÊÆã„Çã
                let text = rawText.trim(); 
                
                if(name.endsWith(' :')) name = name.slice(0, -2);
                if(name.toLowerCase() === 'kp') name = 'KP';
                if(name.toLowerCase() === 'gm') name = 'GM'; 

                rawLogData.push({ tab, name, color, text });
            });
        }

        function initAutoConfig() {
            rawLogData.forEach(log => {
                if(!charConfig[log.name]) {
                    let pos = 'right'; 
                    // Both KP and GM go to LEFT
                    if(log.name === 'KP' || log.name === 'GM') pos = 'left';
                    if(log.name === 'system' || log.name === 'System') pos = 'center';
                    charConfig[log.name] = { position: pos, color: log.color, icon: null, visible: true };
                }
            });
        }

        function setupTabs() {
            tabFilters.innerHTML = '';
            const allBtn = document.createElement('button');
            allBtn.className = 'tab-btn active';
            allBtn.innerText = 'ALL';
            allBtn.onclick = () => filterTab('ALL', allBtn);
            tabFilters.appendChild(allBtn);

            uniqueTabs.forEach(tab => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.innerText = tab;
                btn.onclick = () => filterTab(tab, btn);
                tabFilters.appendChild(btn);
            });
        }

        function filterTab(tab, btn) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderLogs();
        }

        function renderConfigPanel() {
            listLeft.innerHTML = ''; listCenter.innerHTML = ''; listRight.innerHTML = '';
            for(const name in charConfig) {
                const conf = charConfig[name];
                const tag = createCharTag(name, conf);
                if(conf.position === 'left') listLeft.appendChild(tag);
                else if(conf.position === 'center') listCenter.appendChild(tag);
                else listRight.appendChild(tag);
            }
        }

        function createCharTag(name, conf) {
            const div = document.createElement('div');
            div.className = `char-tag ${!conf.visible ? 'inactive' : ''}`;
            div.draggable = true;
            div.dataset.name = name;
            
            div.innerHTML = `
                <label class="vis-check" title="Toggle Display">
                    <input type="checkbox" class="vis-input" ${conf.visible ? 'checked' : ''}>
                    <span class="checkmark"></span>
                </label>
                <span style="font-weight:bold;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:80px;">${name}</span>
                <div style="margin-left:auto; display:flex; gap:4px;">
                    <input type="color" class="mini-color" value="${rgbToHex(conf.color)}">
                    <label class="mini-btn">üì∑<input type="file" style="display:none" class="mini-file" accept="image/*"></label>
                </div>
            `;
            div.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', name); div.style.opacity = '0.5'; });
            div.addEventListener('dragend', () => div.style.opacity = '1');
            div.querySelector('.vis-input').addEventListener('change', e => {
                conf.visible = e.target.checked;
                if(conf.visible) div.classList.remove('inactive'); else div.classList.add('inactive');
                renderLogs();
            });
            div.querySelector('.mini-color').addEventListener('change', e => { conf.color = e.target.value; renderLogs(); });
            div.querySelector('.mini-file').addEventListener('change', e => {
                const f = e.target.files[0];
                if(f) { const r = new FileReader(); r.onload = ev => { conf.icon = ev.target.result; renderLogs(); }; r.readAsDataURL(f); }
            });
            return div;
        }

        [listLeft, listCenter, listRight].forEach(zone => {
            const parent = zone.parentElement;
            parent.addEventListener('dragover', e => { e.preventDefault(); parent.style.borderColor = '#fff'; });
            parent.addEventListener('dragleave', () => parent.style.borderColor = '');
            parent.addEventListener('drop', e => {
                e.preventDefault(); parent.style.borderColor = '';
                const name = e.dataTransfer.getData('text/plain');
                if(charConfig[name]) { charConfig[name].position = parent.dataset.pos; renderConfigPanel(); renderLogs(); }
            });
        });

        document.getElementById('refresh-btn').addEventListener('click', renderLogs);
        const removeBrackets = document.getElementById('remove-brackets');

        function renderLogs() {
            chatList.innerHTML = '';
            const shouldRemoveBrackets = removeBrackets.checked;
            const fragment = document.createDocumentFragment();

            rawLogData.forEach((log, i) => {
                if(currentTab !== 'ALL' && log.tab !== currentTab) return;
                const conf = charConfig[log.name] || {};
                if (conf.visible === false) return;

                let message = log.text;
                const normText = normalizeText(message);
                
                let pos = conf.position || 'right';
                const isDice = (normText.match(/ccb|1d\d|res|x\d|\d+d\d/) !== null);
                if(isDice) pos = 'center'; 
                
                if(shouldRemoveBrackets && pos !== 'center' && pos !== 'left') {
                    message = message.replace(/^„Äå/, '').replace(/„Äç$/, '').replace(/„Äç\n/, '\n');
                }

                // ÊîπË°å„Ç≥„Éº„Éâ„ÇíHTML„ÅÆ<br>„Å´Êàª„Åó„Å¶Ë°®Á§∫
                message = message.replace(/\n/g, '<br>');

                const row = document.createElement('div');
                row.className = `message-row pos-${pos}`;
                const hexColor = conf.color;
                const bgTint = hexToRgba(hexColor, 0.15); 
                
                row.style.setProperty('--char-bg-tint', bgTint);
                row.style.setProperty('--char-border', hexColor);
                row.style.setProperty('--char-border-solid', hexColor);
                row.style.setProperty('--char-text-color', hexColor);

                if(pos === 'left') {
                    row.innerHTML = `<div class="message-content"><div class="char-info">‚ñ∂ ${log.name}</div><div class="bubble">${message}</div></div>`;
                } else if(pos === 'center') {
                    if(isDice) {
                        message = message.replace(/(CCB.*?)(Ôºû)/ig, '<span style="color:#aaa;">$1</span> $2')
                                         .replace(/(\d+)(Ôºû)/g, '<span style="font-weight:bold; color:var(--primary-color);">$1</span> $2')
                                         .replace(/(ÊàêÂäü|Ê±∫ÂÆöÁöÑÊàêÂäü|„Çπ„Éö„Ç∑„É£„É´)/g, '<span class="res-success">$1</span>')
                                         .replace(/(Â§±Êïó|Ëá¥ÂëΩÁöÑÂ§±Êïó|„Éï„Ç°„É≥„Éñ„É´)/g, '<span class="res-failure">$1</span>');
                    }
                    const label = (log.name !== 'system') ? `<div class="actor-label" style="border-color:${hexColor}; color:${hexColor}">${log.name}</div>` : '';
                    row.innerHTML = `<div class="message-content"><div style="position:relative; display:inline-block;">${label}<div class="bubble" style="border-color:${hexColor}; color:${hexColor}">${message}</div></div></div>`;
                } else {
                    let avatar = conf.icon ? `<img src="${conf.icon}">` : `<span>${log.name.charAt(0)}</span>`;
                    let avatarStyle = `border-color:${hexColor}; box-shadow:0 0 5px ${hexColor};`;
                    row.innerHTML = `<div class="avatar" style="${avatarStyle}">${avatar}</div><div class="message-content"><div class="char-info" style="color:${hexColor}; text-shadow:0 0 5px ${hexColor};">${log.name}</div><div class="bubble">${message}</div></div>`;
                }
                
                if(i < 30) row.style.animationDelay = `${i * 0.02}s`; else row.style.animationDelay = '0s';
                fragment.appendChild(row);
            });
            chatList.appendChild(fragment);
        }

        const growthModal = document.getElementById('growth-modal');
        const analysisGrid = document.getElementById('analysis-grid');
        
        // ‰øÆÊ≠£ÁâàÔºö„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„Åç„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.getElementById('growth-scan-btn').addEventListener('click', () => {
            const modal = document.getElementById('growth-modal');
            const loader = document.getElementById('hud-loader');
            const grid = document.getElementById('analysis-grid');
            
            // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            modal.classList.remove('hidden');
            
            // „É≠„Éº„ÉÄ„Éº„ÇíË°®Á§∫„Åó„ÄÅ„Ç∞„É™„ÉÉ„Éâ„ÇíÈö†„Åô
            loader.classList.remove('hidden');
            grid.style.opacity = '0'; // ‰∏ÄÁû¨Èö†„Åô

            // 1.2ÁßíÂæå„Å´Ëß£ÊûêÁµêÊûú„ÇíË°®Á§∫Ôºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÊºîÂá∫Ôºâ
            setTimeout(() => {
                analyzeGrowth(); // Ëß£ÊûêÂÆüË°å
                
                // „É≠„Éº„ÉÄ„Éº„ÇíÈö†„Åó„Å¶„Ç∞„É™„ÉÉ„Éâ„ÇíË°®Á§∫
                loader.classList.add('hidden');
                grid.style.opacity = '1';
                
                // „Ç´„Éº„Éâ„Å´È†ÜÁï™„Å´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈÅÖÂª∂„Çí„Å§„Åë„ÇãÊºîÂá∫
                const cards = document.querySelectorAll('.char-card');
                cards.forEach((card, index) => {
                    card.style.animationDelay = `${index * 0.1}s`;
                });
                
            }, 1200); // 1.2ÁßíÂæÖÊ©ü
        });
        
        document.getElementById('close-modal').addEventListener('click', () => growthModal.classList.add('hidden'));
        
        ['chk-crit', 'chk-fumble', 'chk-special', 'chk-init', 'chk-success', 'chk-failure', 'chk-stats', 'sort-order', 'dice-target'].forEach(id => {
            document.getElementById(id).addEventListener('change', analyzeGrowth);
            if(id === 'dice-target') document.getElementById(id).addEventListener('input', analyzeGrowth);
        });

        function analyzeGrowth() {
            analysisGrid.innerHTML = '';
            const results = {};
            const skillCounts = {}; 

            // „Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö„ÅÆÂèñÂæó
            const showCrit = document.getElementById('chk-crit').checked;
            const showFumble = document.getElementById('chk-fumble').checked;
            const showSpecial = document.getElementById('chk-special').checked;
            const showInit = document.getElementById('chk-init').checked;
            const showSuccess = document.getElementById('chk-success').checked;
            const showFailure = document.getElementById('chk-failure').checked;
            const showStats = document.getElementById('chk-stats').checked; 
            const diceTarget = document.getElementById('dice-target').value;
            const sortOrder = document.getElementById('sort-order').value;

            rawLogData.forEach(log => {
                // 1. Èô§Â§ñÂØæË±°Ôºö„Ç∑„Çπ„ÉÜ„É†„ÄÅKP„ÄÅGM
                if(log.name === 'system' || log.name === 'KP' || log.name === 'GM') return;

                // 2. Èô§Â§ñÂØæË±°Ôºö„Çµ„Ç§„Éâ„Éê„Éº„ÅßÈùûË°®Á§∫„Å´„Åó„Å¶„ÅÑ„Çã„Ç≠„É£„É©
                if(charConfig[log.name] && !charConfig[log.name].visible) return;
                
                // „Éá„Éº„ÇøÂàùÊúüÂåñ
                if(!results[log.name]) {
                    results[log.name] = { logs: [] };
                    skillCounts[log.name] = {};
                }

                const text = log.text;
                const normText = normalizeText(text); 
                
                // 3. Âà§ÂÆöÂØæË±°„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàCCB „Åæ„Åü„ÅØ 1d100 „ÅåÂê´„Åæ„Çå„Çã„ÅãÔºâ
                const isDiceRoll = normText.includes("ccb") || normText.includes("1d100");

                if(isDiceRoll) {
                    // --- ÊäÄËÉΩÂêç„ÅÆÊäΩÂá∫ ---
                    const skillMatch = text.match(/[„ÄêÔºª\[\(Ôºà](.+?)[\]ÔºΩ„Äë\)Ôºâ]/);
                    if(skillMatch) {
                        const skill = skillMatch[1];
                        if(!skillCounts[log.name][skill]) skillCounts[log.name][skill] = 0;
                        skillCounts[log.name][skill]++;
                    }

                    // --- ÊàêÂäü/Â§±ÊïóÂà§ÂÆö ---
                    let type = null;
                    
                    if(normText.includes("Ê±∫ÂÆöÁöÑÊàêÂäü") || normText.includes("„ÇØ„É™„ÉÜ„Ç£„Ç´„É´")) type = "crit";
                    else if(normText.includes("„Éï„Ç°„É≥„Éñ„É´") || normText.includes("Ëá¥ÂëΩÁöÑÂ§±Êïó")) type = "fumble";
                    else if(normText.includes("„Çπ„Éö„Ç∑„É£„É´")) type = "special";
                    else if(normText.includes("ÊàêÂäü")) type = "success";
                    else if(normText.includes("Â§±Êïó")) type = "failure";

                    // „ÉÄ„Ç§„ÇπÂÄ§„ÅÆÊäΩÂá∫ (‰æã: > 15)
                    let diceVal = 0;
                    const diceMatch = normText.match(/>\s*(\d+)\s*(>|$)/);
                    if (diceMatch) diceVal = parseInt(diceMatch[1]);
                    
                    // „ÉÄ„Ç§„ÇπÂÄ§„Éï„Ç£„É´„Çø„Éº (ÊåáÂÆö„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø)
                    if (diceTarget && diceVal != diceTarget) return; // typeÂà§ÂÆö„ÅÆÂâç„Å´Êäú„Åë„Çã

                    let isInitSuccess = false;
                    
                    // ÂàùÊúüÂÄ§ÊàêÂäü„ÅÆÂà§ÂÆö
                    if(type === 'success' || type === 'crit' || type === 'special') {
                        const targetMatch = normText.match(/(?:<=|‚â§)(\d+)/);
                        if (targetMatch) {
                            const targetVal = parseInt(targetMatch[1]);
                            for (const [skillName, initVal] of Object.entries(INIT_DB)) {
                                if (initVal === targetVal && normText.includes(skillName.toLowerCase())) {
                                    isInitSuccess = true;
                                    break;
                                }
                            }
                        }
                    }

                    // Ë°®Á§∫„Åô„Çã„Åã„Å©„ÅÜ„Åã„ÅÆÂà§ÂÆö
                    let show = false;
                    if(type === 'crit' && showCrit) show = true;
                    else if(type === 'fumble' && showFumble) show = true;
                    else if(type === 'special' && showSpecial) show = true;
                    else if(type === 'success' && showSuccess && !isInitSuccess) show = true;
                    else if(type === 'failure' && showFailure) show = true;
                    else if(isInitSuccess && showInit) show = true;

                    // „É≠„Ç∞„É™„Çπ„Éà„Å´ËøΩÂä†
                    if(show && type) {
                        let cssClass = '';
                        let label = '';
                        
                        if(type === 'crit') { 
                            cssClass = 'is-crit'; 
                            label = '<span class="log-label" style="color:var(--neon-cyan)">‚òÖ CRIT</span>'; 
                        }
                        else if(type === 'fumble') { 
                            cssClass = 'is-fumble'; 
                            label = '<span class="log-label" style="color:var(--neon-alert)">‚ò† FUMB</span>'; 
                        }
                        else if(type === 'special') { 
                            cssClass = 'is-special'; 
                            label = '<span class="log-label" style="color:var(--neon-purple)">‚ú¶ SPEC</span>'; 
                        }
                        else if(type === 'success') { 
                            cssClass = 'is-success'; 
                            label = '<span class="log-label" style="color:var(--neon-green)">‚úî OK</span>'; 
                        }
                        else if(type === 'failure') { 
                            cssClass = 'is-failure'; 
                            label = '<span class="log-label" style="color:#888">‚úò FAIL</span>'; 
                        }

                        if(isInitSuccess) {
                            cssClass = 'is-init'; 
                            label += ' <span class="log-label" style="color:var(--neon-orange)">[INIT]</span>';
                        }

                        results[log.name].logs.push({ cssClass, label, fullText: log.text, dice: diceVal });
                    }
                }
            });

            // --- „Ç´„Éº„ÉâÁîüÊàêÂá¶ÁêÜ ---
            let hasContent = false;

            for(const name in results) {
                const data = results[name];
                const skillData = skillCounts[name] || {};
                const hasLogs = data.logs.length > 0;
                const hasSkills = Object.keys(skillData).length > 0;

                if (!hasLogs && (!showStats || !hasSkills)) continue;

                hasContent = true;

                if(sortOrder === 'desc') data.logs.sort((a,b) => b.dice - a.dice);
                if(sortOrder === 'asc') data.logs.sort((a,b) => a.dice - b.dice);

                const card = document.createElement('div');
                card.className = 'char-card';
                
                // È†ªÂá∫„Çπ„Ç≠„É´„É©„É≥„Ç≠„É≥„Ç∞„ÅÆHTMLÁîüÊàê
                let statsHTML = '';
                if(showStats && hasSkills) {
                    const sortedSkills = Object.entries(skillData).sort((a,b) => b[1] - a[1]);
                    if(sortedSkills.length > 0) {
                        statsHTML = '<div class="stat-grid">';
                        statsHTML += `<div style="grid-column:1/-1; color:#888; font-size:0.7rem; border-bottom:1px solid #444; margin-bottom:4px;">SKILL USAGE (TOP 5)</div>`;
                        sortedSkills.slice(0, 5).forEach(([skill, count]) => {
                             statsHTML += `<div class="stat-item"><span>${skill}</span> <span style="color:var(--neon-green)">${count}</span></div>`;
                        });
                        statsHTML += '</div>';
                    }
                }

                let logHTML = '';
                if (!hasLogs) {
                    logHTML = '<div style="padding:10px; color:#555; text-align:center;">NO MATCHES</div>';
                } else {
                    data.logs.forEach(item => {
                        logHTML += `<div class="log-item ${item.cssClass}">${item.label} ${item.fullText}</div>`;
                    });
                }

                card.innerHTML = `<div class="card-header">${name}</div>${statsHTML}<div class="log-section">${logHTML}</div>`;
                analysisGrid.appendChild(card);
            }

            if(!hasContent) {
                analysisGrid.innerHTML = '<div style="color:#888; grid-column:1/-1; text-align:center; padding:50px;">NO DATA FOUND WITH CURRENT FILTERS.</div>';
            }
        }

        function setTheme(hue) {
            document.documentElement.style.setProperty('--theme-hue', hue);
        }

        function rgbToHex(col) {
            if(!col) return '#888888';
            if(col.startsWith('#')) return col;
            return col;
        }

        function hexToRgba(hex, alpha) {
            if (!hex) return `rgba(136,136,136,${alpha})`;
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex.substring(1, 3), 16);
                g = parseInt(hex.substring(3, 5), 16);
                b = parseInt(hex.substring(5, 7), 16);
            }
            return `rgba(${r},${g},${b},${alpha})`;
        }

        const sidePanel = document.getElementById('side-panel');
        document.getElementById('menu-toggle').addEventListener('click', () => sidePanel.classList.add('open'));
        document.getElementById('close-panel').addEventListener('click', () => sidePanel.classList.remove('open'));

    </script>
</body>
</html>