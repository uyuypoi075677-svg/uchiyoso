<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Label Maker</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè∑Ô∏è</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Hina+Mincho&family=Noto+Sans+JP:wght@400;700;900&family=Rampart+One&family=Yuji+Syuku&family=Zen+Maru+Gothic:wght@500;700&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #111827; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }
        .bg-pattern-grid {
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), 
                              linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #ccc 75%), 
                              linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #fff;
        }
        .bg-pattern-dark { background-color: #1f2937; }
        .bg-pattern-white { background-color: #ffffff; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #374151; }
        ::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 4px; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 24px; height: 24px; border-radius: 4px; overflow: hidden; cursor: pointer; padding: 0; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; }
        input[type=range] { height: 4px; border-radius: 2px; accent-color: #3b82f6; }
        .shape-btn.active { @apply ring-2 ring-blue-500 bg-blue-50 text-blue-700 border-blue-200; }
        .advanced-toggle { cursor: pointer; user-select: none; }
        .advanced-content { display: none; }
        .advanced-content.open { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .radio-label input:checked + div { @apply bg-blue-600 text-white border-blue-600; }
        .template-btn:hover, .pattern-btn:hover { transform: translateY(-2px); }
        .pattern-btn { position: relative; }
        .pattern-btn .delete-btn { display: none; }
        .pattern-btn:hover .delete-btn { display: flex; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <div id="loadingOverlay" class="fixed inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
        <div class="text-white text-sm tracking-widest animate-pulse">LOADING...</div>
    </div>
    <header class="bg-gray-800 text-white px-4 py-3 border-b border-gray-700 flex justify-between items-center shadow-md z-20 h-14">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-1 rounded-lg text-white shadow-lg flex items-center justify-center w-8 h-8">
                <span class="material-symbols-outlined text-xl">label_important</span>
            </div>
            <h1 class="text-lg font-bold tracking-wide">Label Maker <span class="text-xs bg-gray-700 px-2 py-0.5 rounded text-indigo-300 ml-1">PRO</span></h1>
        </div>
        <div class="text-xs text-gray-400 hidden sm:block">Chocolat Mer</div>
    </header>

    <div class="flex flex-1 overflow-hidden bg-gray-900">
        
        <aside class="w-80 bg-white flex flex-col border-r border-gray-700 overflow-y-auto scrollbar-thin shadow-2xl z-10">
            <div class="p-5 space-y-8 pb-32">

                <section>
                    <h3 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider flex items-center"><span class="material-symbols-outlined text-sm mr-1">shapes</span>ÂΩ¢Áä∂„Éª„Çµ„Ç§„Ç∫</h3>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <button class="shape-btn active border border-gray-200 rounded p-2 flex flex-col items-center transition hover:bg-gray-50" data-shape="ribbon-simple">
                            <span class="material-symbols-outlined mb-1 transform rotate-180">bookmark_border</span><span class="text-[10px]">V„É™„Éú„É≥</span>
                        </button>
                         <button class="shape-btn border border-gray-200 rounded p-2 flex flex-col items-center transition hover:bg-gray-50" data-shape="ribbon-double">
                            <span class="material-symbols-outlined mb-1">layers</span><span class="text-[10px]">‰∫åÈáç„É™„Éú„É≥</span>
                        </button>
                        <button class="shape-btn border border-gray-200 rounded p-2 flex flex-col items-center transition hover:bg-gray-50" data-shape="ribbon-horizontal">
                            <span class="material-symbols-outlined mb-1">label_important</span><span class="text-[10px]">Ê®™„É™„Éú„É≥</span>
                        </button>
                        <button class="shape-btn border border-gray-200 rounded p-2 flex flex-col items-center transition hover:bg-gray-50" data-shape="tag-rect">
                            <span class="material-symbols-outlined mb-1">rectangle</span><span class="text-[10px]">Èï∑ÊñπÂΩ¢</span>
                        </button>
                        <button class="shape-btn border border-gray-200 rounded p-2 flex flex-col items-center transition hover:bg-gray-50" data-shape="tag-left">
                            <span class="material-symbols-outlined mb-1 transform rotate-90">label</span><span class="text-[10px]">„Çø„Ç∞(Â∑¶)</span>
                        </button>
                        <button class="shape-btn border border-gray-200 rounded p-2 flex flex-col items-center transition hover:bg-gray-50" data-shape="tag-right">
                            <span class="material-symbols-outlined mb-1 transform -rotate-90">label</span><span class="text-[10px]">„Çø„Ç∞(Âè≥)</span>
                        </button>
                    </div>

                    <div class="flex flex-col gap-2 px-1 mb-3">
                        <label class="flex items-center text-xs text-gray-600 cursor-pointer select-none">
                            <input type="checkbox" id="showHole" class="rounded text-blue-600 mr-1.5 focus:ring-blue-500" checked>
                            „Çø„Ç∞„ÅÆÁ©¥„ÇíË°®Á§∫ („Çø„Ç∞Áî®)
                        </label>
                        <label class="flex items-center text-xs text-gray-600 cursor-pointer select-none">
                            <input type="checkbox" id="isRounded" class="rounded text-blue-600 mr-1.5 focus:ring-blue-500">
                            Ëßí„Çí‰∏∏„Åè„Åô„Çã (Èï∑ÊñπÂΩ¢Áî®)
                        </label>
                    </div>

                    <div class="bg-indigo-50 border border-indigo-100 rounded p-2">
                        <div class="flex justify-between text-[10px] text-indigo-800 mb-1 font-bold">
                            <span>ÂÖ®‰Ωì„Çµ„Ç§„Ç∫ (Êã°Â§ß/Á∏ÆÂ∞è)</span>
                            <span id="globalScaleVal">100%</span>
                        </div>
                        <input type="range" id="globalScale" min="50" max="150" value="100" class="w-full h-1 bg-indigo-200 rounded-lg accent-indigo-600">
                    </div>
                </section>

                <hr class="border-gray-300">

                <section>
                    <h3 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider flex items-center"><span class="material-symbols-outlined text-sm mr-1">palette</span>„Ç´„É©„Éº</h3>
                    
                    <div class="flex gap-2 mb-3">
                        <label class="radio-label flex-1 cursor-pointer">
                            <input type="radio" name="colorMode" value="single" class="hidden" checked>
                            <div class="text-[10px] border border-gray-200 rounded py-1 text-center transition hover:bg-gray-50">ÂçòËâ≤</div>
                        </label>
                        <label class="radio-label flex-1 cursor-pointer">
                            <input type="radio" name="colorMode" value="gradient" class="hidden">
                            <div class="text-[10px] border border-gray-200 rounded py-1 text-center transition hover:bg-gray-50">„Ç∞„É©„Éá</div>
                        </label>
                        <label class="radio-label flex-1 cursor-pointer">
                            <input type="radio" name="colorMode" value="split" class="hidden">
                            <div class="text-[10px] border border-gray-200 rounded py-1 text-center transition hover:bg-gray-50">ÂàÜÂâ≤</div>
                        </label>
                    </div>

                    <div class="bg-gray-50 p-3 rounded border border-gray-200 relative mb-3">
                        <button id="randomColorBtn" class="absolute top-2 right-2 text-gray-400 hover:text-blue-500 transition" title="„É©„É≥„ÉÄ„É†"><span class="material-symbols-outlined text-sm">casino</span></button>
                        <div class="flex gap-4 items-center justify-center">
                            <div class="flex flex-col items-center"><span class="text-[10px] text-gray-500 mb-1">„É°„Ç§„É≥</span><input type="color" id="ribbonColor" value="#DC3535" class="shadow-sm"></div>
                            <span class="material-symbols-outlined text-gray-300 text-xs">arrow_forward</span>
                            <div class="flex flex-col items-center"><span class="text-[10px] text-gray-500 mb-1">„Çµ„Éñ</span><input type="color" id="ribbonColor2" value="#B91C1C" class="shadow-sm"></div>
                        </div>
                    </div>

                    <div id="splitPosContainer" class="px-1 transition-opacity duration-200">
                        <div class="flex justify-between text-[10px] text-gray-500 mb-1"><span>Ëâ≤„ÅÆÂ¢ÉÁïå„Éª‰∏≠ÂøÉ</span><span id="splitValDisplay">50%</span></div>
                        <input type="range" id="splitPos" min="0" max="100" value="50" class="w-full h-1 bg-gray-200 rounded-lg" disabled>
                    </div>
                </section>

                <hr class="border-gray-300">

                <section>
                    <h3 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider flex items-center"><span class="material-symbols-outlined text-sm mr-1">text_fields</span>„ÉÜ„Ç≠„Çπ„Éà</h3>
                    
                    <input type="text" id="labelText" value="Êñ∞ÂïÜÂìÅ" class="w-full border border-gray-300 rounded px-3 py-2 text-base font-bold mb-2 focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-300">
                    
                    <div class="flex gap-2 mb-3">
                        <select id="fontFamily" class="flex-1 border border-gray-300 rounded px-2 py-1.5 text-xs bg-white text-gray-700">
                            <option value="'Noto Sans JP', sans-serif">Noto Sans JP</option>
                            <option value="'Zen Maru Gothic', sans-serif">Zen Maru Gothic</option>
                            <option value="'Yuji Syuku', serif">Yuji Syuku</option>
                            <option value="'Hina Mincho', serif">Hina Mincho</option>
                            <option value="'DotGothic16', sans-serif">DotGothic16</option>
                            <option value="'Rampart One', cursive">Rampart One</option>
                        </select>
                        <div class="flex items-center gap-1 bg-gray-50 border border-gray-200 rounded px-2">
                            <input type="color" id="textColor" value="#FFFFFF" title="ÊñáÂ≠óËâ≤">
                            <div class="w-px h-4 bg-gray-300 mx-1"></div>
                            <input type="color" id="strokeColor" value="#000000" title="„Éï„ÉÅËâ≤">
                        </div>
                    </div>

                    <div class="advanced-toggle flex items-center justify-between text-xs text-blue-600 bg-blue-50 hover:bg-blue-100 px-2 py-1.5 rounded transition" onclick="toggleAdvanced('textAdvanced')">
                        <span>„Çµ„Ç§„Ç∫„Éª‰ΩçÁΩÆ„Éª„Éï„ÉÅË©≥Á¥∞</span>
                        <span class="material-symbols-outlined text-sm transition-transform duration-200" id="textAdvancedArrow">expand_more</span>
                    </div>
                    
                    <div id="textAdvanced" class="advanced-content pt-2 px-1">
                        <div class="grid grid-cols-2 gap-3 mb-2">
                            <div><span class="text-[10px] text-gray-500 block">„Çµ„Ç§„Ç∫</span><input type="range" id="fontSize" min="12" max="150" value="65" class="w-full"></div>
                            <div><span class="text-[10px] text-gray-500 block">ÊñáÂ≠óÈñìÈöî</span><input type="range" id="letterSpacing" min="-10" max="50" value="10" class="w-full"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-2">
                             <div><span class="text-[10px] text-gray-500 block">‰ΩçÁΩÆ X</span><input type="range" id="textOffsetX" min="-100" max="100" value="0" class="w-full"></div>
                             <div><span class="text-[10px] text-gray-500 block">‰ΩçÁΩÆ Y</span><input type="range" id="textOffsetY" min="-100" max="100" value="0" class="w-full"></div>
                        </div>
                        <div class="pt-2 border-t border-gray-100">
                             <span class="text-[10px] text-gray-500 block mb-1">„Éï„ÉÅ„ÅÆÂ§™„Åï</span><input type="range" id="strokeWidth" min="0" max="15" value="0" class="w-full h-1">
                        </div>
                    </div>
                </section>

                <hr class="border-gray-300">

                <section>
                    <h3 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider flex items-center"><span class="material-symbols-outlined text-sm mr-1">stars</span>„Ç¢„Ç§„Ç≥„É≥</h3>
                    
                    <div class="grid grid-cols-6 gap-2 mb-3">
                        <button class="icon-btn w-8 h-8 rounded border flex items-center justify-center bg-blue-50 border-blue-500 text-blue-600" data-icon="star"><span class="material-symbols-outlined text-base">star</span></button>
                        <button class="icon-btn w-8 h-8 rounded border flex items-center justify-center hover:bg-gray-100" data-icon="favorite"><span class="material-symbols-outlined text-base">favorite</span></button>
                        <button class="icon-btn w-8 h-8 rounded border flex items-center justify-center hover:bg-gray-100" data-icon="diamond"><span class="material-symbols-outlined text-base">diamond</span></button>
                        <button class="icon-btn w-8 h-8 rounded border flex items-center justify-center hover:bg-gray-100" data-icon="verified"><span class="material-symbols-outlined text-base">verified</span></button>
                        <button class="icon-btn w-8 h-8 rounded border flex items-center justify-center hover:bg-gray-100" data-icon="flag"><span class="material-symbols-outlined text-base">flag</span></button>
                        <button class="icon-btn w-8 h-8 rounded border flex items-center justify-center hover:bg-gray-100" data-icon="notifications"><span class="material-symbols-outlined text-base">notifications</span></button>
                        
                        <button class="icon-btn w-8 h-8 rounded border flex items-center justify-center hover:bg-gray-100" data-icon="shopping_cart"><span class="material-symbols-outlined text-base">shopping_cart</span></button>
                        <button class="icon-btn w-8 h-8 rounded border flex items-center justify-center hover:bg-gray-100" data-icon="edit"><span class="material-symbols-outlined text-base">edit</span></button>
                        <button class="icon-btn w-8 h-8 rounded border flex items-center justify-center hover:bg-gray-100" data-icon="person"><span class="material-symbols-outlined text-base">person</span></button>
                        <button class="icon-btn w-8 h-8 rounded border flex items-center justify-center hover:bg-gray-100" data-icon="home"><span class="material-symbols-outlined text-base">home</span></button>
                        <button class="icon-btn w-8 h-8 rounded border flex items-center justify-center hover:bg-gray-100" data-icon="settings"><span class="material-symbols-outlined text-base">settings</span></button>
                        <button class="icon-btn w-8 h-8 rounded border flex items-center justify-center hover:bg-red-50 hover:text-red-500 text-gray-400" data-icon="NONE" title="„Å™„Åó"><span class="material-symbols-outlined text-base">block</span></button>
                    </div>

                    <label class="flex items-center justify-center w-full py-2 mb-3 bg-gray-50 border border-dashed border-gray-300 rounded cursor-pointer hover:bg-blue-50 transition group">
                        <span class="material-symbols-outlined text-gray-400 group-hover:text-blue-500 text-sm mr-2">upload_file</span>
                        <span class="text-[10px] text-gray-600 group-hover:text-blue-600">ÁîªÂÉè / SVG „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</span>
                        <input type='file' id="imageUpload" class="hidden" accept="image/*,.svg" />
                    </label>

                    <div class="advanced-toggle flex items-center justify-between text-xs text-blue-600 bg-blue-50 hover:bg-blue-100 px-2 py-1.5 rounded transition" onclick="toggleAdvanced('iconAdvanced')">
                        <span>„Ç¢„Ç§„Ç≥„É≥„Çµ„Ç§„Ç∫„Éª‰ΩçÁΩÆË™øÊï¥</span>
                        <span class="material-symbols-outlined text-sm transition-transform duration-200" id="iconAdvancedArrow">expand_more</span>
                    </div>

                    <div id="iconAdvanced" class="advanced-content pt-2 px-1">
                        <div class="flex gap-3">
                            <div class="flex-1"><span class="text-[10px] text-gray-500 block">„Çµ„Ç§„Ç∫</span><input type="range" id="iconSize" min="20" max="150" value="70" class="w-full"></div>
                            <div class="flex-1"><span class="text-[10px] text-gray-500 block">Á∏¶‰ΩçÁΩÆ</span><input type="range" id="iconOffsetY" min="-100" max="100" value="0" class="w-full"></div>
                        </div>
                    </div>
                </section>

                <hr class="border-gray-300">

                <section>
                    <h3 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider flex items-center"><span class="material-symbols-outlined text-sm mr-1">brush</span>Ë£ÖÈ£æ„Éª„É©„Ç§„É≥</h3>
                    
                    <div class="bg-blue-50/50 p-2 rounded border border-blue-100 mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-bold text-gray-600">„Ç¢„ÇØ„Çª„É≥„Éà„É©„Ç§„É≥</span>
                            <input type="color" id="accentLineColor" value="#FFD700" class="w-5 h-5">
                        </div>
                        <div class="grid grid-cols-4 gap-1 text-[10px] mb-2">
                            <label class="radio-label cursor-pointer"><input type="radio" name="accentLineMode" value="none" class="hidden" checked><div class="border bg-white rounded py-1 text-center hover:bg-gray-50">„Å™„Åó</div></label>
                            <label class="radio-label cursor-pointer"><input type="radio" name="accentLineMode" value="straight" class="hidden"><div class="border bg-white rounded py-1 text-center hover:bg-gray-50">Áõ¥Á∑ö</div></label>
                            <label class="radio-label cursor-pointer"><input type="radio" name="accentLineMode" value="double" class="hidden"><div class="border bg-white rounded py-1 text-center hover:bg-gray-50">2Êú¨</div></label>
                            <label class="radio-label cursor-pointer"><input type="radio" name="accentLineMode" value="wavy" class="hidden"><div class="border bg-white rounded py-1 text-center hover:bg-gray-50">Ê≥¢Á∑ö</div></label>
                        </div>
                        <div id="accentAdvanced" class="hidden opacity-0 transition-opacity duration-300">
                             <div class="flex gap-2">
                                <div class="flex-1"><span class="text-[10px] text-gray-400 block" id="accentPosLabel">Á∏¶‰ΩçÁΩÆ</span><input type="range" id="accentLineY" min="0" max="100" value="20" class="w-full h-1"></div>
                                <div class="flex-1"><span class="text-[10px] text-gray-400 block">Â§™„Åï</span><input type="range" id="accentLineThickness" min="1" max="10" value="3" class="w-full h-1"></div>
                             </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between mb-2">
                        <label class="flex items-center text-xs text-gray-700 cursor-pointer select-none">
                            <div class="relative mr-2">
                                <input type="checkbox" id="showInnerLine" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                            </div>
                            Êû†Á∑ö (ÂÜÖÈÉ®„É©„Ç§„É≥)
                        </label>
                        <input type="color" id="innerLineColor" value="#FFFFFF" class="w-5 h-5">
                    </div>

                    <div id="innerLineSettings" class="pl-2 border-l-2 border-gray-100 hidden">
                         <label class="flex items-center text-[10px] text-gray-500 cursor-pointer mb-1"><input type="checkbox" id="innerLineDashed" class="mr-1">ÁÇπÁ∑ö„Å´„Åô„Çã</label>
                         <div><span class="text-[10px] text-gray-500 block">Êû†„ÅÆÈñìÈöî</span><input type="range" id="innerLineOffset" min="5" max="30" value="12" class="w-full h-1"></div>
                    </div>
                </section>
                
                 <div class="mt-4 flex flex-col gap-2 bg-gray-100 p-3 rounded border border-gray-200">
                    <span class="text-xs font-bold text-gray-700">ÂΩ±</span>
                    <label class="flex items-center text-xs text-gray-700 cursor-pointer">
                        <input type="checkbox" id="showShadow" class="rounded text-blue-600 mr-2" checked>
                        ÂΩ±„Çí„Å§„Åë„Çã („Éâ„É≠„ÉÉ„Éó„Ç∑„É£„Éâ„Ç¶)
                    </label>
                </div>

            </div>
        </aside>

        <main class="flex-1 flex flex-col relative">
            <div class="absolute top-4 left-0 right-0 flex justify-center z-10 pointer-events-none">
                <div class="bg-white/90 backdrop-blur-sm shadow-md rounded-full px-4 py-1.5 flex gap-3 pointer-events-auto border border-gray-200">
                    <button class="bg-preview-btn w-6 h-6 rounded-full border border-gray-300 bg-pattern-grid hover:ring-2 ring-blue-400 focus:outline-none" onclick="setPreviewBg('grid')" title="ÈÄèÈÅé"></button>
                    <button class="bg-preview-btn w-6 h-6 rounded-full border border-gray-300 bg-white hover:ring-2 ring-blue-400 focus:outline-none" onclick="setPreviewBg('white')" title="ÁôΩ"></button>
                    <button class="bg-preview-btn w-6 h-6 rounded-full border border-gray-300 bg-gray-800 hover:ring-2 ring-blue-400 focus:outline-none" onclick="setPreviewBg('dark')" title="Èªí"></button>
                </div>
            </div>

            <div class="flex-1 flex items-center justify-center bg-pattern-grid overflow-hidden p-8 transition-colors duration-300" id="previewArea">
                <div id="canvasWrapper" class="shadow-2xl rounded-sm transition-all duration-300 transform hover:scale-[1.02]">
                    <canvas id="labelCanvas" width="600" height="600"></canvas>
                </div>
            </div>
        </main>

        <aside class="w-80 bg-gray-800 text-white flex flex-col border-l border-gray-700 shadow-xl z-20">
            <div class="p-6 border-b border-gray-700">
                <h2 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-wider">‰øùÂ≠ò</h2>
                <div class="space-y-4">
                    <div class="flex items-center bg-gray-700 rounded border border-gray-600">
                        <input type="text" id="fileName" value="label" class="bg-transparent border-none text-sm px-3 py-2 w-full text-white focus:ring-0 placeholder-gray-400">
                        <span class="text-xs text-gray-400 pr-3 select-none">.png</span>
                    </div>

                    <label class="flex items-center justify-end text-xs text-gray-300 cursor-pointer hover:text-white transition">
                        <input type="checkbox" id="saveWithShadow" class="rounded text-emerald-500 mr-2 bg-gray-700 border-gray-500 focus:ring-emerald-500 focus:ring-offset-gray-800">
                        <span>‰øùÂ≠òÁîªÂÉè„Å´ÂΩ±„Çí„Å§„Åë„Çã</span>
                    </label>

                    <button id="downloadBtn" class="w-full bg-gradient-to-r from-emerald-600 to-teal-500 hover:from-emerald-500 hover:to-teal-400 text-white font-bold py-3 rounded shadow-lg transition flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">download</span> „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 pb-20 scrollbar-thin">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">„ÉÜ„É≥„Éó„É¨„Éº„Éà</h2>
                    <div class="flex gap-2">
                        <button id="resetBtn" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white transition flex items-center" title="ÂàùÊúüÂåñ">
                            <span class="material-symbols-outlined text-sm mr-1">restart_alt</span>„É™„Çª„ÉÉ„Éà
                        </button>
                        <button id="randomBtn" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-yellow-400 transition flex items-center">
                            <span class="material-symbols-outlined text-sm mr-1">casino</span>„Åä„Åæ„Åã„Åõ
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-6" id="templateGrid"></div>
                
                <hr class="border-gray-600 mb-6">

                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">„Éû„Ç§„Éë„Çø„Éº„É≥‰øùÂ≠ò</h2>
                    <button id="savePatternBtn" class="text-xs bg-blue-700 hover:bg-blue-600 px-2 py-1 rounded text-white transition flex items-center shadow-lg">
                         <span class="material-symbols-outlined text-sm mr-1">save</span>‰øùÂ≠ò
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-3" id="savedPatternsGrid"></div>
                <p class="text-[10px] text-gray-500 mt-2">* ÁîªÂÉè„Éá„Éº„Çø„ÅØ‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì(„Ç¢„Ç§„Ç≥„É≥„Å´Êàª„Çä„Åæ„Åô)</p>
            </div>
        </aside>
    </div>

    <script>
        const canvas = document.getElementById('labelCanvas');
        const ctx = canvas.getContext('2d');
        const previewArea = document.getElementById('previewArea');

        // ===============================================
        // Áä∂ÊÖãÁÆ°ÁêÜ
        // ===============================================
        const defaultState = {
            text: "Êñ∞ÂïÜÂìÅ", font: "'Noto Sans JP', sans-serif", fontSize: 60, letterSpacing: 10, textColor: "#FFFFFF", strokeColor: "#000000", strokeWidth: 0, textOffsetX: 0, textOffsetY: 0,
            shape: 'ribbon-simple', 
            ribbonColor: "#DC3535", ribbonColor2: "#B91C1C", colorMode: 'single', splitPos: 50, 
            shadow: true, // depth„ÅØÂâäÈô§
            iconType: 'text', iconValue: 'star', iconSize: 70, iconOffsetY: 0,
            showInnerLine: false, innerLineColor: "#FFFFFF", innerLineDashed: false, innerLineOffset: 12,
            accentLineMode: 'none', accentLineColor: "#FFD700", accentLineY: 20, accentLineThickness: 3,
            showHole: true, isRounded: false,
            globalScale: 100
        };
        let state = { ...defaultState };
        let uploadedImage = null;

        // ===============================================
        // UIÊìç‰ΩúÁ≥ª
        // ===============================================
        window.toggleAdvanced = (id) => {
            const el = document.getElementById(id);
            const arrow = document.getElementById(id + 'Arrow');
            if(el.classList.contains('open')) {
                el.classList.remove('open');
                arrow.style.transform = 'rotate(0deg)';
            } else {
                el.classList.add('open');
                arrow.style.transform = 'rotate(180deg)';
            }
        };

        window.setPreviewBg = (t) => previewArea.className = `flex-1 flex items-center justify-center overflow-hidden p-8 transition-colors duration-300 bg-pattern-${t}`;

        // ===============================================
        // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„Çø
        // ===============================================
        const templates = [
            { name: "Âü∫Êú¨„ÅÆËµ§", color: "#DC3535", color2: "#B91C1C", text: "SALE", icon: "star", shape: "ribbon-simple", font: "'Noto Sans JP', sans-serif", fontSize: 60, shadow: true },
            { name: "„ÇØ„Éº„É´„Çø„Ç∞", color: "#2563EB", color2: "#1E40AF", text: "ÈôêÂÆö", icon: "diamond", shape: "tag-right", font: "'Noto Sans JP', sans-serif", mode: 'gradient', fontSize: 100, iconSize: 60, shadow: true },
            // È´òÁ¥ö„ÉªÈªíÈáë„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Çí„ÄåPremium„Äç„Åã„Çâ„ÄåVIP„Äç„Å´Â§âÊõ¥
            { name: "È´òÁ¥ö„ÉªÈªíÈáë", color: "#1F2937", color2: "#000000", text: "VIP", icon: "NONE", shape: "ribbon-double", font: "'Yuji Syuku', serif", accent: 'straight', accentColor: '#D4AF37', fontSize: 45, textOffsetY: -45, shadow: true },
            { name: "„Éù„ÉÉ„Éó„ÉªÈªÑ", color: "#F59E0B", color2: "#FBBF24", text: "NEW!", icon: "favorite", shape: "tag-rect", font: "'Zen Maru Gothic', sans-serif", textColor: '#78350F', strokeW: 0, rounded: true, fontSize: 80, iconSize: 70, shadow: true },
            { name: "„Ç≤„Éº„É†È¢®", color: "#581c87", color2: "#7e22ce", text: "KP", icon: "sports_esports", shape: "tag-left", font: "'DotGothic16', sans-serif", mode: 'split', split: 35, inner: true, fontSize: 100, iconSize: 70, shadow: true },
            { name: "ÂíåÈ¢®„ÉªÁ∑ë", color: "#064E3B", color2: "#065F46", text: "Â§ßÂÖ•", icon: "NONE", shape: "ribbon-horizontal", font: "'Hina Mincho', serif", inner: true, innerDashed: true, fontSize: 100, shadow: false },
            { name: "Êº´ÁîªÈ¢®", color: "#EF4444", color2: "#000000", text: "ÊøÄÁÜ±", icon: "NONE", shape: "ribbon-double", font: "'Rampart One', cursive", strokeW: 8, strokeC: '#000000', fontSize: 80, shadow: true },
            { name: "„ÇÜ„ÇÅ„Åã„Çè", color: "#EC4899", color2: "#8B5CF6", text: "Kawaii", icon: "favorite", shape: "tag-rect", font: "'Zen Maru Gothic', sans-serif", mode: 'gradient', rounded: true, fontSize: 65, iconSize: 60, shadow: true }
        ];

        // ===============================================
        // ÊèèÁîª„É≠„Ç∏„ÉÉ„ÇØ
        // ===============================================
        function draw(exportCtx = ctx, exportW = canvas.width, exportH = canvas.height, isExport = false, overrideState = null) {
            const s = overrideState || state;
            const fontSpec = `bold ${s.fontSize}px ${s.font}`;
            
            const runDraw = () => {
                if (!isExport) {
                    exportCtx.clearRect(0, 0, exportW, exportH);
                }
                
                exportCtx.save();

                // ÂÖ®‰Ωì„Çπ„Ç±„Éº„É´ÈÅ©Áî®
                if (!isExport) {
                    const scale = s.globalScale / 100;
                    exportCtx.translate(exportW/2, exportH/2);
                    exportCtx.scale(scale, scale);
                    exportCtx.translate(-exportW/2, -exportH/2);
                }

                const config = getShapeConfig(s.shape, exportW, exportH);
                
                // 1. „É°„Ç§„É≥ÊèèÁîª
                drawShape(exportCtx, config, s);
                drawDecorations(exportCtx, config, s);
                drawContent(exportCtx, config, s);

                // 2. Á©¥„ÅÇ„ÅëÂá¶ÁêÜ (ÂÖ®„Å¶„ÅÆÊèèÁîª„ÅÆÂæå„Å´ÂÆüË°å„Åó„Å¶ÂÆåÂÖ®„Å´„Åè„ÇäÊäú„Åè)
                if((s.shape === 'tag-left' || s.shape === 'tag-right') && s.showHole) {
                      const { x, y, w, h } = config;
                      exportCtx.save();
                      exportCtx.globalCompositeOperation = "destination-out"; 
                      exportCtx.beginPath();
                      // ÂΩ±„ÅÆË®≠ÂÆö„ÇíËß£Èô§ÔºàÂΩ±„ÇíÊ∂à„Åô„Åü„ÇÅ„Åß„ÅØ„Å™„ÅÑ„Åå„ÄÅÂÆâÂÖ®„ÅÆ„Åü„ÇÅÔºâ
                      exportCtx.shadowBlur = 0; exportCtx.shadowColor = "transparent";
                      
                      const hx = s.shape==='tag-left' ? x+h/2-15 : x+w-h/2+15;
                      exportCtx.arc(hx, y+h/2, 8, 0, Math.PI*2); 
                      exportCtx.fill();
                      exportCtx.restore();
                }

                exportCtx.restore(); 
            };

            runDraw();

            if (!isExport) {
                document.fonts.load(fontSpec).then(() => { runDraw(); });
            }
        }
        
        document.fonts.onloadingdone = (fontFaceSetEvent) => { draw(); };

        function getShapeConfig(shape, w, h) {
            const cx = w / 2, cy = h / 2;
            let c = { x: 0, y: 0, w: 0, h: 0, isVertical: true };
            
            if (shape === 'ribbon-simple' || shape === 'ribbon-double') {
                c.w = 180; c.h = 460; c.isVertical = true;
                c.x = cx - c.w/2; 
                c.y = cy - c.h/2 + 20; 
            } 
            else if (shape === 'tag-rect' || shape === 'ribbon-horizontal' || shape.startsWith('tag-')) {
                c.w = 420; c.h = 130; c.isVertical = false;
                c.x = cx - c.w/2; c.y = cy - c.h/2;
            }
            return c;
        }

        function drawShape(ctx, c, s) {
            const { x, y, w, h } = c;
            let fillStyle;
            if (s.colorMode === 'single') fillStyle = s.ribbonColor;
            else {
                let grad = c.isVertical ? ctx.createLinearGradient(x, y, x, y + h) : ctx.createLinearGradient(x, y, x + w, y);
                if (s.colorMode === 'gradient') {
                    const center = s.splitPos / 100;
                    grad.addColorStop(0, s.ribbonColor); 
                    grad.addColorStop(1, s.ribbonColor2);
                    grad.addColorStop(center, center < 0.5 ? s.ribbonColor : s.ribbonColor2); 
                } else { 
                    const pos = s.splitPos / 100;
                    grad.addColorStop(pos, s.ribbonColor); grad.addColorStop(pos + 0.001, s.ribbonColor2);
                }
                fillStyle = grad;
            }

            ctx.save();

            // ÂΩ±„ÅÆË®≠ÂÆöÔºà„Çà„ÇäÊøÉ„Åè„ÄÅ„É™„ÉÉ„ÉÅ„Å´Ôºâ
            if (s.shadow) {
                ctx.shadowColor = "rgba(0,0,0,0.5)"; 
                ctx.shadowBlur = 20;
                ctx.shadowOffsetY = 15;
            }

            // „É°„Ç§„É≥„ÅÆÊèèÁîª
            switch (s.shape) {
                case 'ribbon-double':
                    // „É™„Éú„É≥Ë£èÂÅ¥
                    const backColor = adjustColor(s.ribbonColor, -60);
                    ctx.fillStyle = backColor;
                    ctx.fillRect(x+10, y, w-20, 40); 
                    
                    // „É™„Éú„É≥Ë°®ÂÅ¥
                    ctx.fillStyle = fillStyle;
                    ctx.beginPath();
                    ctx.moveTo(x, y+20); 
                    ctx.quadraticCurveTo(x+w/2, y+10, x+w, y+20);
                    ctx.lineTo(x+w, y+h); ctx.lineTo(x+w/2, y+h-40); ctx.lineTo(x, y+h); 
                    ctx.closePath(); ctx.fill();
                    break;
                default:
                    ctx.fillStyle = fillStyle;
                    defineShapePath(ctx, s.shape, x, y, w, h, s.isRounded);
                    ctx.fill();
                    break;
            }

            // Á´ã‰ΩìÊÑü(depth)Âá¶ÁêÜ„ÅØÂâäÈô§„Åï„Çå„Åæ„Åó„Åü

            ctx.restore();
        }

        function defineShapePath(ctx, shape, x, y, w, h, isRounded) {
             ctx.beginPath();
             if(shape==='ribbon-simple'){ ctx.moveTo(x,y); ctx.lineTo(x+w,y); ctx.lineTo(x+w,y+h); ctx.lineTo(x+w/2,y+h-40); ctx.lineTo(x,y+h); }
             else if(shape==='ribbon-double'){ ctx.moveTo(x, y+20); ctx.quadraticCurveTo(x+w/2, y+10, x+w, y+20); ctx.lineTo(x+w, y+h); ctx.lineTo(x+w/2, y+h-40); ctx.lineTo(x, y+h); }
             else if(shape==='tag-left'){ ctx.moveTo(x+h/2,y); ctx.lineTo(x+w,y); ctx.lineTo(x+w,y+h); ctx.lineTo(x+h/2,y+h); ctx.lineTo(x,y+h/2); }
             else if(shape==='tag-right'){ ctx.moveTo(x,y); ctx.lineTo(x+w-h/2,y); ctx.lineTo(x+w,y+h/2); ctx.lineTo(x+w-h/2,y+h); ctx.lineTo(x,y+h); }
             else if(shape==='tag-rect') { if(isRounded) roundedRect(ctx,x,y,w,h,20); else ctx.rect(x,y,w,h); }
             else if(shape==='ribbon-horizontal') {
                 const cut = 30; 
                 ctx.moveTo(x, y); ctx.lineTo(x + w, y); ctx.lineTo(x + w - cut, y + h / 2); 
                 ctx.lineTo(x + w, y + h); ctx.lineTo(x, y + h); ctx.lineTo(x + cut, y + h / 2); 
             }
             ctx.closePath();
        }

        function drawDecorations(ctx, c, s) {
             const { x, y, w, h, isVertical } = c;
             ctx.save();
             defineShapePath(ctx, s.shape, x, y, w, h, s.isRounded);
             ctx.clip();

             if (s.showInnerLine) {
                 ctx.strokeStyle = s.innerLineColor; ctx.lineWidth = 2;
                 if (s.innerLineDashed) ctx.setLineDash([5, 5]);
                 const off = parseInt(s.innerLineOffset);
                 
                 ctx.beginPath();
                 if(s.shape==='tag-rect') { 
                     if(s.isRounded) roundedRect(ctx, x+off, y+off, w-off*2, h-off*2, 15); 
                     else ctx.rect(x+off, y+off, w-off*2, h-off*2); 
                 } 
                 else if (s.shape === 'ribbon-horizontal') {
                     const cut = 30; 
                     ctx.moveTo(x + off, y + off); 
                     ctx.lineTo(x + w - off, y + off);
                     ctx.lineTo(x + w - cut - off + 10, y + h / 2); 
                     ctx.lineTo(x + w - off, y + h - off);
                     ctx.lineTo(x + off, y + h - off); 
                     ctx.lineTo(x + cut + off - 10, y + h / 2); 
                     ctx.closePath();
                 } 
                 else if(s.shape==='tag-left') { 
                     ctx.moveTo(x+h/2+off/2, y+off); 
                     ctx.lineTo(x+w-off, y+off); 
                     ctx.lineTo(x+w-off, y+h-off); 
                     ctx.lineTo(x+h/2+off/2, y+h-off); 
                     ctx.lineTo(x+off+5, y+h/2);
                     ctx.closePath();
                 } 
                 else if(s.shape==='tag-right') { 
                     ctx.moveTo(x+off, y+off); 
                     ctx.lineTo(x+w-h/2-off/2, y+off); 
                     ctx.lineTo(x+w-off-5, y+h/2);
                     ctx.lineTo(x+w-h/2-off/2, y+h-off); 
                     ctx.lineTo(x+off, y+h-off);
                     ctx.closePath();
                 } 
                 else { 
                     const topY = y + (s.shape === 'ribbon-double' ? 20 : 0); 
                     if (s.shape === 'ribbon-double') { ctx.moveTo(x+off, topY+off); ctx.quadraticCurveTo(x+w/2, topY+10+off, x+w-off, topY+off); } 
                     else { ctx.moveTo(x+off, topY+off); ctx.lineTo(x+w-off, topY+off); }
                     ctx.lineTo(x+w-off, y+h-off); ctx.lineTo(x+w/2, y+h-40-off); ctx.lineTo(x+off, y+h-off); ctx.closePath();
                 }
                 ctx.stroke(); ctx.setLineDash([]); 
             }

             if (s.accentLineMode !== 'none') {
                 ctx.strokeStyle = s.accentLineColor; ctx.lineWidth = parseInt(s.accentLineThickness);
                 const posVal = parseInt(s.accentLineY);
                 
                 ctx.beginPath();
                 
                 if (isVertical) {
                     const top = (s.shape==='ribbon-double') ? y + 20 : y;
                     const lineY = top + (h * posVal/100);
                     
                     if (s.accentLineMode === 'wavy') {
                         const freq = 0.15; const amp = parseInt(s.accentLineThickness) + 2;
                         for (let i = x; i <= x + w; i+=2) { 
                             const wy = lineY + Math.sin((i - x) * freq) * amp; 
                             i===x ? ctx.moveTo(i, wy) : ctx.lineTo(i, wy); 
                         }
                     } else { ctx.moveTo(x, lineY); ctx.lineTo(x+w, lineY); }
                     
                     if(s.accentLineMode === 'double') {
                         const lineY2 = lineY + 12;
                         ctx.moveTo(x, lineY2); ctx.lineTo(x+w, lineY2);
                     }
                 } 
                 else {
                     const lineX = x + (w * posVal/100);
                     
                     if (s.accentLineMode === 'wavy') {
                         const freq = 0.15; const amp = parseInt(s.accentLineThickness) + 2;
                         for (let i = y; i <= y + h; i+=2) {
                             const wx = lineX + Math.sin((i - y) * freq) * amp;
                             i===y ? ctx.moveTo(wx, i) : ctx.lineTo(wx, i);
                         }
                     } else { ctx.moveTo(lineX, y); ctx.lineTo(lineX, y+h); }

                     if(s.accentLineMode === 'double') {
                         const lineX2 = lineX + 12;
                         ctx.moveTo(lineX2, y); ctx.lineTo(lineX2, y+h);
                     }
                 }
                 ctx.stroke();
             }
             ctx.restore(); 
        }

        function drawContent(ctx, c, s) {
            const { x, y, w, h, isVertical } = c;
            
            ctx.font = `bold ${s.fontSize}px ${s.font}`; 
            const spacing = parseInt(s.letterSpacing);
            const iconSize = parseInt(s.iconSize);
            const userOffsetX = parseInt(s.textOffsetX);
            const userOffsetY = parseInt(s.textOffsetY);
            const iconUserOffsetY = parseInt(s.iconOffsetY);

            let hasIcon = (s.iconType !== 'NONE' && s.iconValue !== 'NONE');
            let cx = x + w/2; 
            
            if(isVertical) {
                let cy = y + (s.shape==='ribbon-double' ? 140 : 120);
                let tx = cx + userOffsetX;
                let ty = cy + userOffsetY;
                let iy = y + (s.shape==='ribbon-double'? 80 : 60) + iconUserOffsetY;

                if(hasIcon) {
                    if(s.iconType==='image' && uploadedImage){ 
                        ctx.drawImage(uploadedImage, cx-iconSize/2, iy-iconSize/2, iconSize, iconSize); 
                    } else { 
                        ctx.fillStyle=s.textColor; ctx.font=`${iconSize}px 'Material Symbols Outlined'`; 
                        ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(s.iconValue, cx, iy); 
                    }
                }

                ctx.fillStyle = s.textColor; ctx.strokeStyle = s.strokeColor; ctx.lineWidth = parseInt(s.strokeWidth);
                ctx.font = `bold ${s.fontSize}px ${s.font}`; 
                ctx.textAlign="center"; ctx.textBaseline="top";
                let startY = ty;
                if(s.shape==='ribbon-double') startY += 20;

                s.text.split('').forEach((char, i)=>{
                    let charY = startY + (i * (parseInt(s.fontSize)+spacing));
                    if(['„Éº','-','ÔΩû','(',')'].includes(char)){ ctx.save(); ctx.translate(tx, charY+parseInt(s.fontSize)/2); ctx.rotate(Math.PI/2); drawChar(ctx, char, 0, -parseInt(s.fontSize)/2, s.strokeWidth); ctx.restore(); }
                    else drawChar(ctx, char, tx, charY, s.strokeWidth);
                });

            } 
            else {
                let baseCenterY = y + h / 2 + userOffsetY;
                
                ctx.font = `bold ${s.fontSize}px ${s.font}`; 
                const chars = s.text.split('');
                let textWidth = 0;
                chars.forEach(c => textWidth += ctx.measureText(c).width + spacing);
                if(chars.length > 0) textWidth -= spacing;

                const gap = 15; 
                let totalContentWidth = textWidth;
                if(hasIcon) totalContentWidth += iconSize + gap;

                let centerX = cx;
                if(s.shape === 'tag-left') centerX += 15;
                if(s.shape === 'tag-right') centerX -= 15;

                let startX = centerX - (totalContentWidth / 2) + userOffsetX;
                
                if(hasIcon) {
                    let iconVisualOffset = iconSize * 0.1; 
                    let iconCenterY = baseCenterY + iconUserOffsetY + iconVisualOffset;
                    
                    let ix = startX + iconSize / 2;
                    
                    if(s.iconType==='image' && uploadedImage){ 
                        ctx.drawImage(uploadedImage, ix-iconSize/2, iconCenterY-iconSize/2, iconSize, iconSize); 
                    } else { 
                        ctx.fillStyle=s.textColor; 
                        ctx.font=`${iconSize}px 'Material Symbols Outlined'`; 
                        ctx.textAlign="center"; 
                        ctx.textBaseline="middle"; 
                        ctx.fillText(s.iconValue, ix, iconCenterY); 
                    }
                    startX += iconSize + gap;
                }

                ctx.fillStyle = s.textColor; 
                ctx.strokeStyle = s.strokeColor; 
                ctx.lineWidth = parseInt(s.strokeWidth);
                ctx.font = `bold ${s.fontSize}px ${s.font}`; 
                ctx.textAlign="center"; 
                ctx.textBaseline="middle"; 

                let currentX = startX + (ctx.measureText(chars[0]).width / 2);
                chars.forEach(char => {
                    drawChar(ctx, char, currentX, baseCenterY, s.strokeWidth);
                    currentX += ctx.measureText(char).width + spacing;
                });
            }
        }
        function drawChar(ctx, txt, x, y, sw){ if(sw>0){ ctx.lineJoin="round"; ctx.strokeText(txt, x, y); } ctx.fillText(txt, x, y); }

        // ===============================================
        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        // ===============================================
        const adjustColor=(c,a)=>'#'+c.replace(/^#/,'').replace(/../g,c=>('0'+Math.min(255,Math.max(0,parseInt(c,16)+a)).toString(16)).substr(-2));
        const roundedRect=(ctx,x,y,w,h,r)=>{ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}
        
        function bind(id, key, type='value') { 
            const el = document.getElementById(id); 
            if(el) el.addEventListener(type==='checkbox'?'change':'input', e=>{ 
                state[key]=type==='checkbox'?e.target.checked:e.target.value; 
                if(key==='splitPos') document.getElementById('splitValDisplay').innerText = state[key] + '%';
                if(key==='globalScale') document.getElementById('globalScaleVal').innerText = state[key] + '%';
                draw(); 
            }); 
        }
        
        bind('labelText','text'); bind('fontFamily','font'); bind('fontSize','fontSize'); bind('letterSpacing','letterSpacing');
        bind('textColor','textColor'); bind('strokeColor','strokeColor'); bind('strokeWidth','strokeWidth');
        bind('textOffsetX','textOffsetX'); bind('textOffsetY','textOffsetY');
        bind('ribbonColor','ribbonColor'); bind('ribbonColor2','ribbonColor2'); bind('splitPos','splitPos');
        bind('iconSize','iconSize'); bind('iconOffsetY','iconOffsetY');
        bind('showInnerLine','showInnerLine','checkbox'); bind('innerLineColor','innerLineColor'); bind('innerLineDashed','innerLineDashed','checkbox'); bind('innerLineOffset','innerLineOffset');
        bind('accentLineColor','accentLineColor'); bind('accentLineY','accentLineY'); bind('accentLineThickness','accentLineThickness');
        bind('showHole', 'showHole', 'checkbox'); bind('isRounded', 'isRounded', 'checkbox');
        bind('globalScale', 'globalScale');
        bind('showShadow','shadow','checkbox');
        // showDepth„ÅÆbind„ÅØÂâäÈô§

        document.querySelectorAll('input[name="colorMode"]').forEach(r=>r.addEventListener('change',e=>{ 
            state.colorMode=e.target.value; 
            const disabled = state.colorMode==='single';
            document.getElementById('splitPos').disabled = disabled; 
            document.getElementById('splitPosContainer').style.opacity = disabled ? 0.3 : 1;
            draw(); 
        }));
        
        document.querySelectorAll('input[name="accentLineMode"]').forEach(r=>r.addEventListener('change',e=>{ 
            state.accentLineMode=e.target.value; 
            const adv = document.getElementById('accentAdvanced');
            if(state.accentLineMode==='none') { adv.classList.add('hidden', 'opacity-0'); }
            else { adv.classList.remove('hidden'); setTimeout(()=>adv.classList.remove('opacity-0'),10); }
            draw(); 
        }));

        document.getElementById('showInnerLine').addEventListener('change', e=>{
            state.showInnerLine = e.target.checked;
            document.getElementById('innerLineSettings').style.display = state.showInnerLine ? 'block' : 'none';
            draw();
        });

        document.querySelectorAll('.shape-btn').forEach(b=>b.addEventListener('click',()=>{
            document.querySelectorAll('.shape-btn').forEach(btn=>btn.classList.remove('active')); 
            b.classList.add('active'); state.shape=b.dataset.shape; 
            const isVertical = (state.shape === 'ribbon-simple' || state.shape === 'ribbon-double');
            document.getElementById('accentPosLabel').innerText = isVertical ? "Á∏¶‰ΩçÁΩÆ" : "‰ΩçÁΩÆ";
            draw();
        }));
        
        document.querySelectorAll('.icon-btn').forEach(b=>b.addEventListener('click',()=>{
            document.querySelectorAll('.icon-btn').forEach(btn=>btn.classList.remove('bg-blue-50','border-blue-500','text-blue-600')); 
            b.classList.add('bg-blue-50','border-blue-500','text-blue-600'); 
            const val = b.dataset.icon;
            state.iconType = val === 'NONE' ? 'NONE' : 'text';
            state.iconValue = val;
            draw();
        }));

        document.getElementById('imageUpload').addEventListener('change',e=>{
            const f=e.target.files[0];
            if(f){
                const r=new FileReader();
                r.onload=ev=>{
                    const i=new Image();
                    i.onload=()=>{ uploadedImage=i; state.iconType='image'; draw(); };
                    i.src=ev.target.result;
                };
                r.readAsDataURL(f);
            }
        });

        document.getElementById('downloadBtn').addEventListener('click', () => {
            const dummyConfig = getShapeConfig(state.shape, 100, 100);
            const margin = 50; 
            const exportW = dummyConfig.w + margin;
            const exportH = dummyConfig.h + margin;
            
            const saveWithShadow = document.getElementById('saveWithShadow').checked;
            // depth„ÅØÂâäÈô§„Åï„Çå„Åü„Åü„ÇÅ„ÄÅshadow„ÅÆ„ÅøË®≠ÂÆö
            const tempState = { ...state, shadow: saveWithShadow };

            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = exportW;
            exportCanvas.height = exportH;
            const exportCtx = exportCanvas.getContext('2d');

            draw(exportCtx, exportW, exportH, true, tempState);

            const l = document.createElement('a');
            l.download = `${document.getElementById('fileName').value || 'label'}.png`;
            l.href = exportCanvas.toDataURL();
            l.click();
        });

        const templateGrid = document.getElementById('templateGrid');
        templates.forEach((t) => {
            const btn = document.createElement('div');
            btn.className = "template-btn bg-gray-700 hover:bg-gray-600 p-2 rounded cursor-pointer transition flex flex-col items-center gap-1 border border-gray-600";
            btn.innerHTML = `<div class="w-full h-8 rounded" style="background:${t.color}"></div><span class="text-[10px] text-gray-300">${t.name}</span>`;
            btn.onclick = () => applyTemplate(t);
            templateGrid.appendChild(btn);
        });

        function applyTemplate(t) {
            if(t.color) state.ribbonColor = t.color;
            if(t.color2) state.ribbonColor2 = t.color2 || t.color;
            if(t.text) state.text = t.text;
            if(t.shape) state.shape = t.shape;
            if(t.font) state.font = t.font;
            if(t.fontSize) state.fontSize = t.fontSize;
            if(t.icon === 'NONE') { state.iconType = 'NONE'; state.iconValue = 'NONE'; }
            else if(t.icon) { state.iconType = 'text'; state.iconValue = t.icon; }
            if(t.iconSize) state.iconSize = t.iconSize; else state.iconSize = 70;
            
            state.colorMode = t.mode || 'single';
            state.accentLineMode = t.accent || 'none';
            if(t.accentColor) state.accentLineColor = t.accentColor;
            state.showInnerLine = t.inner || false;
            state.innerLineDashed = t.innerDashed || false;
            if(t.textColor) state.textColor = t.textColor; else state.textColor = "#FFFFFF";
            state.strokeWidth = t.strokeW !== undefined ? t.strokeW : 0;
            state.splitPos = t.split || 50;
            state.isRounded = t.rounded || false;
            state.shadow = t.shadow !== undefined ? t.shadow : true;
            // depth„ÅØÈÅ©Áî®„Åó„Å™„ÅÑ
            
            state.globalScale = 100;
            state.textOffsetX = 0;
            state.textOffsetY = t.textOffsetY || 0; 
            state.iconOffsetY = 0;
            
            uploadedImage = null; 
            updateUI(); draw();
        }

        function updateUI() {
            document.getElementById('ribbonColor').value = state.ribbonColor;
            document.getElementById('ribbonColor2').value = state.ribbonColor2;
            document.getElementById('labelText').value = state.text;
            document.getElementById('fontFamily').value = state.font;
            document.getElementById('fontSize').value = state.fontSize;
            document.getElementById('textColor').value = state.textColor;
            document.getElementById('splitPos').value = state.splitPos;
            document.querySelectorAll('input[name="colorMode"]').forEach(r => r.checked = (r.value === state.colorMode));
            document.querySelectorAll('input[name="accentLineMode"]').forEach(r => r.checked = (r.value === state.accentLineMode));
            document.getElementById('showInnerLine').checked = state.showInnerLine;
            document.getElementById('innerLineSettings').style.display = state.showInnerLine ? 'block' : 'none';
            document.getElementById('showHole').checked = state.showHole;
            document.getElementById('isRounded').checked = state.isRounded;
            document.getElementById('globalScale').value = state.globalScale;
            document.getElementById('globalScaleVal').innerText = state.globalScale + '%';
            document.getElementById('iconSize').value = state.iconSize;
            document.getElementById('textOffsetX').value = state.textOffsetX;
            document.getElementById('textOffsetY').value = state.textOffsetY;
            document.getElementById('iconOffsetY').value = state.iconOffsetY;
            document.getElementById('showShadow').checked = state.shadow;
            // showDepth UIÊõ¥Êñ∞„ÅØÂâäÈô§

            document.querySelectorAll('.icon-btn').forEach(btn => {
                btn.classList.remove('bg-blue-50','border-blue-500','text-blue-600');
                if(btn.dataset.icon === state.iconValue) btn.classList.add('bg-blue-50','border-blue-500','text-blue-600');
            });
            document.querySelectorAll('.shape-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.shape === state.shape);
            });
            document.querySelector('input[name="colorMode"]:checked').dispatchEvent(new Event('change'));
            document.querySelector('input[name="accentLineMode"]:checked').dispatchEvent(new Event('change'));
        }

        const savedPatternsGrid = document.getElementById('savedPatternsGrid');
        let savedPatterns = [];
        try { savedPatterns = JSON.parse(localStorage.getItem('dlm_patterns_v6')) || []; } catch(e) {}

        function renderSavedPatterns() {
            savedPatternsGrid.innerHTML = '';
            savedPatterns.forEach((p, idx) => {
                const btn = document.createElement('div');
                btn.className = "pattern-btn bg-gray-600 hover:bg-gray-500 p-2 rounded cursor-pointer transition flex flex-col items-center gap-1 border border-gray-500 relative";
                const colorBox = document.createElement('div');
                colorBox.className = "w-full h-8 rounded"; colorBox.style.background = p.ribbonColor;
                const label = document.createElement('span');
                label.className = "text-[10px] text-gray-200"; label.innerText = p.text || `#${idx+1}`;
                const delBtn = document.createElement('button');
                delBtn.className = "delete-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 items-center justify-center text-xs shadow-md z-10 hover:bg-red-600";
                delBtn.innerText = "√ó";
                delBtn.onclick = (e) => { e.stopPropagation(); if(confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) { savedPatterns.splice(idx, 1); saveToLocal(); renderSavedPatterns(); } };
                btn.appendChild(colorBox); btn.appendChild(label); btn.appendChild(delBtn);
                btn.onclick = () => { applyTemplate(p); };
                savedPatternsGrid.appendChild(btn);
            });
        }
        function saveToLocal() { localStorage.setItem('dlm_patterns_v6', JSON.stringify(savedPatterns)); }
        document.getElementById('savePatternBtn').addEventListener('click', () => {
            const saveState = { ...state };
            if(saveState.iconType === 'image') { saveState.iconType = 'text'; saveState.iconValue = 'star'; alert('ÁîªÂÉè„Éá„Éº„Çø„ÅØ‰øùÂ≠ò„Åß„Åç„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Ç¢„Ç§„Ç≥„É≥„ÅØ‚òÖ„Å´Êàª„Çä„Åæ„Åô„ÄÇ'); }
            savedPatterns.push(saveState); saveToLocal(); renderSavedPatterns();
        });
        document.getElementById('resetBtn').addEventListener('click', () => { if(confirm('„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) { state = { ...defaultState }; updateUI(); draw(); } });
        document.getElementById('randomBtn').addEventListener('click', () => {
             const shapes = ['ribbon-simple', 'ribbon-double', 'tag-left', 'tag-right', 'tag-rect', 'ribbon-horizontal'];
             const fonts = ["'Noto Sans JP', sans-serif", "'Zen Maru Gothic', sans-serif", "'Yuji Syuku', serif", "'DotGothic16', sans-serif", "'Rampart One', cursive"];
             const rC = () => '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
             state.shape = shapes[Math.floor(Math.random() * shapes.length)];
             state.font = fonts[Math.floor(Math.random() * fonts.length)];
             state.ribbonColor = rC(); state.ribbonColor2 = rC();
             state.colorMode = Math.random()>0.7 ? 'gradient' : 'single';
             state.shadow = Math.random() > 0.2;
             // depth„ÅØÂâäÈô§
             updateUI(); draw();
        });
        document.getElementById('randomColorBtn').addEventListener('click', () => {
             const rC = () => '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
             state.ribbonColor = rC(); state.ribbonColor2 = rC();
             updateUI(); draw();
        });
        
        // ‚ñº‚ñº‚ñº ‰øÆÊ≠£ÁÇπÔºö„É≠„Éº„Éá„Ç£„É≥„Ç∞Âá¶ÁêÜ„ÅÆÁµ±Âêà ‚ñº‚ñº‚ñº
        window.onload = () => { 
            // ‰øùÂ≠ò„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
            renderSavedPatterns(); 
            
            // „Éï„Ç©„É≥„ÉàË™≠„ÅøËæº„ÅøÂæÖÊ©üÂæå„Å´ÊèèÁîªÔºÜ„É≠„Éº„Éá„Ç£„É≥„Ç∞Ëß£Èô§
            document.fonts.ready.then(() => {
                draw(); // ÂàùÂõûÊèèÁîª
                
                // Â∞ë„Åó„Å†„ÅëÂæÖ„Å£„Å¶„Åã„Çâ„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÔºà„ÉÅ„É©„Å§„ÅçÈò≤Ê≠¢Ôºâ
                setTimeout(() => {
                    const overlay = document.getElementById('loadingOverlay');
                    if(overlay) {
                        overlay.style.opacity = '0'; // ÈÄèÊòé„Å´„Åô„Çã
                        setTimeout(() => {
                            overlay.style.display = 'none'; // ÂÆåÂÖ®„Å´Ê∂à„Åô
                        }, 500);
                    }
                }, 300);
            });
        };
    </script>
</body>
</html>