<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BG Remover - Pro</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>💎</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>BG Remove <span class="badge">BG Remover Pro</span></h1>
    </header>

    <div class="main-container">
        
        <div class="panel">
            <div class="panel-scroll">
                <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5z"/></svg>
                    画像を開く
                </button>
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(this)">

                <div class="section-title">ツール</div>
                <div class="tools-grid">
                    <div class="tool-btn active" id="btn-pan" onclick="setTool('pan')" title="移動">
                        <svg viewBox="0 0 24 24"><path d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z"/></svg>移動
                    </div>
                    <div class="tool-btn" id="btn-dropper" onclick="setTool('dropper')" title="スポイト">
                        <svg viewBox="0 0 24 24"><path d="M20.71 5.63l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-3.12 3.12-1.93-1.91-1.41 1.41 1.42 1.42L3 16.25V21h4.75l8.92-8.92 1.42 1.42 1.41-1.41-1.92-1.92 3.12-3.12c.4-.4.4-1.03.01-1.42zM5.21 19.5l-.71-.71 6.36-6.36.71.71-6.36 6.36z"/></svg>スポイト
                    </div>
                    <div class="tool-btn" id="btn-wand" onclick="setTool('wand')" title="魔法の杖">
                        <svg viewBox="0 0 24 24"><path d="M7.5 5.6L10 7 8.6 4.5 10 2 7.5 3.4 5 2 6.4 4.5 5 7zM19.5 15.4L22 14l-2.5-1.4L21 10l-2.6 1.5L16 10l1.4 2.6L16 14l2.5 1.4zM14.5 8.24l-3.26-3.26c-.78-.78-2.05-.78-2.83 0L3.12 10.27c-.78.78-.78 2.05 0 2.83l10.17 10.17c.39.39.9.59 1.41.59s1.02-.2 1.41-.59l6.17-6.17c.78-.78.78-2.05 0-2.83l-7.78-6.03z"/></svg>魔法の杖
                    </div>
                    <div class="tool-btn" id="btn-rect" onclick="setTool('rect')" title="矩形消去">
                        <svg viewBox="0 0 24 24"><path d="M3 3h18v18H3V3zm16 16V5H5v14h14z" fill="currentColor"/></svg>矩形消去
                    </div>
                    <div class="tool-btn" id="btn-eraser" onclick="setTool('eraser')" title="消しゴム">
                        <svg viewBox="0 0 24 24"><path d="M15.14 3c-.51 0-1.02.2-1.41.59L2.59 14.73c-.78.78-.78 2.05 0 2.83L5.03 20h7.66l8.72-8.72c.79-.78.79-2.05 0-2.83l-4.85-4.86c-.39-.39-.91-.59-1.42-.59zM17 18l-1.39-1.39 3.58-3.58 1.39 1.39L17 18z"/></svg>消しゴム
                    </div>
                    <div class="tool-btn" id="btn-protect" onclick="setTool('protect')" title="保護ペン">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>保護ペン
                    </div>
                </div>

                <div id="eraser-settings" class="control-group" style="display:none; border-left: 4px solid #FF1744;">
                    <div class="control-header">ブラシサイズ <span class="val-disp" id="v-eraser">30</span></div>
                    <input type="range" id="s-eraser" min="1" max="150" value="30" oninput="updateVal('v-eraser', this.value); updateCursor(this.value);">
                </div>
                <div id="wand-settings" class="control-group" style="display:none; border-left: 4px solid #2962FF;">
                    <div class="control-header">許容誤差 <span class="val-disp" id="v-wand">30</span></div>
                    <input type="range" id="s-wand" min="0" max="100" value="30" oninput="updateVal('v-wand', this.value);">
                </div>

                <div class="section-title">自動透過設定</div>
                
                <button class="btn" style="background:#5E35B1; margin-bottom:10px;" onclick="autoDetectBackground()">
                    🪄 自動判定で消す
                </button>

                <div class="control-group">
                    <div class="control-header">
                        基準の色
                        <div class="color-preview" id="bgColorPreview" style="background:#00FF00;">
                            <input type="color" id="bgColorInput" class="color-input" style="pointer-events: auto;" value="#00FF00" oninput="changeBgColor(this.value)">
                        </div>
                    </div>
                    <div style="margin-top:12px; border-top:1px solid #eee; padding-top:10px;">
                         <label class="toggle-switch">
                            <input type="checkbox" id="contiguousMode" onchange="runProcess()">
                            <span class="toggle-slider"></span>
                            隣接領域のみ
                        </label>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-header">色の範囲 <span class="val-disp" id="v-thresh">0</span></div>
                    <input type="range" id="s-thresh" min="0" max="100" value="0" oninput="updateVal('v-thresh', this.value)" onchange="runProcess()">
                </div>
                <div class="control-group">
                    <div class="control-header">色のぼかし (Feather) <span class="val-disp" id="v-soft">0</span></div>
                    <input type="range" id="s-soft" min="0" max="50" value="0" oninput="updateVal('v-soft', this.value)" onchange="runProcess()">
                </div>
                <div class="control-group">
                    <div class="control-header">色のチョーク (Choke) <span class="val-disp" id="v-choke">0</span></div>
                    <input type="range" id="s-choke" min="0" max="100" value="0" oninput="updateVal('v-choke', this.value)" onchange="runProcess()">
                </div>
                <div class="control-group">
                    <div class="control-header">色被り除去 <span class="val-disp" id="v-spill">0%</span></div>
                    <input type="range" id="s-spill" min="0" max="100" value="0" oninput="updateVal('v-spill', this.value+'%')" onchange="runProcess()">
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="preview-toolbar">
                <span style="font-weight:bold; color:#666; margin-right:auto;">PREVIEW</span>
                <label class="toggle-switch" title="白黒でマスクを表示">
                    <input type="checkbox" id="maskViewMode" onchange="runProcess()">
                    <span class="toggle-slider"></span>
                    Mask
                </label>
                <div style="width:1px; height:16px; background:#ddd; margin:0 5px;"></div>
                
                <div style="display:flex; gap:5px;">
                    <div class="color-preview icon-checker" onclick="setCanvasBg('checker')" title="市松模様"></div>
                    <div class="color-preview" style="background:#fff;" onclick="setCanvasBg('white')" title="白"></div>
                    <div class="color-preview" style="background:#000;" onclick="setCanvasBg('black')" title="黒"></div>
                    <div class="color-preview" id="customBgBtn" style="background:#FF4081;" title="クリック:適用 / 長押し:変更">
                        <input type="color" id="customBgInput" class="color-input" value="#FF4081">
                    </div>
                </div>
            </div>
            <div class="canvas-area" id="canvasContainer">
                <div class="loading-overlay" id="loadingOverlay">
                    <div id="loadingText">処理中...</div>
                    <div style="font-size:0.8rem; color:#666; margin-top:5px;">(※画像サイズにより時間がかかります)</div>
                </div>
                <div class="overlay-msg" id="overlayMsg">画像をドロップ<br>または「画像を開く」</div>
                <div id="canvasWrapper" style="position:absolute; top:0; left:0; transform-origin:0 0;">
                    <canvas id="mainCanvas"></canvas>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-scroll">
                <div class="history-row">
                    <button class="btn-icon" id="undoBtn" onclick="undo()" disabled title="戻す (Ctrl+Z)">
                        <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
                        戻す
                    </button>
                    <button class="btn-icon" id="redoBtn" onclick="redo()" disabled title="やり直す (Ctrl+Y)">
                        <svg viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 9 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>
                        進む
                    </button>
                    <button class="btn-icon" style="flex:0.6; color:#D32F2F;" onclick="resetAll()" title="リセット">
                        <svg viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
                    </button>
                </div>

                <div class="section-title">仕上げ詳細設定</div>
                
                <!-- 新機能: ポストプロセス処理 -->
                <div class="control-group" style="border-left: 3px solid #AB47BC;">
                    <div class="control-header" title="エッジのギザギザを軽減します">
                        アンチエイリアス (AA) <span class="val-disp" id="v-smooth">0</span>
                    </div>
                    <input type="range" id="s-smooth" min="0" max="10" step="1" value="0" oninput="updateVal('v-smooth', this.value); runProcess();">
                    
                    <div class="control-header" style="margin-top:10px;" title="エッジをくっきりさせて半透明部分を減らします">
                        エッジの硬さ <span class="val-disp" id="v-hardness">0</span>
                    </div>
                    <input type="range" id="s-hardness" min="0" max="100" value="0" oninput="updateVal('v-hardness', this.value); runProcess();">
                    
                    <div style="font-size:0.7rem; color:#888; margin-top:5px; line-height:1.2;">
                        ※AAで滑らかにしてから、硬さで輪郭を調整すると綺麗になります。
                    </div>
                </div>

                <div class="control-group" style="border-left: 3px solid var(--primary);">
                    <div class="control-header">
                        縁取り
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableBorder" onchange="toggleBorder()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div id="border-controls" style="opacity:0.5; pointer-events:none; margin-top:10px;">
                        <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                            <span style="font-size:0.75rem;">色:</span>
                            <div class="color-preview" id="borderColorPreview" style="background:#FFFFFF;">
                                <input type="color" id="borderColorInput" class="color-input" style="pointer-events: auto;" value="#FFFFFF" oninput="document.getElementById('borderColorPreview').style.background=this.value; runProcess();">
                            </div>
                            <button onclick="setTool('dropper_border')" style="padding:4px; cursor:pointer; background:#eee; border:1px solid #ccc; border-radius:4px;" title="縁取り色をスポイト">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.71 5.63l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-3.12 3.12-1.93-1.91-1.41 1.41 1.42 1.42L3 16.25V21h4.75l8.92-8.92 1.42 1.42 1.41-1.41-1.92-1.92 3.12-3.12c.4-.4.4-1.03.01-1.42zM5.21 19.5l-.71-.71 6.36-6.36.71.71-6.36 6.36z"/></svg>
                            </button>
                        </div>
                        <div class="control-header">太さ <span class="val-disp" id="v-border">0</span></div>
                        <input type="range" id="s-border" min="0" max="30" value="0" oninput="updateVal('v-border', this.value); runProcess();">
                        <div style="margin-top:5px; font-size:0.75rem;">
                            <label><input type="radio" name="borderStyle" value="blur" checked onchange="runProcess()"> ぼかし</label>
                            <label style="margin-left:10px;"><input type="radio" name="borderStyle" value="solid" onchange="runProcess()"> くっきり</label>
                        </div>
                    </div>
                </div>

                <div class="control-group" style="border-left: 3px solid #00E5FF;">
                    <div class="control-header">
                        グリッド分割
                        <label class="toggle-switch" title="ONにすると線を編集できます">
                            <input type="checkbox" id="sliceModeToggle" onchange="toggleSliceMode()">
                            <span class="toggle-slider"></span>
                            編集
                        </label>
                    </div>
                    <div id="slice-controls-area" style="opacity:0.5; pointer-events:none; margin-top:10px;">
                        <div class="slice-controls">
                            <label style="font-size:0.75rem;">横: <input type="number" id="sliceCols" value="2" min="1"></label>
                            <label style="font-size:0.75rem;">縦: <input type="number" id="sliceRows" value="2" min="1"></label>
                        </div>
                        <button class="btn btn-sm btn-outline" style="width:100%; margin-bottom:10px;" onclick="initGridLines()">
                            グリッドをリセット
                        </button>
                        <button class="btn btn-sm" style="width:100%; background:#00BCD4; color:#fff;" onclick="sliceAndZip()">
                            ✂️ 分割ZIP保存
                        </button>
                        <div class="help-text" style="text-align:center;">水色の線をドラッグして調整</div>
                    </div>
                </div>

                <div class="control-group" style="border-left: 3px solid #2962FF;">
                    <div class="control-header">一括保存</div>
                    <label class="toggle-switch" style="margin:10px 0;">
                        <input type="checkbox" id="autoTrim" checked>
                        <span class="toggle-slider"></span>
                        自動トリミング
                    </label>
                    
                    <button class="btn" id="downloadBtn" onclick="downloadImage()" disabled>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                        通常保存 (PNG)
                    </button>
                    
                    <button class="btn" style="background:#00C853; margin-top:10px;" onclick="setTool('crop')">
                        ⛶ 範囲指定保存
                    </button>
                    
                    <button class="btn" id="autoCutBtn" onclick="autoCutAndZip()" disabled style="background:#FF6D00; margin-top:10px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"/></svg>
                        🧩 自動カットZIP
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="eraser-cursor" class="cursor-indicator" style="border-color:var(--danger); background:rgba(255,23,68,0.3);"></div>
    <div id="protect-cursor" class="cursor-indicator" style="border-color:var(--protect); background:rgba(255,214,0,0.3);"></div>

    <script src="script.js"></script>
</body>
</html>