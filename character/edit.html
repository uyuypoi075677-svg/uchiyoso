<script type="module">
        import { loadFromCloud, saveToCloud, monitorAuth } from "./firestore.js";

        // DOM要素取得 (エラーが出ないように安全に取得する方式に変更)
        const charSelect = document.getElementById('charSelect');
        const editorArea = document.getElementById('editorArea');

        let allData = {};
        let currentId = null;

        // 平均値データ（簡易目安：日本人20代）
        const AVG_DATA = {
            male: { h: 171.5, w: 64.0 },
            female: { h: 158.0, w: 50.0 }
        };

        // ログイン監視
        monitorAuth((user) => {
            if (user) {
                init();
            } else {
                if(charSelect) charSelect.innerHTML = '<option>LOGIN REQUIRED</option>';
            }
        });

        async function init() {
            try {
                const data = await loadFromCloud();
                allData = data || {};
                renderSelect();
            } catch (e) { console.error(e); }
        }

        function renderSelect() {
            if(!charSelect) return;
            charSelect.innerHTML = '<option value="">-- SELECT CHARACTER --</option>';
            Object.values(allData).forEach(char => {
                const opt = document.createElement('option');
                opt.value = char.id;
                opt.textContent = char.name;
                charSelect.appendChild(opt);
            });
            if(currentId) charSelect.value = currentId;
        }

        if(charSelect) {
            charSelect.addEventListener('change', (e) => {
                currentId = e.target.value;
                if(!currentId) {
                    if(editorArea) {
                        editorArea.style.opacity = '0.3';
                        editorArea.style.pointerEvents = 'none';
                    }
                    return;
                }
                loadCharacterToForm(allData[currentId]);
            });
        }

        // --- ロジック: データ読み込み (安全版) ---
        function loadCharacterToForm(d) {
            if(!d || !editorArea) return;

            editorArea.style.opacity = '1';
            editorArea.style.pointerEvents = 'auto';

            // ★ここが修正点: 1つ見つからなくても止まらない「安全なセット関数」を使います
            // 基本フィールド
            safeSetVal('inpName', d.name);
            safeSetVal('inpKana', d.kana);
            safeSetVal('inpJob', d.job);
            safeSetVal('inpTags', d.tags);
            safeSetVal('inpAge', d.age);
            safeSetVal('inpGender', d.gender);
            safeSetVal('inpBirthday', d.birthday);
            safeSetVal('inpOrigin', d.birthplace);
            safeSetVal('inpHeight', d.height);
            safeSetVal('inpWeight', d.weight);
            safeSetVal('inpHair', d.colorHair);
            safeSetVal('inpEye', d.colorEye);
            safeSetVal('inpSkin', d.colorSkin);

            // 画像
            safeSetVal('inpImageBody', d.image);
            safeSetVal('inpImageIcon', d.icon);
            safeSetSrc('previewBody', d.image);
            safeSetSrc('previewIcon', d.icon);

            // ステータス
            const s = d.stats || {};
            safeSetVal('s_str', s.STR); safeSetVal('s_con', s.CON); safeSetVal('s_pow', s.POW);
            safeSetVal('s_dex', s.DEX); safeSetVal('s_app', s.APP); safeSetVal('s_siz', s.SIZ);
            safeSetVal('s_int', s.INT); safeSetVal('s_edu', s.EDU);

            // バイタル
            const v = d.vitals || {};
            safeSetVal('v_hp', v.hp); safeSetVal('v_mp', v.mp); safeSetVal('v_san', v.san);
            safeSetVal('v_db', d.db || '±0');

            // メモの分解ロジック
            const fullMemo = d.memo || '';
            
            function extractSection(tag) {
                const regex = new RegExp(`\\[${tag}\\]\\n([\\s\\S]*?)(\\n\\[|$)`);
                const match = fullMemo.match(regex);
                return match ? match[1].trim() : '';
            }

            safeSetVal('txtBackground', extractSection('経歴'));
            safeSetVal('txtPersonality', extractSection('性格'));
            safeSetVal('txtRelations', extractSection('人間関係'));
            safeSetVal('txtAppearance', extractSection('外見'));
            safeSetVal('txtRoleplay', extractSection('RP用補足') || extractSection('RP補足'));
            safeSetVal('txtSkillDetails', extractSection('技能詳細') || extractSection('職業P振り分け詳細'));
            
            if (!fullMemo.includes('[')) {
                safeSetVal('txtMemo', fullMemo);
            } else {
                safeSetVal('txtMemo', extractSection('メモ'));
            }

            safeSetVal('txtSpells', d.spells);
            safeSetVal('txtScenarios', d.scenarios);
            
            if(Array.isArray(d.items)) {
                safeSetVal('txtItems', d.items.map(i => i.name).join('\n'));
            } else {
                safeSetVal('txtItems', '');
            }

            updateCalculations();
        }

        // --- ロジック: データ保存 ---
        window.prepareSaveData = function() {
            if(!currentId) return null;
            const char = allData[currentId];

            char.name = getSafeVal('inpName');
            char.kana = getSafeVal('inpKana');
            char.job = getSafeVal('inpJob');
            char.tags = getSafeVal('inpTags');
            char.age = getSafeVal('inpAge');
            char.gender = getSafeVal('inpGender');
            char.birthday = getSafeVal('inpBirthday');
            char.birthplace = getSafeVal('inpOrigin');
            char.height = getSafeVal('inpHeight');
            char.weight = getSafeVal('inpWeight');
            char.colorHair = getSafeVal('inpHair');
            char.colorEye = getSafeVal('inpEye');
            char.colorSkin = getSafeVal('inpSkin');

            char.image = getSafeVal('inpImageBody');
            char.icon = getSafeVal('inpImageIcon');

            char.stats = {
                STR: parseInt(getSafeVal('s_str'))||0, CON: parseInt(getSafeVal('s_con'))||0, POW: parseInt(getSafeVal('s_pow'))||0,
                DEX: parseInt(getSafeVal('s_dex'))||0, APP: parseInt(getSafeVal('s_app'))||0, SIZ: parseInt(getSafeVal('s_siz'))||0,
                INT: parseInt(getSafeVal('s_int'))||0, EDU: parseInt(getSafeVal('s_edu'))||0
            };
            char.vitals = char.vitals || {};
            char.vitals.hp = parseInt(getSafeVal('v_hp'))||0;
            char.vitals.mp = parseInt(getSafeVal('v_mp'))||0;
            char.vitals.san = parseInt(getSafeVal('v_san'))||0;
            char.db = getSafeVal('v_db');

            // メモ再結合
            let combinedMemo = "";
            const parts = [
                {t:'経歴', v: getSafeVal('txtBackground')},
                {t:'性格', v: getSafeVal('txtPersonality')},
                {t:'人間関係', v: getSafeVal('txtRelations')},
                {t:'外見', v: getSafeVal('txtAppearance')},
                {t:'RP用補足', v: getSafeVal('txtRoleplay')},
                {t:'技能詳細', v: getSafeVal('txtSkillDetails')},
                {t:'メモ', v: getSafeVal('txtMemo')}
            ];
            
            parts.forEach(p => {
                if(p.v) combinedMemo += `[${p.t}]\n${p.v}\n\n`;
            });
            
            char.memo = combinedMemo.trim();
            char.spells = getSafeVal('txtSpells');
            char.scenarios = getSafeVal('txtScenarios');

            const itemsStr = getSafeVal('txtItems');
            char.items = itemsStr.split('\n').filter(t => t.trim()!=='').map(t => ({name: t, desc: ''}));

            alert("保存しました！");
            return char;
        };

        // --- 便利機能: 計算とヒント ---
        function updateCalculations() {
            // 安全に値を取得
            const pow = parseInt(getSafeVal('s_pow'))||0;
            const int = parseInt(getSafeVal('s_int'))||0;
            const edu = parseInt(getSafeVal('s_edu'))||0;
            safeSetText('val_luck', pow * 5);
            safeSetText('val_idea', int * 5);
            safeSetText('val_know', edu * 5);

            // EDU年齢チェック
            const age = parseInt(getSafeVal('inpAge'));
            const eduHint = document.getElementById('eduHint');
            if(eduHint) {
                if(age && edu) {
                    const minAge = edu + 6;
                    if(age < minAge) {
                        eduHint.style.display = 'block';
                        eduHint.className = 'calc-hint warn-hint';
                        eduHint.textContent = `⚠️ EDU${edu}の最低年齢は${minAge}歳です`;
                    } else {
                        eduHint.style.display = 'block';
                        eduHint.className = 'calc-hint';
                        eduHint.textContent = `✅ EDU${edu} (最低年齢: ${minAge}歳)`;
                    }
                } else {
                    eduHint.style.display = 'none';
                }
            }

            // BMI計算
            const h = parseFloat(getSafeVal('inpHeight'));
            const w = parseFloat(getSafeVal('inpWeight'));
            const gender = getSafeVal('inpGender');
            
            let avgH = 0, avgW = 0;
            if(gender && (gender.includes('男') || gender.includes('male'))) {
                avgH = AVG_DATA.male.h; avgW = AVG_DATA.male.w;
            } else {
                avgH = AVG_DATA.female.h; avgW = AVG_DATA.female.w;
            }
            
            if(h) safeSetText('heightAvg', `(平均: ${avgH}cm)`);
            if(w) safeSetText('weightAvg', `(平均: ${avgW}kg)`);

            const bmiEl = document.getElementById('outBMI');
            if(bmiEl) {
                if(h > 0 && w > 0) {
                    const bmi = w / ((h/100) * (h/100));
                    let type = "普通";
                    if(bmi < 18.5) type = "低体重";
                    else if(bmi >= 25) type = "肥満";
                    bmiEl.value = `BMI: ${bmi.toFixed(1)} (${type})`;
                } else {
                    bmiEl.value = "";
                }
            }
        }

        // --- 安全な操作ヘルパー関数（これが今回のキモです） ---
        function safeSetVal(id, val) {
            const el = document.getElementById(id);
            if(el) {
                el.value = (val === undefined || val === null) ? '' : val;
            }
        }
        function safeSetText(id, text) {
            const el = document.getElementById(id);
            if(el) el.textContent = text;
        }
        function safeSetSrc(id, src) {
            const el = document.getElementById(id);
            if(el) el.src = src || '';
        }
        function getSafeVal(id) {
            const el = document.getElementById(id);
            return el ? el.value : '';
        }

        // イベントリスナー登録 (エラーが出ても止まらないようにtry-catchは不要だが、念のため安全に)
        const watchIds = ['inpAge','s_edu','inpHeight','inpWeight','inpGender','s_pow','s_int'];
        watchIds.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', updateCalculations);
        });

        // 画像プレビュー
        const ib = document.getElementById('inpImageBody');
        if(ib) ib.addEventListener('input', (e)=> safeSetSrc('previewBody', e.target.value));
        const ii = document.getElementById('inpImageIcon');
        if(ii) ii.addEventListener('input', (e)=> safeSetSrc('previewIcon', e.target.value));

        // 新規作成
        const btnNew = document.getElementById('btnCreateNew');
        if(btnNew) {
            btnNew.addEventListener('click', () => {
                const newId = crypto.randomUUID();
                const newChar = {
                    id: newId, name: "新規キャラクター",
                    stats: {STR:10, CON:10, POW:10, DEX:10, APP:10, SIZ:10, INT:10, EDU:10},
                    vitals: {hp:10, mp:10, san:50},
                    items: [], skills: {combat:[], explore:[], action:[], negotiate:[], knowledge:[]}
                };
                allData[newId] = newChar;
                currentId = newId;
                renderSelect();
                loadCharacterToForm(newChar);
            });
        }
        
        const btnDel = document.getElementById('btnDelete');
        if(btnDel) {
            btnDel.addEventListener('click', async () => {
                if(!currentId) return;
                if(confirm('削除しますか？')) {
                    delete allData[currentId];
                    alert('削除しました。反映にはリロードが必要です。');
                    location.reload();
                }
            });
        }

    </script>