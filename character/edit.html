<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DATA EDITOR</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link href="edit/header.css" rel="stylesheet">

    <style>
        body { background-color: #202020; color: #ddd; font-family: 'Noto Sans JP', sans-serif; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 0 auto; padding: 80px 20px 100px; }
        .toolbar { background: #333; padding: 20px; border-radius: 4px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; }
        select { padding: 10px; background: #111; color: #fff; border: 1px solid #555; width: 300px; border-radius: 4px; }
        
        .btn-new { background: #44ff44; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        /* ã€è¿½åŠ ã€‘ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn-save { background: #00f3ff; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; margin-left: 10px;}
        .btn-save:hover { background: #88ffff; }
        
        .btn-delete { background: #ff4444; color: #fff; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        
        .import-area { background: #2a2a2d; padding: 20px; border-radius: 4px; border: 2px dashed #666; margin-bottom: 30px; transition: 0.3s; }
        .import-area.dragover { background: #3a3a40; border-color: #00f3ff; box-shadow: 0 0 10px rgba(0, 243, 255, 0.3); }
        .import-area textarea { height: 100px; font-size: 0.8rem; color: #aaa; width: 100%; box-sizing: border-box; background: #222; border: 1px solid #444; padding: 10px; margin-top: 10px; }
        .btn-merge { background: #00f3ff; color: #000; border: none; padding: 8px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; }
        
        h2 { border-bottom: 2px solid #555; padding-bottom: 10px; margin-top: 40px; color: #aaa; font-size: 1.1rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-row { margin-bottom: 15px; position: relative; }
        .form-row.full { grid-column: span 2; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        label { display: block; color: #888; font-size: 0.75rem; margin-bottom: 5px; font-family: 'Roboto Mono', monospace; }
        input[type="text"], input[type="number"] { width: 100%; padding: 10px; box-sizing: border-box; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 0.95rem; }
        textarea { width: 100%; padding: 10px; box-sizing: border-box; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 0.9rem; line-height: 1.6; min-height: 80px; resize: vertical; }
        .analysis-box { background: #252525; padding: 15px; border-radius: 4px; border: 1px solid #444; margin-top: 5px; font-size: 0.85rem; color: #ccc; }
        .calc-val { color: #44ff44; font-weight: bold; margin-left: 5px; }
        .warn-text { color: #ffaa00; }
        
        .visual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; background: #252525; padding: 20px; border-radius: 4px; border: 1px solid #444; }
        .img-preview-box { width: 100%; height: 200px; background: #000; border: 1px solid #444; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .img-preview { max-width: 100%; max-height: 100%; object-fit: contain; }
        .drop-msg { position: absolute; color: #666; font-size: 0.8rem; pointer-events: none; }
        
        .stats-container { display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; background: #252525; padding: 15px; border-radius: 4px; }
        .stat-box { text-align: center; }
        .stat-box input { text-align: center; font-weight: bold; color: #44ff44; font-size: 1.1rem; }
        
        .text-section { border-left: 3px solid #444; padding-left: 15px; margin-bottom: 20px; position: relative; }
        .text-section h3 { font-size: 0.9rem; color: #44ff44; margin: 0 0 10px 0; opacity: 0.8; display: inline-block; }
        .btn-clear-text {
            position: absolute; top: 0; right: 0;
            background: transparent; border: 1px solid #555; color: #888;
            font-size: 0.7rem; cursor: pointer; padding: 2px 6px; border-radius: 4px;
        }
        .btn-clear-text:hover { background: #442222; color: #ff8888; border-color: #ff4444; }

        .list-container { background: #252525; border: 1px solid #444; border-radius: 4px; padding: 10px; margin-top: 5px; }
        .item-entry { 
            display: grid; grid-template-columns: 1fr 2fr 30px; gap: 10px; 
            margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #333; align-items: center; 
        }
        .btn-add { background: #444; color: #fff; border: none; width: 100%; padding: 5px; cursor: pointer; font-size: 0.8rem; margin-top: 5px; }
        .btn-add:hover { background: #555; }
        .btn-remove { background: #552222; color: #ffaaaa; border: 1px solid #774444; padding: 0; height: 30px; width: 30px; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .btn-remove:hover { background: #ff4444; color: #fff; }

        .weapon-header { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 30px; gap: 5px; font-size: 0.7rem; color: #888; margin-bottom: 5px; padding: 0 5px; }
        .weapon-entry { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 30px; gap: 5px; margin-bottom: 5px; align-items: center; }
        .weapon-entry input { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 5px; font-size: 0.8rem; width: 100%; box-sizing: border-box; }

        .skill-category { margin-bottom: 20px; }
        .skill-category h4 { margin: 5px 0; color: #44ff44; font-size: 0.9rem; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .skill-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
        .skill-table th { color: #888; text-align: center; font-weight: normal; font-size: 0.7rem; padding: 4px; }
        .skill-table td { padding: 2px; }
        .skill-table input[type="number"] { text-align: center; color: #44ff44; padding: 4px; width: 100%; box-sizing: border-box; background: #1a1a1a; border: 1px solid #333; }
        .skill-desc-input { width: 100%; color: #ddd; font-size: 0.8rem; background: #1a1a1a; border: 1px solid #444; padding: 4px; box-sizing: border-box; }
        .btn-add-skill { 
            background: #333; border: 1px solid #555; color: #aaa; 
            font-size: 0.7rem; padding: 2px 8px; cursor: pointer; border-radius: 4px; margin-left: 10px;
        }
        .btn-add-skill:hover { background: #444; color: #fff; border-color: #777; }
        
        .skill-cat-select {
            background: #111; color: #888; border: 1px solid #333; font-size: 0.7rem; padding: 2px; width: 100%;
        }

        input[type="color"] { width: 100%; height: 40px; padding: 2px; background: #2a2a2a; border: 1px solid #444; cursor: pointer; }
    </style>
</head>
<body>
    <script type="module">import { initHeader } from "./header.js"; initHeader();</script>

    <div class="container">
        <div class="toolbar">
            <div>
                <label>EDIT TARGET</label>
                <select id="charSelect"><option value="">LOADING...</option></select>
            </div>
            <div>
                <!-- ã€ä¿®æ­£ã€‘ä¿å­˜ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸ -->
                <button type="button" class="btn-save" onclick="prepareSaveData()">SAVE CLOUD</button>
                <button id="btnCreateNew" class="btn-new">+ NEW</button>
            </div>
        </div>

        <div id="editorArea" style="opacity:0.3; pointer-events:none;">
            
            <div id="dropZone" class="import-area">
                <h3 style="margin-top:0; color:#00f3ff;">SMART IMPORT (Drop .txt File Here)</h3>
                <p style="font-size:0.8rem; color:#888; margin-bottom:5px;">ã„ã‚ãã‚ƒã‚‰ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«(.txt)ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
                <textarea id="txtImportSource" placeholder="ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘..."></textarea>
                <button id="btnMerge" class="btn-merge">âœ¨ FILL MISSING INFO (è§£æï¼†è£œå®Œ)</button>
            </div>

            <h2>BASIC PROFILE</h2>
            <div class="form-grid">
                <div class="form-row"><label>NAME</label><input type="text" id="inpName"></div>
                <div class="form-row"><label>KANA</label><input type="text" id="inpKana"></div>
            </div>
            <div class="form-grid">
                <div class="form-row"><label>JOB</label><input type="text" id="inpJob"></div>
                <div class="form-row"><label>TAGS</label><input type="text" id="inpTags"></div>
            </div>

            <div class="grid-4" style="margin-top:15px;">
                <div class="form-row"><label>AGE</label><input type="text" id="inpAge" placeholder="å¹´é½¢(ä¸è©³å¯)"></div>
                <div class="form-row"><label>GENDER</label><input type="text" id="inpGender"></div>
                <div class="form-row"><label>MONEY (æ‰€æŒé‡‘)</label><input type="text" id="inpMoney"></div>
                <div class="form-row"><label>DEBT (å€Ÿé‡‘)</label><input type="text" id="inpDebt"></div>
            </div>
            
            <div class="grid-4" style="margin-top:15px;">
                <div class="form-row"><label>BIRTHDAY</label><input type="text" id="inpBirthday"></div>
                <div class="form-row"><label>BIRTHPLACE</label><input type="text" id="inpOrigin"></div>
                <div class="form-row"><label>THEME COLOR</label><input type="color" id="inpThemeColor" value="#d9333f"></div>
            </div>

            <div id="eduCheckArea" class="analysis-box" style="display:none;"><span>ğŸ“ EDUåˆ†æ:</span><span id="eduMsg"></span></div>

            <div class="grid-3" style="margin-top:20px; background:#2b2b2b; padding:15px; border-radius:4px;">
                <div class="form-row"><label>HEIGHT (cm)</label><input type="number" id="inpHeight"></div>
                <div class="form-row"><label>WEIGHT (kg)</label><input type="number" id="inpWeight"></div>
                <div class="form-row"><label>HAIR / EYE / SKIN</label>
                    <input type="text" id="inpHair" placeholder="é«ªè‰²" style="margin-bottom:5px;">
                    <input type="text" id="inpEye" placeholder="ç³ã®è‰²" style="margin-bottom:5px;">
                    <input type="text" id="inpSkin" placeholder="è‚Œã®è‰²">
                </div>
            </div>
            <div id="bodyCheckArea" class="analysis-box">
                <div style="margin-bottom:5px;">ğŸ“Š <b>BMI:</b> <span id="outBMI" class="calc-val">--</span></div>
            </div>

            <h2>VISUALS (Drag & Drop Image)</h2>
            <div class="visual-grid">
                <div>
                    <label>STANDING ART (ç«‹ã¡çµµ)</label>
                    <div class="img-preview-box" id="dropBody">
                        <span class="drop-msg">Drop Image Here</span>
                        <img id="previewBody" class="img-preview">
                    </div>
                    <input type="text" id="inpImageBody" placeholder="URL or Base64..." style="margin-top:5px;">
                </div>
                <div>
                    <label>FACE ICON (é¡”ã‚¢ã‚¤ã‚³ãƒ³)</label>
                    <div class="img-preview-box" id="dropIcon">
                        <span class="drop-msg">Drop Image Here</span>
                        <img id="previewIcon" class="img-preview">
                    </div>
                    <input type="text" id="inpImageIcon" placeholder="URL or Base64..." style="margin-top:5px;">
                </div>
            </div>

            <h2>STATS & VITALS</h2>
            <div class="stats-container">
                <div class="stat-box"><label>STR</label><input type="number" id="s_str"></div>
                <div class="stat-box"><label>CON</label><input type="number" id="s_con"></div>
                <div class="stat-box"><label>POW</label><input type="number" id="s_pow"></div>
                <div class="stat-box"><label>DEX</label><input type="number" id="s_dex"></div>
                <div class="stat-box"><label>APP</label><input type="number" id="s_app"></div>
                <div class="stat-box"><label>SIZ</label><input type="number" id="s_siz"></div>
                <div class="stat-box"><label>INT</label><input type="number" id="s_int"></div>
                <div class="stat-box"><label>EDU</label><input type="number" id="s_edu"></div>
            </div>
            <div class="grid-4" style="margin-top:20px;">
                <div class="form-row"><label>HP</label><input type="number" id="v_hp"></div>
                <div class="form-row"><label>MP</label><input type="number" id="v_mp"></div>
                <div class="form-row"><label>SAN</label><input type="number" id="v_san"></div>
                <div class="form-row"><label>DB</label><input type="text" id="v_db"></div>
            </div>

            <h2>DETAILS</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <div class="text-section">
                        <h3>çµŒæ­´</h3><button class="btn-clear-text" onclick="document.getElementById('txtBackground').value=''">Ã— CLEAR</button>
                        <textarea id="txtBackground"></textarea>
                    </div>
                    <div class="text-section">
                        <h3>æ€§æ ¼</h3><button class="btn-clear-text" onclick="document.getElementById('txtPersonality').value=''">Ã— CLEAR</button>
                        <textarea id="txtPersonality"></textarea>
                    </div>
                    <div class="text-section">
                        <h3>äººé–“é–¢ä¿‚</h3><button class="btn-clear-text" onclick="document.getElementById('txtRelations').value=''">Ã— CLEAR</button>
                        <textarea id="txtRelations"></textarea>
                    </div>
                </div>
                <div>
                    <div class="text-section">
                        <h3>å¤–è¦‹çš„ç‰¹å¾´</h3><button class="btn-clear-text" onclick="document.getElementById('txtAppearance').value=''">Ã— CLEAR</button>
                        <textarea id="txtAppearance"></textarea>
                    </div>
                    <div class="text-section">
                        <h3>RPè£œè¶³</h3><button class="btn-clear-text" onclick="document.getElementById('txtRoleplay').value=''">Ã— CLEAR</button>
                        <textarea id="txtRoleplay"></textarea>
                    </div>
                    <div class="text-section">
                        <h3>ãƒ¡ãƒ¢</h3><button class="btn-clear-text" onclick="document.getElementById('txtMemo').value=''">Ã— CLEAR</button>
                        <textarea id="txtMemo"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="form-row full">
                <div class="text-section">
                    <h3>æŠ€èƒ½ãƒ‡ãƒ¼ã‚¿ (SKILLS & DETAIL)</h3>
                    <div id="skillArea" class="list-container" style="max-height: 600px; overflow-y: auto;">
                        </div>
                </div>
            </div>

            <div class="text-section" style="margin-top:20px; border-left-color: #d4b346;">
                <h3 style="color: #d4b346;">æŠ€èƒ½æˆé•·å±¥æ­´ (GROWTH LOG)</h3>
                <button class="btn-clear-text" onclick="document.getElementById('txtGrowth').value=''">Ã— CLEAR</button>
                <textarea id="txtGrowth" style="height:120px;" placeholder="ä¾‹ï¼š&#13;ã‚·ãƒŠãƒªã‚ªA: å›é¿+5, ç›®æ˜Ÿ+3"></textarea>
            </div>

            <h2>INVENTORY & HISTORY</h2>
            <div class="grid-3">
                <div class="form-row full" style="grid-column:span 2;">
                    <label>æ‰€æŒå“ (ITEMS)</label>
                    <div class="list-container">
                        <div id="itemList"></div>
                        <button type="button" class="btn-add" onclick="addItemRow()">+ ADD ITEM</button>
                        <textarea id="txtItems" style="display:none;"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <label>é­”è¡“/AF (SPELLS/ARTIFACTS)</label>
                    <textarea id="txtSpells" style="height:90px;"></textarea>
                    
                    <label style="margin-top:10px;">é­é‡ã—ãŸå­˜åœ¨ (ENTITIES)</label>
                    <textarea id="txtEncountered" style="height:90px;"></textarea>
                </div>
            </div>

            <div class="form-row full" style="margin-top:15px;">
                <label>æˆ¦é—˜ãƒ»æ­¦å™¨ãƒ»é˜²å…· (WEAPONS)</label>
                <div class="list-container">
                    <div class="weapon-header">
                        <div>åå‰</div><div>æˆåŠŸç‡</div><div>ãƒ€ãƒ¡</div><div>å°„ç¨‹</div><div>å›æ•°</div><div>è£…å¼¾</div><div>HP</div><div>æ•…éšœ</div><div></div>
                    </div>
                    <div id="weaponList"></div>
                    <button type="button" class="btn-add" onclick="addWeaponRow()">+ ADD WEAPON</button>
                </div>
            </div>

            <div class="form-row full" style="margin-top:20px;">
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:5px;">
                    <label style="margin:0;">é€šéã‚·ãƒŠãƒªã‚ªè©³ç´° (SCENARIO LOGS)</label>
                    <a href="../scenario/register.html" target="_blank" style="font-size:0.75rem; color:#00f3ff; text-decoration:none; border:1px solid #00f3ff; padding:2px 8px; border-radius:4px;">+ DBç™»éŒ²</a>
                </div>

                <!-- â˜…çµ±åˆã‚³ãƒ³ãƒ†ãƒŠ: æ ç·šã§å›²ã‚€ -->
                <div style="border: 1px solid #444; background: #2a2a2a; border-radius: 4px; overflow: hidden;">
                    
                    <!-- â‘  ä¸Šéƒ¨: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®è‡ªå‹•å–å¾—ãƒªã‚¹ãƒˆ -->
                    <div id="firestore-scenario-list" style="
                        background: rgba(0, 243, 255, 0.05); 
                        padding: 10px; 
                        border-bottom: 1px solid #444; 
                        min-height: 40px;
                        max-height: 300px;
                        overflow-y: auto;
                    ">
                        <div style="color:#666; font-size:0.8rem;">(DBã«ç™»éŒ²ã•ã‚ŒãŸã‚·ãƒŠãƒªã‚ªãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™)</div>
                    </div>

                    <!-- â‘¡ ä¸‹éƒ¨: å¾“æ¥ã®æ‰‹å‹•å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ -->
                    <textarea id="txtScenarioDetails" style="
                        width: 100%; 
                        height: 150px; 
                        border: none; 
                        background: transparent; 
                        padding: 10px; 
                        resize: vertical;
                        outline: none;
                    " placeholder="ã“ã¡ã‚‰ã¯è‡ªç”±è¨˜è¿°æ¬„ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ã‚ãªã„éå»ãƒ­ã‚°ã‚„ã€è£œè¶³äº‹é …ãªã©ã¯ã“ã“ã«è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚"></textarea>
                </div>

                <!-- ç°¡æ˜“ä¸€è¦§ã¯ãã®ã¾ã¾ä¸‹ã«é…ç½® -->
                <div class="form-row" style="margin-top:15px;">
                    <label>é€šéã‚·ãƒŠãƒªã‚ª(ç°¡æ˜“ä¸€è¦§)</label>
                    <textarea id="txtScenarios" style="height:60px;" placeholder="ã‚·ãƒŠãƒªã‚ªå..."></textarea>
                </div>
            </div>

            <div style="margin-top:50px; text-align:right;">
                <button id="btnDelete" class="btn-delete">DELETE CHARACTER</button>
            </div>

            
        </div>
    </div>

    <script type="module">
        // ã€ä¿®æ­£ã€‘deleteFromCloud ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«è¿½åŠ 
        import { loadFromCloud, monitorAuth, saveToCloud, deleteFromCloud, getScenariosForCharacter } from "./firestore.js";
        import { collectFormData, FIELD_MAPPING, STATS_MAPPING, VITALS_MAPPING } from "./data/schema.js";
        import { parseIaChara } from "./data/parser_ia.js";

        const getEl = (id) => document.getElementById(id);
        const setVal = (id, v) => { const el = getEl(id); if(el) el.value = (v == null ? '' : v); };
        const setSrc = (id, s) => { const el = getEl(id); if(el) el.src = s || ''; };

        const MEMO_ID_MAP = {
            background: 'txtBackground',
            personality: 'txtPersonality',
            relations: 'txtRelations',
            appearance: 'txtAppearance',
            roleplay: 'txtRoleplay',
            memo: 'txtMemo'
        };

        let allData = {};
        let currentId = null;

        window.addItemRow = (val={name:'', desc:''}) => {
            const div = document.createElement('div');
            div.className = 'item-entry';
            div.innerHTML = `
                <input type="text" class="i-name" placeholder="åç§°" value="${val.name}">
                <input type="text" class="i-desc" placeholder="åŠ¹æœãƒ»å‚™è€ƒ" value="${val.desc}">
                <button class="btn-remove" onclick="this.parentElement.remove()">âœ•</button>
            `;
            getEl('itemList').appendChild(div);
        };

        window.addWeaponRow = (val={name:'', rate:'', damage:'', range:'', attacks:'', capacity:'', hp:'', malfunction:''}) => {
            const div = document.createElement('div');
            div.className = 'weapon-entry';
            div.innerHTML = `
                <input type="text" class="w-name" value="${val.name}">
                <input type="text" class="w-rate" value="${val.rate}">
                <input type="text" class="w-dmg" value="${val.damage}">
                <input type="text" class="w-range" value="${val.range}">
                <input type="text" class="w-atk" value="${val.attacks}">
                <input type="text" class="w-cap" value="${val.capacity}">
                <input type="text" class="w-hp" value="${val.hp}">
                <input type="text" class="w-mal" value="${val.malfunction}">
                <button class="btn-remove" onclick="this.parentElement.remove()">âœ•</button>
            `;
            getEl('weaponList').appendChild(div);
        };

        function attachSkillCalc(row) {
            row.querySelectorAll('input[type="number"]').forEach(inp => {
                inp.addEventListener('input', () => {
                    const init = parseInt(row.querySelector('.s-init').value)||0;
                    const job = parseInt(row.querySelector('.s-job').value)||0;
                    const int = parseInt(row.querySelector('.s-interest').value)||0;
                    const gro = parseInt(row.querySelector('.s-growth').value)||0;
                    row.querySelector('.s-total').value = init + job + int + gro;
                });
            });
        }

        window.addSkillRow = (catId) => {
            const table = document.querySelector(`#skill-cat-${catId} tbody`);
            if(!table) return;
            
            const tr = document.createElement('tr');
            tr.className = 'skill-entry';
            tr.innerHTML = `
                <td class="s-name" style="font-weight:bold;">
                    <span class="s-name-text"><input type="text" class="s-name-edit" style="width:100%; color:#fff; background:#222; border:1px solid #444;" placeholder="æŠ€èƒ½å"></span>
                </td>
                <td><input type="number" class="s-total" readonly tabindex="-1"></td>
                <td><input type="number" class="s-init" value="0" style="color:#888;"></td>
                <td><input type="number" class="s-job" value="0"></td>
                <td><input type="number" class="s-interest" value="0"></td>
                <td><input type="number" class="s-growth" value="0"></td>
                <td style="padding-left:10px;"><input type="text" class="s-desc skill-desc-input" placeholder="è¨­å®šã‚„ç†ç”±ãªã©...">
                <button onclick="this.closest('tr').remove()" style="float:right; background:transparent; border:none; color:#522; cursor:pointer;">Ã—</button></td>
            `;
            table.appendChild(tr);
            attachSkillCalc(tr);
        };

        window.moveCategory = (selectEl) => {
            const targetCat = selectEl.value;
            if(!targetCat) return;

            const row = selectEl.closest('tr');
            let name = "";
            const nameSpan = row.querySelector('.s-name-text');
            if (nameSpan) {
                const nameInput = nameSpan.querySelector('input');
                name = nameInput ? nameInput.value : nameSpan.textContent;
            }

            const total = row.querySelector('.s-total').value;
            const init = row.querySelector('.s-init').value;
            const job = row.querySelector('.s-job').value;
            const interest = row.querySelector('.s-interest').value;
            const growth = row.querySelector('.s-growth').value;
            const desc = row.querySelector('.s-desc').value;

            const targetTable = document.querySelector(`#skill-cat-${targetCat} tbody`);
            if(targetTable) {
                row.remove();
                
                const tr = document.createElement('tr');
                tr.className = 'skill-entry';
                tr.innerHTML = `
                    <td class="s-name" style="font-weight:bold;">
                        <span class="s-name-text">${name}</span>
                        <div style="margin-top:2px;">
                            <select class="skill-cat-select" onchange="moveCategory(this)">
                                <option value="">ã‚«ãƒ†ã‚´ãƒªç§»å‹•...</option>
                                <option value="combat">æˆ¦é—˜</option>
                                <option value="explore">æ¢ç´¢</option>
                                <option value="action">è¡Œå‹•</option>
                                <option value="negotiate">äº¤æ¸‰</option>
                                <option value="knowledge">çŸ¥è­˜</option>
                                <option value="original">ãã®ä»–</option>
                            </select>
                        </div>
                    </td>
                    <td><input type="number" class="s-total" value="${total}" readonly tabindex="-1"></td>
                    <td><input type="number" class="s-init" value="${init}" readonly tabindex="-1" style="color:#888;"></td>
                    <td><input type="number" class="s-job" value="${job}"></td>
                    <td><input type="number" class="s-interest" value="${interest}"></td>
                    <td><input type="number" class="s-growth" value="${growth}"></td>
                    <td style="padding-left:10px;"><input type="text" class="s-desc skill-desc-input" value="${desc}" placeholder="è¨­å®šã‚„ç†ç”±ãªã©..."></td>
                `;
                targetTable.appendChild(tr);
                attachSkillCalc(tr);
            }
        };

        // --- ä¿å­˜å‡¦ç†ã®ä¿®æ­£ ---
        window.prepareSaveData = function() {
            if(!currentId) {
                alert("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return null;
            }
            const originalData = Object.values(allData).find(c=>c.id==currentId);
            if(!originalData) return null;
            
            // ã‚¢ã‚¤ãƒ†ãƒ åé›†
            const itemRows = document.querySelectorAll('.item-entry');
            const itemsArr = [];
            itemRows.forEach(row => {
                const n = row.querySelector('.i-name').value;
                const d = row.querySelector('.i-desc').value;
                if(n) itemsArr.push(d ? `${n} : ${d}` : n);
            });
            getEl('txtItems').value = itemsArr.join('\n');

            // æŠ€èƒ½ãƒ‡ãƒ¼ã‚¿åé›†
            const skillsObj = {
                combat:[], explore:[], action:[], negotiate:[], knowledge:[], original:[]
            };
            document.querySelectorAll('.skill-category').forEach(catDiv => {
                const catId = catDiv.id.replace('skill-cat-', '');
                if(skillsObj[catId] === undefined) skillsObj[catId] = [];
                
                catDiv.querySelectorAll('.skill-entry').forEach(row => {
                    const nameSpan = row.querySelector('.s-name-text');
                    let name = "";
                    if (nameSpan) {
                         const nameInput = nameSpan.querySelector('input');
                         name = nameInput ? nameInput.value : nameSpan.textContent;
                    }
                    
                    skillsObj[catId].push({
                        name: name.trim(),
                        total: parseInt(row.querySelector('.s-total').value)||0,
                        init: parseInt(row.querySelector('.s-init').value)||0,
                        job: parseInt(row.querySelector('.s-job').value)||0,
                        interest: parseInt(row.querySelector('.s-interest').value)||0,
                        growth: parseInt(row.querySelector('.s-growth').value)||0,
                        desc: row.querySelector('.s-desc').value
                    });
                });
            });
            
            const finalData = collectFormData(originalData, true);
            finalData.skills = skillsObj;

            // åå‰ãŒç©ºã ã¨ä¿å­˜ã§ããªã„ãŸã‚ãƒã‚§ãƒƒã‚¯
            if (!finalData.name) {
                alert("ã‚¨ãƒ©ãƒ¼ï¼šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å(NAME)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            saveToCloud(finalData).then(() => {
                // ä¿å­˜å®Œäº†å¾Œã®ãƒªãƒ­ãƒ¼ãƒ‰ (åˆ†å‰²ä¿å­˜ã®å ´åˆã¯ãƒªã‚¹ãƒˆã‚’å†å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚)
                location.reload();
            });
        };

        monitorAuth((user) => {
            if(user) init();
            else getEl('charSelect').innerHTML = '<option>LOGIN REQUIRED</option>';
        });

        async function init() {
            try {
                // loadFromCloud ã¯ { åå‰: ãƒ‡ãƒ¼ã‚¿, åå‰2: ãƒ‡ãƒ¼ã‚¿ } ã®å½¢å¼ã§è¿”ã£ã¦ãã¾ã™
                const data = await loadFromCloud();
                allData = data || {};
                renderSelect();
            } catch(e) { console.error(e); }
        }

        function renderSelect() {
            const sel = getEl('charSelect');
            sel.innerHTML = '<option value="">-- SELECT CHARACTER --</option>';
            // allData ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã®ã§é…åˆ—ã«å¤‰æ›ã—ã¦å›ã™
            Object.values(allData).forEach(c => {
                const opt = document.createElement('option');
                // IDã¨ã—ã¦UUIDã‚’ä½¿ç”¨ (saveæ™‚ã‚‚UUIDã¯ç¶­æŒã•ã‚Œã¾ã™)
                opt.value = c.id;
                opt.textContent = c.name;
                sel.appendChild(opt);
            });
            if(currentId) sel.value = currentId;
        }

        getEl('charSelect').addEventListener('change', (e) => {
            currentId = e.target.value;
            if(!currentId) {
                getEl('editorArea').style.opacity='0.3';
                getEl('editorArea').style.pointerEvents='none';
                return;
            }
            const target = Object.values(allData).find(c => c.id == currentId);
            if(target) loadCharacterToForm(target);
        });

        function loadCharacterToForm(d) {
            getEl('editorArea').style.opacity='1';
            getEl('editorArea').style.pointerEvents='auto';
            
            FIELD_MAPPING.forEach(field => {
                setVal(field.id, d[field.key]);
            });
            setSrc('previewBody', d.image);
            setSrc('previewIcon', d.icon);

            setVal('inpThemeColor', d.color || '#d9333f');

            const s = d.stats || {};
            STATS_MAPPING.forEach(f => setVal(f.id, s[f.key]));
            const v = d.vitals || {};
            VITALS_MAPPING.forEach(f => setVal(f.id, v[f.key]));

            const fullMemo = d.memo || '';
            const extract = (tag) => {
                const regex = new RegExp(`\\[${tag}\\]\\n([\\s\\S]*?)(\\n\\[|$)`);
                const m = fullMemo.match(regex);
                return m ? m[1].trim() : '';
            };
            
            setVal('txtBackground', extract('çµŒæ­´'));
            setVal('txtPersonality', extract('æ€§æ ¼'));
            setVal('txtRelations', extract('äººé–“é–¢ä¿‚'));
            setVal('txtAppearance', extract('å¤–è¦‹')||extract('å¤–è¦‹çš„ç‰¹å¾´'));
            setVal('txtRoleplay', extract('RPè£œè¶³')||extract('RPç”¨è£œè¶³'));
            
            if(!fullMemo.includes('[')) setVal('txtMemo', fullMemo);
            else setVal('txtMemo', extract('ãƒ¡ãƒ¢'));

            getEl('itemList').innerHTML = '';
            if(Array.isArray(d.items)) d.items.forEach(i => addItemRow(i));
            else addItemRow();

            getEl('weaponList').innerHTML = '';
            if(Array.isArray(d.weapons)) d.weapons.forEach(w => addWeaponRow(w));
            else addWeaponRow();

            renderSkills(d.skills);

            if(Array.isArray(d.scenarioList)) {
                const text = d.scenarioList.map(scn => `[${scn.title}]\n${scn.desc}`).join('\n\n');
                setVal('txtScenarioDetails', text);
            } else {
                const simpleList = d.scenarios || "";
                if (simpleList && !d.scenarioList) {
                    const converted = simpleList.split('\n')
                        .filter(l => l.trim())
                        .map(l => `[${l.replace(/[\[\]]/g, '')}]\n(è©³ç´°æœªè¨˜å…¥)`).join('\n\n');
                    setVal('txtScenarioDetails', converted);
                } else {
                    setVal('txtScenarioDetails', '');
                }
            }

            runCalculations();
            if(d.id) updateScenarioList(d.id); 
        }

        function renderSkills(skillsObj) {
            const area = getEl('skillArea');
            area.innerHTML = '';
            
            const cats = [
                {id:'combat', label:'æˆ¦é—˜æŠ€èƒ½'}, {id:'explore', label:'æ¢ç´¢æŠ€èƒ½'}, 
                {id:'action', label:'è¡Œå‹•æŠ€èƒ½'}, {id:'negotiate', label:'äº¤æ¸‰æŠ€èƒ½'}, 
                {id:'knowledge', label:'çŸ¥è­˜æŠ€èƒ½'}, {id:'original', label:'ãã®ä»– (ã‚ªãƒªã‚¸ãƒŠãƒ«)'}
            ];

            cats.forEach(c => {
                const list = skillsObj ? (skillsObj[c.id] || []) : [];

                const box = document.createElement('div');
                box.className = 'skill-category';
                box.id = `skill-cat-${c.id}`;
                
                let html = `<h4>${c.label} <button type="button" class="btn-add-skill" onclick="addSkillRow('${c.id}')">+ è¿½åŠ </button></h4>
                <table class="skill-table">
                    <thead>
                        <tr>
                            <th style="width:120px; text-align:left;">æŠ€èƒ½å</th>
                            <th style="width:40px;">åˆè¨ˆ</th>
                            <th style="width:40px;">åˆæœŸ</th>
                            <th style="width:40px;">è·æ¥­</th>
                            <th style="width:40px;">èˆˆå‘³</th>
                            <th style="width:40px;">æˆé•·</th>
                            <th style="text-align:left; padding-left:10px;">æŠ€èƒ½è©³ç´° (Flavor Text)</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                list.forEach(s => {
                    html += `
                    <tr class="skill-entry">
                        <td class="s-name" style="font-weight:bold;">
                            <span class="s-name-text">${s.name}</span>
                            <div style="margin-top:2px;">
                                <select class="skill-cat-select" onchange="moveCategory(this)">
                                    <option value="">ã‚«ãƒ†ã‚´ãƒªç§»å‹•...</option>
                                    <option value="combat">æˆ¦é—˜</option>
                                    <option value="explore">æ¢ç´¢</option>
                                    <option value="action">è¡Œå‹•</option>
                                    <option value="negotiate">äº¤æ¸‰</option>
                                    <option value="knowledge">çŸ¥è­˜</option>
                                    <option value="original">ãã®ä»–</option>
                                </select>
                            </div>
                        </td>
                        <td><input type="number" class="s-total" value="${s.total}" readonly tabindex="-1"></td>
                        <td><input type="number" class="s-init" value="${s.init}" readonly tabindex="-1" style="color:#888;"></td>
                        <td><input type="number" class="s-job" value="${s.job}"></td>
                        <td><input type="number" class="s-interest" value="${s.interest}"></td>
                        <td><input type="number" class="s-growth" value="${s.growth}"></td>
                        <td style="padding-left:10px;"><input type="text" class="s-desc skill-desc-input" value="${s.desc || ''}" placeholder="è¨­å®šã‚„ç†ç”±ãªã©..."></td>
                    </tr>`;
                });
                html += `</tbody></table>`;
                box.innerHTML = html;
                area.appendChild(box);
                
                box.querySelectorAll('.skill-entry').forEach(row => attachSkillCalc(row));
            });
        }

        const dropZone = getEl('dropZone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            dropZone.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); });
        });
        dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if(file && file.type.match('text.*')) {
                const reader = new FileReader();
                reader.onload = (ev) => getEl('txtImportSource').value = ev.target.result;
                reader.readAsText(file);
            }
        });

        const resizeImage = (file, maxWidth, maxHeight, callback) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    let w = img.width;
                    let h = img.height;
                    if (w > maxWidth || h > maxHeight) {
                        const ratio = Math.min(maxWidth / w, maxHeight / h);
                        w *= ratio;
                        h *= ratio;
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    callback(canvas.toDataURL('image/png'));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        const setupImgDrop = (zoneId, inputId, imgId) => {
            const zone = getEl(zoneId);
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                zone.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); });
            });
            zone.addEventListener('drop', (e) => {
                const file = e.dataTransfer.files[0];
                if(file && file.type.match('image.*')) {
                    resizeImage(file, 600, 600, (resizedDataUrl) => {
                        getEl(inputId).value = resizedDataUrl;
                        getEl(imgId).src = resizedDataUrl;
                    });
                }
            });
        };
        setupImgDrop('dropBody', 'inpImageBody', 'previewBody');
        setupImgDrop('dropIcon', 'inpImageIcon', 'previewIcon');


        getEl('btnMerge').addEventListener('click', () => {
            const text = getEl('txtImportSource').value;
            if(!text) return;
            
            const p = parseIaChara(text);
            
            const updateVal = (id, val) => {
                if(val !== undefined && val !== null && val !== "") {
                    setVal(id, val);
                }
            };

            FIELD_MAPPING.forEach(f => { if(p[f.key]) updateVal(f.id, p[f.key]); });
            STATS_MAPPING.forEach(f => updateVal(f.id, p.stats[f.key]));
            VITALS_MAPPING.forEach(f => updateVal(f.id, p.vitals[f.key]));
            
            if(p.colorHair) updateVal('inpHair', p.colorHair);
            if(p.colorEye) updateVal('inpEye', p.colorEye);
            if(p.colorSkin) updateVal('inpSkin', p.colorSkin);

            Object.keys(MEMO_ID_MAP).forEach(key => {
                if(p.memo[key]) updateVal(MEMO_ID_MAP[key], p.memo[key]);
            });

            if(p.items && p.items.length > 0) {
                const existingNames = Array.from(document.querySelectorAll('.i-name')).map(el => el.value.trim());
                p.items.forEach(i => {
                    if (i.name && !existingNames.includes(i.name.trim())) {
                        addItemRow(i);
                    }
                });
            }

            if(p.weapons && p.weapons.length > 0) {
                const existingWeapons = Array.from(document.querySelectorAll('.w-name')).map(el => el.value.trim());
                p.weapons.forEach(w => {
                    if (w.name && !existingWeapons.includes(w.name.trim())) {
                        addWeaponRow(w);
                    }
                });
            }
            
            // æŠ€èƒ½ãŒã‚ã‚Œã°ä¸Šæ›¸ã(ã‚ªãƒªã‚¸ãƒŠãƒ«å«ã‚€)
            if(p.skills && Object.values(p.skills).flat().length > 0) {
                renderSkills(p.skills);
            }

            if(p.image) {
                setVal('inpImageBody', p.image);
                setSrc('previewBody', p.image);
            }
            if(p.icon) {
                setVal('inpImageIcon', p.icon);
                setSrc('previewIcon', p.icon);
            }

            alert("è§£æãƒ»è£œå®Œã—ã¾ã—ãŸï¼\nå€¤ãŒã‚ã‚‹é …ç›®ã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã§ä¸Šæ›¸ãã•ã‚Œã¦ã„ã¾ã™ã€‚\nï¼ˆç©ºç™½ã®é …ç›®ã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç¶­æŒã—ã¦ã„ã¾ã™ï¼‰");
            runCalculations();
        });

        function runCalculations() {
            const age = parseInt(getEl('inpAge')?.value)||0;
            const edu = parseInt(getEl('s_edu')?.value)||0;
            const eduArea = getEl('eduCheckArea');
            const eduMsg = getEl('eduMsg');
            if(eduArea) {
                if(edu>0 && age>0) {
                    const minAge=edu+6;
                    eduArea.style.display='block';
                    if(age<minAge){ eduMsg.className='warn-text'; eduMsg.textContent=`âš ï¸ å¹´é½¢ä¸è¶³ (EDU${edu}ãªã‚‰æœ€ä½${minAge}æ­³)`; }
                    else { eduMsg.className='calc-val'; eduMsg.textContent=`âœ… OK (æœ€ä½${minAge}æ­³)`; }
                } else eduArea.style.display='none';
            }
            const h = parseFloat(getEl('inpHeight')?.value), w = parseFloat(getEl('inpWeight')?.value);
            if(h>0 && w>0) {
                const bmi = w/((h/100)**2);
                getEl('outBMI').textContent = `${bmi.toFixed(1)}`;
            }
        }
        ['inpAge','inpHeight','inpWeight','s_edu'].forEach(id=>getEl(id)?.addEventListener('input', runCalculations));

        getEl('btnCreateNew').addEventListener('click', ()=>{
            const id=crypto.randomUUID();
            allData[id]={id, name:"æ–°è¦ã‚­ãƒ£ãƒ©", stats:{}, vitals:{}, items:[], weapons:[], scenarioList:[], skills:{}};
            currentId=id; renderSelect(); loadCharacterToForm(allData[id]);
        });

        // ã€ä¿®æ­£ã€‘å‰Šé™¤ãƒœã‚¿ãƒ³å‡¦ç†ã®ä¿®æ­£
        getEl('btnDelete').addEventListener('click', async ()=>{
            if(!currentId) return;
            // å‰Šé™¤ã«ã¯åå‰(Firestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã¨ã—ã¦ä½¿ç”¨ã—ã¦ã„ã‚‹)ãŒå¿…è¦
            const targetChar = allData[currentId];
            if(!targetChar || !targetChar.name) {
                alert("å‰Šé™¤å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            if(confirm(`ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€Œ${targetChar.name}ã€ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n(ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“)`)) { 
                await deleteFromCloud(targetChar.name);
                delete allData[currentId]; 
                location.reload(); 
            }
        });

        // --- â˜…è¿½åŠ : ã‚·ãƒŠãƒªã‚ªä¸€è¦§ã‚’è¡¨ç¤ºãƒ»æ›´æ–°ã™ã‚‹é–¢æ•° ---
        async function updateScenarioList(charId) {
            const listContainer = getEl('firestore-scenario-list');
            if (!listContainer) return;

            listContainer.innerHTML = '<div style="color:#666;">Searching database...</div>';

            try {
                // firestore.js ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const scenarios = await getScenariosForCharacter(charId);

                if (!scenarios || scenarios.length === 0) {
                    listContainer.innerHTML = '<div style="color:#666;">No linked scenarios found.</div>';
                    return;
                }

                let html = '<ul style="list-style:none; padding:0; margin:0;">';
                scenarios.forEach(scn => {
                    // çµæœã«ã‚ˆã‚‹è‰²åˆ†ã‘
                    const resultColor = (scn.result === 'Lost') ? '#ff4444' : 
                                        (scn.result === 'Cleared') ? '#44ff44' : '#aaa';
                    
                    html += `
                        <li style="border-bottom:1px solid #333; padding:8px 0; display:flex; justify-content:space-between; align-items:center;">
                            <div style="padding-right:10px;">
                                <div style="font-weight:bold; color:#fff; font-size:0.95rem;">${scn.title}</div>
                                <div style="font-size:0.75rem; color:#888;">${scn.date || 'Unknown'} / GM: ${scn.gm || '-'}</div>
                            </div>
                            <div style="text-align:right; flex-shrink:0;">
                                <span style="color:${resultColor}; border:1px solid ${resultColor}; padding:1px 5px; font-size:0.7rem; border-radius:3px;">${scn.result}</span>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                listContainer.innerHTML = html;

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div style="color:#ff4444;">Error loading scenarios.</div>';
            }
        }

        // --- â˜…çµ±åˆç‰ˆ: ã‚·ãƒŠãƒªã‚ªä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° ---
        async function updateScenarioList(charId) {
            const listContainer = getEl('firestore-scenario-list');
            if (!listContainer) return;

            listContainer.innerHTML = '<div style="color:#888; font-size:0.8rem;">Loading database...</div>';

            try {
                const scenarios = await getScenariosForCharacter(charId);

                if (!scenarios || scenarios.length === 0) {
                    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®è¡¨ç¤º
                    listContainer.innerHTML = '<div style="color:#666; font-size:0.8rem;">No database logs linked. (Use "+ DBç™»éŒ²" to add)</div>';
                    return;
                }

                // ãƒªã‚¹ãƒˆç”Ÿæˆ
                let html = '<div style="display:flex; flex-direction:column; gap:5px;">';
                scenarios.forEach(scn => {
                    const resultColor = (scn.result === 'Lost') ? '#ff4444' : 
                                        (scn.result === 'Cleared') ? '#44ff44' : '#888';
                    
                    html += `
                        <div style="display:flex; align-items:center; background:rgba(0,0,0,0.2); padding:5px 10px; border-radius:3px; font-size:0.85rem;">
                            <div style="flex:1;">
                                <span style="color:#fff; font-weight:bold; margin-right:10px;">${scn.title}</span>
                                <span style="color:#aaa; font-size:0.75rem;">${scn.date || '-'} (GM:${scn.gm||'-'})</span>
                            </div>
                            <span style="color:${resultColor}; border:1px solid ${resultColor}; padding:0 4px; font-size:0.7rem; border-radius:2px;">${scn.result}</span>
                        </div>
                    `;
                });
                html += '</div>';
                listContainer.innerHTML = html;

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div style="color:#ff4444;">Load Error</div>';
            }
        }

    </script>
</body>
</html>