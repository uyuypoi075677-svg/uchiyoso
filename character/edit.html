<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>DATA EDITOR</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link href="edit/header.css" rel="stylesheet">
    <style>
        /* CSSスタイルは既存のまま維持 */
        body { background-color: #202020; color: #ddd; font-family: 'Noto Sans JP', sans-serif; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 0 auto; padding: 80px 20px 100px; }
        .toolbar { background: #333; padding: 20px; border-radius: 4px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; }
        select { padding: 10px; background: #111; color: #fff; border: 1px solid #555; width: 300px; border-radius: 4px; }
        .btn-new { background: #44ff44; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .btn-delete { background: #ff4444; color: #fff; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        .import-area { background: #2a2a2d; padding: 20px; border-radius: 4px; border: 1px dashed #666; margin-bottom: 30px; }
        .import-area textarea { height: 100px; font-size: 0.8rem; color: #aaa; }
        .btn-merge { background: #00f3ff; color: #000; border: none; padding: 8px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; }
        .btn-merge:hover { background: #88ffff; }
        h2 { border-bottom: 2px solid #555; padding-bottom: 10px; margin-top: 40px; color: #aaa; font-size: 1.1rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-row { margin-bottom: 15px; }
        .form-row.full { grid-column: span 2; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        label { display: block; color: #888; font-size: 0.75rem; margin-bottom: 5px; font-family: 'Roboto Mono', monospace; }
        input[type="text"], input[type="number"] { width: 100%; padding: 10px; box-sizing: border-box; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 0.95rem; }
        textarea { width: 100%; padding: 10px; box-sizing: border-box; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 0.9rem; line-height: 1.6; min-height: 80px; resize: vertical; }
        .analysis-box { background: #252525; padding: 15px; border-radius: 4px; border: 1px solid #444; margin-top: 5px; font-size: 0.85rem; color: #ccc; }
        .calc-val { color: #44ff44; font-weight: bold; margin-left: 5px; }
        .warn-text { color: #ffaa00; }
        .visual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; background: #252525; padding: 20px; border-radius: 4px; border: 1px solid #444; }
        .img-preview-box { width: 100%; height: 200px; background: #000; border: 1px solid #444; display: flex; align-items: center; justify-content: center; position: relative; }
        .img-preview { max-width: 100%; max-height: 100%; object-fit: contain; }
        .stats-container { display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; background: #252525; padding: 15px; border-radius: 4px; }
        .stat-box { text-align: center; }
        .stat-box input { text-align: center; font-weight: bold; color: #44ff44; font-size: 1.1rem; }
        .text-section { border-left: 3px solid #444; padding-left: 15px; margin-bottom: 20px; }
        .text-section h3 { font-size: 0.9rem; color: #44ff44; margin: 0 0 10px 0; opacity: 0.8; }
        .helper-text { font-size: 0.7rem; color: #666; margin-top: 2px; }
    </style>
</head>
<body>
    <script type="module">import { initHeader } from "./header.js"; initHeader();</script>

    <div class="container">
        <div class="toolbar">
            <div>
                <label>EDIT TARGET</label>
                <select id="charSelect"><option value="">LOADING...</option></select>
            </div>
            <div>
                <button id="btnCreateNew" class="btn-new">+ NEW</button>
            </div>
        </div>

        <div id="editorArea" style="opacity:0.3; pointer-events:none;">
            <div class="import-area">
                <h3 style="margin-top:0; color:#00f3ff;">SMART IMPORT (いあきゃらテキスト読込)</h3>
                <p style="font-size:0.8rem; color:#888; margin-bottom:5px;">いあキャラのテキストデータを貼り付けて「不足を埋める」を押すと、<br>現在入力されているデータはそのままに、<strong>空欄の部分だけ</strong>を自動で補完します。</p>
                <textarea id="txtImportSource" placeholder="ここにテキストデータを貼り付け..."></textarea>
                <button id="btnMerge" class="btn-merge">✨ FILL MISSING INFO (不足を埋める)</button>
            </div>

            <h2>BASIC PROFILE</h2>
            <div class="form-grid">
                <div class="form-row"><label>NAME</label><input type="text" id="inpName"></div>
                <div class="form-row"><label>KANA</label><input type="text" id="inpKana"></div>
            </div>
            <div style="margin-top:50px; text-align:right;">
                <button id="btnDelete" class="btn-delete">DELETE CHARACTER</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, monitorAuth } from "./firestore.js";
        // ★重要：共通ロジックとマッピングを読み込む
        import { collectFormData, parseIaChara, FIELD_MAPPING, STATS_MAPPING, VITALS_MAPPING } from "./data/schema.js";

        const getEl = (id) => document.getElementById(id);
        const setVal = (id, v) => { const el = getEl(id); if(el) el.value = (v == null ? '' : v); };
        const setSrc = (id, s) => { const el = getEl(id); if(el) el.src = s || ''; };

        let allData = {};
        let currentId = null;

        monitorAuth((user) => {
            if(user) init();
            else getEl('charSelect').innerHTML = '<option>LOGIN REQUIRED</option>';
        });

        async function init() {
            try {
                const data = await loadFromCloud();
                allData = data || {};
                renderSelect();
            } catch(e) { console.error(e); }
        }

        function renderSelect() {
            const sel = getEl('charSelect');
            sel.innerHTML = '<option value="">-- SELECT CHARACTER --</option>';
            Object.values(allData).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                sel.appendChild(opt);
            });
            if(currentId) sel.value = currentId;
        }

        getEl('charSelect').addEventListener('change', (e) => {
            currentId = e.target.value;
            if(!currentId) {
                getEl('editorArea').style.opacity='0.3';
                getEl('editorArea').style.pointerEvents='none';
                return;
            }
            const target = Object.values(allData).find(c => c.id == currentId);
            if(target) loadCharacterToForm(target);
        });

        // データ読み込み（schema.jsのマッピング利用）
        function loadCharacterToForm(d) {
            getEl('editorArea').style.opacity='1';
            getEl('editorArea').style.pointerEvents='auto';
            
            FIELD_MAPPING.forEach(field => setVal(field.id, d[field.key]));
            setSrc('previewBody', d.image);
            setSrc('previewIcon', d.icon);

            const s = d.stats || {};
            STATS_MAPPING.forEach(f => setVal(f.id, s[f.key]));
            const v = d.vitals || {};
            VITALS_MAPPING.forEach(f => setVal(f.id, v[f.key]));

            const fullMemo = d.memo || '';
            const extract = (tag) => {
                const regex = new RegExp(`\\[${tag}\\]\\n([\\s\\S]*?)(\\n\\[|$)`);
                const m = fullMemo.match(regex);
                return m ? m[1].trim() : '';
            };
            setVal('txtBackground', extract('経歴'));
            setVal('txtPersonality', extract('性格'));
            setVal('txtRelations', extract('人間関係'));
            setVal('txtAppearance', extract('外見的特徴')||extract('外見'));
            setVal('txtRoleplay', extract('RP補足')||extract('RP用補足'));
            setVal('txtSkillDetails', extract('技能詳細')||extract('職業P振り分け詳細'));
            if(!fullMemo.includes('[')) setVal('txtMemo', fullMemo);
            else setVal('txtMemo', extract('メモ'));

            if(Array.isArray(d.items)) {
                const lines = d.items.map(i => i.desc ? `${i.name} : ${i.desc}` : i.name);
                setVal('txtItems', lines.join('\n'));
            } else {
                setVal('txtItems', '');
            }

            if(Array.isArray(d.scenarioList)) {
                const text = d.scenarioList.map(scn => `[${scn.title}]\n${scn.desc}`).join('\n\n');
                setVal('txtScenarioDetails', text);
            } else {
                const simpleList = d.scenarios || "";
                if (simpleList && !d.scenarioList) {
                    const converted = simpleList.split('\n')
                        .filter(l => l.trim())
                        .map(l => `[${l.replace(/[\[\]]/g, '')}]\n(詳細未記入)`).join('\n\n');
                    setVal('txtScenarioDetails', converted);
                } else {
                    setVal('txtScenarioDetails', '');
                }
            }
            runCalculations();
        }

        // 保存（共通ロジック利用）
        window.prepareSaveData = function() {
            if(!currentId) return null;
            const originalData = Object.values(allData).find(c=>c.id==currentId);
            if(!originalData) return null;
            const finalData = collectFormData(originalData, false);
            alert("保存しました！");
            return finalData;
        };

        // スマートインポート（共通ロジック parseIaChara 利用）
        getEl('btnMerge').addEventListener('click', () => {
            const text = getEl('txtImportSource').value;
            if(!text) return;
            const p = parseIaChara(text); // ★共通化！
            
            const fillIfEmpty = (id, val) => {
                const current = getEl(id)?.value;
                if(!current && val) setVal(id, val);
            };

            // マッピングを利用して自動入力（簡略化可能だが安全のため明示）
            FIELD_MAPPING.forEach(f => fillIfEmpty(f.id, p[f.key]));
            STATS_MAPPING.forEach(f => fillIfEmpty(f.id, p.stats[f.key]));
            VITALS_MAPPING.forEach(f => fillIfEmpty(f.id, p.vitals[f.key]));
            
            fillIfEmpty('txtBackground', p.memo.background);
            fillIfEmpty('txtPersonality', p.memo.personality);
            fillIfEmpty('txtRelations', p.memo.relations);
            fillIfEmpty('txtAppearance', p.memo.appearance);
            fillIfEmpty('txtRoleplay', p.memo.roleplay);
            fillIfEmpty('txtSkillDetails', p.memo.skillDetails);
            fillIfEmpty('txtMemo', p.memo.memo);

            if(p.itemsStr) {
                const currentItems = getEl('txtItems').value;
                if(!currentItems) setVal('txtItems', p.itemsStr);
                else setVal('txtItems', currentItems + '\n' + p.itemsStr);
            }
            if(p.image && !getEl('previewBody').src) setSrc('previewBody', p.image);
            if(p.icon && !getEl('previewIcon').src) setSrc('previewIcon', p.icon);

            alert("不足データを補完しました！");
            runCalculations();
        });

        // 計算ロジック
        function runCalculations() {
            const age = parseInt(getEl('inpAge')?.value)||0;
            const edu = parseInt(getEl('s_edu')?.value)||0;
            const eduArea = getEl('eduCheckArea');
            if(eduArea) {
                if(edu>0 && age>0) {
                    const minAge=edu+6;
                    eduArea.style.display='block';
                    const msg = getEl('eduMsg');
                    if(age<minAge){ msg.className='warn-text'; msg.textContent=`⚠️ 年齢不足 (EDU${edu}なら最低${minAge}歳)`; }
                    else { msg.className='calc-val'; msg.textContent=`✅ OK (最低${minAge}歳)`; }
                } else eduArea.style.display='none';
            }
            const h = parseFloat(getEl('inpHeight')?.value), w = parseFloat(getEl('inpWeight')?.value);
            if(h>0 && w>0) getEl('outBMI').textContent = (w/((h/100)**2)).toFixed(1);
        }
        ['inpAge','inpHeight','inpWeight','s_edu'].forEach(id=>getEl(id)?.addEventListener('input', runCalculations));

        getEl('btnCreateNew').addEventListener('click', ()=>{
            const id=crypto.randomUUID();
            allData[id]={id, name:"新規キャラ", stats:{}, vitals:{}, items:[]};
            currentId=id; renderSelect(); loadCharacterToForm(allData[id]);
        });
        getEl('btnDelete').addEventListener('click', async ()=>{
            if(!currentId)return;
            if(confirm('削除しますか？')) { delete allData[currentId]; location.reload(); }
        });
    </script>
</body>
</html>