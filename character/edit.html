<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DATA EDITOR</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link href="edit/header.css" rel="stylesheet">

    <style>
        body { background-color: #202020; color: #ddd; font-family: 'Noto Sans JP', sans-serif; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 0 auto; padding: 80px 20px 100px; }
        .toolbar { background: #333; padding: 20px; border-radius: 4px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; }
        select { padding: 10px; background: #111; color: #fff; border: 1px solid #555; width: 300px; border-radius: 4px; }
        .btn-new { background: #44ff44; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .btn-delete { background: #ff4444; color: #fff; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        .import-area { background: #2a2a2d; padding: 20px; border-radius: 4px; border: 1px dashed #666; margin-bottom: 30px; }
        .import-area textarea { height: 100px; font-size: 0.8rem; color: #aaa; }
        .btn-merge { background: #00f3ff; color: #000; border: none; padding: 8px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; }
        .btn-merge:hover { background: #88ffff; }
        h2 { border-bottom: 2px solid #555; padding-bottom: 10px; margin-top: 40px; color: #aaa; font-size: 1.1rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-row { margin-bottom: 15px; }
        .form-row.full { grid-column: span 2; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        label { display: block; color: #888; font-size: 0.75rem; margin-bottom: 5px; font-family: 'Roboto Mono', monospace; }
        input[type="text"], input[type="number"] { width: 100%; padding: 10px; box-sizing: border-box; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 0.95rem; }
        textarea { width: 100%; padding: 10px; box-sizing: border-box; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 0.9rem; line-height: 1.6; min-height: 80px; resize: vertical; }
        .analysis-box { background: #252525; padding: 15px; border-radius: 4px; border: 1px solid #444; margin-top: 5px; font-size: 0.85rem; color: #ccc; }
        .calc-val { color: #44ff44; font-weight: bold; margin-left: 5px; }
        .warn-text { color: #ffaa00; }
        .visual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; background: #252525; padding: 20px; border-radius: 4px; border: 1px solid #444; }
        .img-preview-box { width: 100%; height: 200px; background: #000; border: 1px solid #444; display: flex; align-items: center; justify-content: center; position: relative; }
        .img-preview { max-width: 100%; max-height: 100%; object-fit: contain; }
        .stats-container { display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; background: #252525; padding: 15px; border-radius: 4px; }
        .stat-box { text-align: center; }
        .stat-box input { text-align: center; font-weight: bold; color: #44ff44; font-size: 1.1rem; }
        .text-section { border-left: 3px solid #444; padding-left: 15px; margin-bottom: 20px; }
        .text-section h3 { font-size: 0.9rem; color: #44ff44; margin: 0 0 10px 0; opacity: 0.8; }
        .helper-text { font-size: 0.7rem; color: #666; margin-top: 2px; }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»ãƒªã‚¹ãƒˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .data-table th { background: #333; color: #aaa; font-weight: normal; padding: 5px; text-align: left; }
        .data-table td { padding: 5px; border-bottom: 1px solid #333; }
        .data-table input { background: transparent; border: none; color: #fff; width: 100%; font-family: 'Roboto Mono', monospace; }
        .data-table input:focus { background: #222; outline: 1px solid #555; }
    
        .list-container { background: #252525; border: 1px solid #444; border-radius: 4px; padding: 10px; margin-top: 5px; }
        .list-row { display: grid; gap: 10px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #333; align-items: center; }
        .btn-add { background: #444; color: #fff; border: none; width: 100%; padding: 5px; cursor: pointer; font-size: 0.8rem; margin-top: 5px; }
        .btn-add:hover { background: #555; }
        .btn-remove { background: #552222; color: #ffaaaa; border: none; padding: 2px 8px; cursor: pointer; font-size: 0.7rem; border-radius: 2px; }

       /* æ­¦å™¨ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ã‚°ãƒªãƒƒãƒ‰ */
        .weapon-header { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr auto; gap: 5px; font-size: 0.7rem; color: #888; margin-bottom: 5px; padding: 0 5px; }
        .weapon-entry { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr auto; gap: 5px; margin-bottom: 5px; }
        .weapon-entry input { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 5px; font-size: 0.8rem; width: 100%; }

        /* æŠ€èƒ½ãƒªã‚¹ãƒˆç”¨ */
        .skill-category { margin-bottom: 20px; }
        .skill-category h4 { margin: 5px 0; color: #44ff44; font-size: 0.9rem; border-bottom: 1px solid #444; }
        .skill-table { width: 100%; font-size: 0.8rem; }
        .skill-table th { color: #888; text-align: center; font-weight: normal; font-size: 0.7rem; }
        .skill-table td { padding: 2px; }
        .skill-table input[type="number"] { text-align: center; color: #44ff44; }
        .skill-desc-input { width: 100%; color: #ddd; font-size: 0.8rem; }
     </style>

<div class="form-grid full-width-skills">
    <div class="text-section full" style="grid-column: span 2;">
        <h3>æŠ€èƒ½ãƒ‡ãƒ¼ã‚¿ (SKILLS & DETAIL)</h3>
        <div id="skillArea" class="list-container" style="max-height: 500px; overflow-y: auto;">
            </div>
    </div>
</div>

<div class="grid-3">
    <div class="form-row full" style="grid-column:span 2;">
        <label>æ‰€æŒå“ (ITEMS)</label>
        <div class="list-container">
            <div id="itemList"></div>
            <button type="button" class="btn-add" onclick="addItemRow()">+ ADD ITEM</button>
        </div>
    </div>
    </div>

<div class="form-row full" style="margin-top:15px;">
    <label>æˆ¦é—˜ãƒ»æ­¦å™¨ãƒ»é˜²å…· (WEAPONS)</label>
    <div class="list-container">
        <div class="weapon-header">
            <div>åå‰</div><div>æˆåŠŸç‡</div><div>ãƒ€ãƒ¡</div><div>å°„ç¨‹</div><div>å›æ•°</div><div>è£…å¼¾</div><div>HP</div><div>æ•…éšœ</div><div></div>
        </div>
        <div id="weaponList"></div>
        <button type="button" class="btn-add" onclick="addWeaponRow()">+ ADD WEAPON</button>
    </div>
</div>

<script type="module">import { initHeader } from "./header.js"; initHeader();</script>

    <div class="container">
        <div class="toolbar">
            <div>
                <label>EDIT TARGET</label>
                <select id="charSelect"><option value="">LOADING...</option></select>
            </div>
            <div>
                <button id="btnCreateNew" class="btn-new">+ NEW</button>
            </div>
        </div>

        <div id="editorArea" style="opacity:0.3; pointer-events:none;">
            
            <div class="import-area">
                <h3 style="margin-top:0; color:#00f3ff;">SMART IMPORT (ã„ã‚ãã‚ƒã‚‰ãƒ†ã‚­ã‚¹ãƒˆèª­è¾¼)</h3>
                <p style="font-size:0.8rem; color:#888; margin-bottom:5px;">ã„ã‚ã‚­ãƒ£ãƒ©ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ã€Œä¸è¶³ã‚’åŸ‹ã‚ã‚‹ã€ã‚’æŠ¼ã™ã¨ã€<br>ç¾åœ¨å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ãã®ã¾ã¾ã«ã€<strong>ç©ºæ¬„ã®éƒ¨åˆ†ã ã‘</strong>ã‚’è‡ªå‹•ã§è£œå®Œã—ã¾ã™ã€‚</p>
                <textarea id="txtImportSource" placeholder="ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘..."></textarea>
                <button id="btnMerge" class="btn-merge">âœ¨ FILL MISSING INFO (ä¸è¶³ã‚’åŸ‹ã‚ã‚‹)</button>
            </div>

            <h2>BASIC PROFILE</h2>
            <div class="form-grid">
                <div class="form-row"><label>NAME</label><input type="text" id="inpName"></div>
                <div class="form-row"><label>KANA</label><input type="text" id="inpKana"></div>
            </div>
            <div class="form-grid">
                <div class="form-row"><label>JOB</label><input type="text" id="inpJob"></div>
                <div class="form-row"><label>TAGS</label><input type="text" id="inpTags"></div>
            </div>

            <div class="grid-4" style="margin-top:15px;">
                <div class="form-row"><label>AGE</label><input type="number" id="inpAge"></div>
                <div class="form-row"><label>GENDER</label><input type="text" id="inpGender"></div>
                <div class="form-row"><label>MONEY (æ‰€æŒé‡‘)</label><input type="text" id="inpMoney"></div>
                <div class="form-row"><label>DEBT (å€Ÿé‡‘)</label><input type="text" id="inpDebt"></div>
            </div>
            
            <div class="grid-4" style="margin-top:15px;">
                <div class="form-row"><label>BIRTHDAY</label><input type="text" id="inpBirthday"></div>
                <div class="form-row"><label>BIRTHPLACE</label><input type="text" id="inpOrigin"></div>
            </div>

            <div id="eduCheckArea" class="analysis-box" style="display:none;"><span>ğŸ“ EDUåˆ†æ:</span><span id="eduMsg"></span></div>

            <div class="grid-3" style="margin-top:20px; background:#2b2b2b; padding:15px; border-radius:4px;">
                <div class="form-row"><label>HEIGHT (cm)</label><input type="number" id="inpHeight"></div>
                <div class="form-row"><label>WEIGHT (kg)</label><input type="number" id="inpWeight"></div>
                <div class="form-row"><label>HAIR / EYE / SKIN</label>
                    <input type="text" id="inpHair" placeholder="é«ªè‰²" style="margin-bottom:5px;">
                    <input type="text" id="inpEye" placeholder="ç³ã®è‰²" style="margin-bottom:5px;">
                    <input type="text" id="inpSkin" placeholder="è‚Œã®è‰²">
                </div>
            </div>
            <div id="bodyCheckArea" class="analysis-box">
                <div style="margin-bottom:5px;">ğŸ“Š <b>BMI:</b> <span id="outBMI" class="calc-val">--</span></div>
            </div>

            <h2>VISUALS</h2>
            <div class="visual-grid">
                <div>
                    <label>STANDING ART</label>
                    <div class="img-preview-box"><img id="previewBody" class="img-preview"></div>
                    <input type="text" id="inpImageBody" placeholder="URL..." style="margin-top:5px;">
                </div>
                <div>
                    <label>FACE ICON</label>
                    <div class="img-preview-box"><img id="previewIcon" class="img-preview"></div>
                    <input type="text" id="inpImageIcon" placeholder="URL..." style="margin-top:5px;">
                </div>
            </div>

            <h2>STATS & VITALS</h2>
            <div class="stats-container">
                <div class="stat-box"><label>STR</label><input type="number" id="s_str"></div>
                <div class="stat-box"><label>CON</label><input type="number" id="s_con"></div>
                <div class="stat-box"><label>POW</label><input type="number" id="s_pow"></div>
                <div class="stat-box"><label>DEX</label><input type="number" id="s_dex"></div>
                <div class="stat-box"><label>APP</label><input type="number" id="s_app"></div>
                <div class="stat-box"><label>SIZ</label><input type="number" id="s_siz"></div>
                <div class="stat-box"><label>INT</label><input type="number" id="s_int"></div>
                <div class="stat-box"><label>EDU</label><input type="number" id="s_edu"></div>
            </div>
            <div class="grid-4" style="margin-top:20px;">
                <div class="form-row"><label>HP</label><input type="number" id="v_hp"></div>
                <div class="form-row"><label>MP</label><input type="number" id="v_mp"></div>
                <div class="form-row"><label>SAN</label><input type="number" id="v_san"></div>
                <div class="form-row"><label>DB</label><input type="text" id="v_db"></div>
            </div>

            <h2>DETAILS</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <div class="text-section"><h3>çµŒæ­´</h3><textarea id="txtBackground"></textarea></div>
                    <div class="text-section"><h3>æ€§æ ¼</h3><textarea id="txtPersonality"></textarea></div>
                    <div class="text-section"><h3>äººé–“é–¢ä¿‚</h3><textarea id="txtRelations"></textarea></div>
                </div>
                <div>
                    <div class="text-section"><h3>å¤–è¦‹çš„ç‰¹å¾´</h3><textarea id="txtAppearance"></textarea></div>
                    <div class="text-section"><h3>RPè£œè¶³</h3><textarea id="txtRoleplay"></textarea></div>
                    <div class="text-section"><h3>ãƒ¡ãƒ¢</h3><textarea id="txtMemo"></textarea></div>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="text-section">
                    <h3>æŠ€èƒ½è©³ç´° (FLAVOR TEXT)</h3>
                    <textarea id="txtSkillDetails" style="height:150px;"></textarea>
                    <div class="helper-text">â€»æŠ€èƒ½ã®ã€Œç†ç”±ã€ã‚„ã€Œè¨­å®šã€ãªã©ã®æ–‡ç« </div>
                </div>
                <div class="text-section">
                    <h3>æŠ€èƒ½å€¤ãƒªã‚¹ãƒˆ (NUMERICAL DATA)</h3>
                    <textarea id="txtSkillList" style="height:150px; font-family:monospace; font-size:0.8rem;"></textarea>
                    <div class="helper-text">â€»ã„ã‚ã‚­ãƒ£ãƒ©ã®æŠ€èƒ½ä¸€è¦§è¡¨ï¼ˆæ•°å€¤ï¼‰</div>
                </div>
            </div>

            <div class="text-section" style="margin-top:20px; border-left-color: #d4b346;">
                <h3 style="color: #d4b346;">æŠ€èƒ½æˆé•·å±¥æ­´ (GROWTH LOG)</h3>
                <textarea id="txtGrowth" style="height:120px;" placeholder="ä¾‹ï¼š&#13;ã‚·ãƒŠãƒªã‚ªA: å›é¿+5, ç›®æ˜Ÿ+3"></textarea>
                <div class="helper-text">â€»ã©ã®ã‚·ãƒŠãƒªã‚ªã§ä½•ãŒæˆé•·ã—ãŸã‹ã‚’è‡ªç”±ã«è¨˜éŒ²ã§ãã¾ã™ã€‚</div>
            </div>

            <h2>INVENTORY & HISTORY</h2>
            <div class="grid-3">
                <div class="form-row full" style="grid-column:span 2;">
                    <label>æ‰€æŒå“ (ITEMS)</label>
                    <textarea id="txtItems" style="height:200px;" placeholder="ã‚¢ã‚¤ãƒ†ãƒ å : èª¬æ˜æ–‡"></textarea>
                </div>
                <div class="form-row">
                    <label>é­”è¡“/AF (SPELLS/ARTIFACTS)</label>
                    <textarea id="txtSpells" style="height:90px;"></textarea>
                    
                    <label style="margin-top:10px;">é­é‡ã—ãŸå­˜åœ¨ (ENTITIES)</label>
                    <textarea id="txtEncountered" style="height:90px;"></textarea>
                </div>
            </div>

            <div class="form-row full" style="margin-top:20px;">
                <label>é€šéã‚·ãƒŠãƒªã‚ªè©³ç´° (SCENARIO LOGS & MEMORIES)</label>
                <textarea id="txtScenarioDetails" style="height:200px;" placeholder="[ã‚·ãƒŠãƒªã‚ªã‚¿ã‚¤ãƒˆãƒ«]&#13;å†…å®¹..."></textarea>
                <div class="form-row">
                    <label>é€šéã‚·ãƒŠãƒªã‚ª(ç°¡æ˜“ä¸€è¦§)</label>
                    <textarea id="txtScenarios" style="height:60px;" placeholder="ã‚·ãƒŠãƒªã‚ªå..."></textarea>
                </div>
            </div>

            <div class="form-row full" style="margin-top:15px;">
                <label>æˆ¦é—˜ãƒ»æ­¦å™¨ãƒ»é˜²å…· (WEAPONS)</label>
                <textarea id="txtWeapons" style="height:100px; font-family:monospace;" placeholder="æ­¦å™¨ãƒ‡ãƒ¼ã‚¿..."></textarea>
            </div>

            <div style="margin-top:50px; text-align:right;">
                <button id="btnDelete" class="btn-delete">DELETE CHARACTER</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, monitorAuth } from "./firestore.js";
        // dataãƒ•ã‚©ãƒ«ãƒ€ã®schema.jsã‹ã‚‰å…¨ã¦ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { collectFormData, parseIaChara, FIELD_MAPPING, STATS_MAPPING, VITALS_MAPPING } from "./data/schema.js";

        const getEl = (id) => document.getElementById(id);
        const setVal = (id, v) => { const el = getEl(id); if(el) el.value = (v == null ? '' : v); };
        const setSrc = (id, s) => { const el = getEl(id); if(el) el.src = s || ''; };

        // â–¼ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©ã—ã¦HTMLã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«ã™ã‚‹
    window.addItemRow = (val={name:'', desc:''}) => {
        const div = document.createElement('div');
        div.className = 'list-row item-entry';
        div.style.gridTemplateColumns = '1fr 2fr auto';
        div.innerHTML = `
            <input type="text" class="i-name" placeholder="åç§°" value="${val.name}">
            <input type="text" class="i-desc" placeholder="åŠ¹æœãƒ»å‚™è€ƒ" value="${val.desc}">
            <button class="btn-remove" onclick="this.parentElement.remove()">âœ•</button>
        `;
        document.getElementById('itemList').appendChild(div);
    };

    window.addWeaponRow = (val={name:'', rate:'', damage:'', range:'', attacks:'', capacity:'', hp:'', malfunction:''}) => {
        const div = document.createElement('div');
        div.className = 'weapon-entry';
        div.innerHTML = `
            <input type="text" class="w-name" value="${val.name}">
            <input type="text" class="w-rate" value="${val.rate}">
            <input type="text" class="w-dmg" value="${val.damage}">
            <input type="text" class="w-range" value="${val.range}">
            <input type="text" class="w-atk" value="${val.attacks}">
            <input type="text" class="w-cap" value="${val.capacity}">
            <input type="text" class="w-hp" value="${val.hp}">
            <input type="text" class="w-mal" value="${val.malfunction}">
            <button class="btn-remove" onclick="this.parentElement.remove()">âœ•</button>
        `;
        document.getElementById('weaponList').appendChild(div);
    };

        // ãƒ¡ãƒ¢æ¬„ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆparseIaCharaã®æˆ»ã‚Šå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨HTML IDã®å¯¾å¿œï¼‰
        const MEMO_ID_MAP = {
            background: 'txtBackground',
            personality: 'txtPersonality',
            relations: 'txtRelations',
            appearance: 'txtAppearance',
            roleplay: 'txtRoleplay',
            skillDetails: 'txtSkillDetails',
            memo: 'txtMemo'
        };

        let allData = {};
        let currentId = null;

        monitorAuth((user) => {
            if(user) init();
            else getEl('charSelect').innerHTML = '<option>LOGIN REQUIRED</option>';
        });

        async function init() {
            try {
                const data = await loadFromCloud();
                allData = data || {};
                renderSelect();
            } catch(e) { console.error(e); }
        }

        function renderSelect() {
            const sel = getEl('charSelect');
            sel.innerHTML = '<option value="">-- SELECT CHARACTER --</option>';
            Object.values(allData).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                sel.appendChild(opt);
            });
            if(currentId) sel.value = currentId;
        }

        getEl('charSelect').addEventListener('change', (e) => {
            currentId = e.target.value;
            if(!currentId) {
                getEl('editorArea').style.opacity='0.3';
                getEl('editorArea').style.pointerEvents='none';
                return;
            }
            const target = Object.values(allData).find(c => c.id == currentId);
            if(target) loadCharacterToForm(target);
        });

        // ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function loadCharacterToForm(d) {
            getEl('editorArea').style.opacity='1';
            getEl('editorArea').style.pointerEvents='auto';
            
            // 1. schema.jsã®FIELD_MAPPINGã‚’ä½¿ç”¨ã—ã¦åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
            FIELD_MAPPING.forEach(field => {
                setVal(field.id, d[field.key]);
            });
            setSrc('previewBody', d.image);
            setSrc('previewIcon', d.icon);

            // 2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒã‚¤ã‚¿ãƒ«ã®ã‚»ãƒƒãƒˆ
            const s = d.stats || {};
            STATS_MAPPING.forEach(f => setVal(f.id, s[f.key]));
            const v = d.vitals || {};
            VITALS_MAPPING.forEach(f => setVal(f.id, v[f.key]));

            // 3. ãƒ¡ãƒ¢ï¼ˆä¿å­˜æ™‚ã¯çµåˆã•ã‚ŒãŸæ–‡å­—åˆ—ï¼‰ã‚’åˆ†è§£ã—ã¦ã‚»ãƒƒãƒˆ
            // schema.jsã®collectFormDataã§çµåˆã•ã‚ŒãŸ [ã‚¿ã‚°] å½¢å¼ã‚’åˆ†è§£
            const fullMemo = d.memo || '';
            const extract = (tag) => {
                const regex = new RegExp(`\\[${tag}\\]\\n([\\s\\S]*?)(\\n\\[|$)`);
                const m = fullMemo.match(regex);
                return m ? m[1].trim() : '';
            };
            
            setVal('txtBackground', extract('çµŒæ­´'));
            setVal('txtPersonality', extract('æ€§æ ¼'));
            setVal('txtRelations', extract('äººé–“é–¢ä¿‚'));
            setVal('txtAppearance', extract('å¤–è¦‹çš„ç‰¹å¾´')||extract('å¤–è¦‹'));
            setVal('txtRoleplay', extract('RPè£œè¶³')||extract('RPç”¨è£œè¶³'));
            setVal('txtSkillDetails', extract('æŠ€èƒ½è©³ç´°')||extract('è·æ¥­PæŒ¯ã‚Šåˆ†ã‘è©³ç´°'));
            
            // "ãƒ¡ãƒ¢"ã‚¿ã‚°ãŒã‚ã‚‹å ´åˆã¨ã€ã‚¿ã‚°ãªã—ã®ç”Ÿãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã‚’è€ƒæ…®
            if(!fullMemo.includes('[')) setVal('txtMemo', fullMemo);
            else setVal('txtMemo', extract('ãƒ¡ãƒ¢'));

           // 4. ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆæç”»
        document.getElementById('itemList').innerHTML = '';
        if(Array.isArray(d.items)) d.items.forEach(i => addItemRow(i));
        else addItemRow(); // ç©ºè¡Œ1ã¤

        // 5. æ­¦å™¨ãƒªã‚¹ãƒˆæç”»
        document.getElementById('weaponList').innerHTML = '';
        if(Array.isArray(d.weapons)) d.weapons.forEach(w => addWeaponRow(w));
        else addWeaponRow(); 

        // 6. æŠ€èƒ½ãƒªã‚¹ãƒˆæç”»
        renderSkills(d.skills);
        
        runCalculations();
    }

    // æŠ€èƒ½æç”»é–¢æ•°
    function renderSkills(skillsObj) {
        const area = document.getElementById('skillArea');
        area.innerHTML = '';
        
        // ã‚«ãƒ†ã‚´ãƒªå®šç¾©
        const cats = [
            {id:'combat', label:'æˆ¦é—˜æŠ€èƒ½'}, {id:'explore', label:'æ¢ç´¢æŠ€èƒ½'}, 
            {id:'action', label:'è¡Œå‹•æŠ€èƒ½'}, {id:'negotiate', label:'äº¤æ¸‰æŠ€èƒ½'}, 
            {id:'knowledge', label:'çŸ¥è­˜æŠ€èƒ½'}
        ];

        cats.forEach(c => {
            const list = skillsObj ? skillsObj[c.id] : [];
            if(!list || list.length === 0) return;

            const box = document.createElement('div');
            box.className = 'skill-category';
            box.id = `skill-cat-${c.id}`;
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼
            let html = `<h4>${c.label}</h4>
            <table class="skill-table">
                <thead>
                    <tr>
                        <th style="width:120px; text-align:left;">æŠ€èƒ½å</th>
                        <th style="width:40px;">åˆè¨ˆ</th>
                        <th style="width:40px;">åˆæœŸ</th>
                        <th style="width:40px;">è·æ¥­</th>
                        <th style="width:40px;">èˆˆå‘³</th>
                        <th style="width:40px;">æˆé•·</th>
                        <th style="text-align:left; padding-left:10px;">æŠ€èƒ½è©³ç´° (Flavor Text)</th>
                    </tr>
                </thead>
                <tbody>`;
            
            list.forEach(s => {
                html += `
                <tr class="skill-entry">
                    <td class="s-name" style="font-weight:bold;">${s.name}</td>
                    <td><input type="number" class="s-total" value="${s.total}" readonly tabindex="-1"></td>
                    <td><input type="number" class="s-init" value="${s.init}" readonly tabindex="-1" style="color:#888;"></td>
                    <td><input type="number" class="s-job" value="${s.job}"></td>
                    <td><input type="number" class="s-interest" value="${s.interest}"></td>
                    <td><input type="number" class="s-growth" value="${s.growth}"></td>
                    <td style="padding-left:10px;"><input type="text" class="s-desc skill-desc-input" value="${s.desc || ''}" placeholder="è¨­å®šã‚„ç†ç”±ãªã©..."></td>
                </tr>`;
            });
            html += `</tbody></table>`;
            box.innerHTML = html;
            area.appendChild(box);
            
            // åˆè¨ˆå€¤ã®è‡ªå‹•è¨ˆç®—ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸
            box.querySelectorAll('input').forEach(inp => {
                inp.addEventListener('input', (e) => {
                    const row = e.target.closest('tr');
                    const init = parseInt(row.querySelector('.s-init').value)||0;
                    const job = parseInt(row.querySelector('.s-job').value)||0;
                    const int = parseInt(row.querySelector('.s-interest').value)||0;
                    const gro = parseInt(row.querySelector('.s-growth').value)||0;
                    row.querySelector('.s-total').value = init + job + int + gro;
                });
            });
        });
    }

        // â˜…ä¿å­˜å‡¦ç†: schema.js ã® collectFormData ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿åé›†
        window.prepareSaveData = function() {
            if(!currentId) return null;
            const originalData = Object.values(allData).find(c=>c.id==currentId);
            if(!originalData) return null;

            // overwriteEmpty=false (å®‰å…¨ãƒ¢ãƒ¼ãƒ‰) ã§ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            // ã“ã‚Œã«ã‚ˆã‚Šã€ç”»é¢ä¸Šã®ç©ºæ¬„ã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª¤ã£ã¦æ¶ˆã™ã®ã‚’é˜²ãã¾ã™
            const finalData = collectFormData(originalData, false);

            alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
            return finalData;
        };

        // â˜…ã‚¹ãƒãƒ¼ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆ: schema.js ã® parseIaChara ã‚’ä½¿ç”¨
        getEl('btnMerge').addEventListener('click', () => {
            const text = getEl('txtImportSource').value;
            if(!text) return;
            
            // schema.jsã®ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’åˆ©ç”¨
           const p = parseIaChara(text);
        
        // é…åˆ—ãƒ‡ãƒ¼ã‚¿ã®åæ˜ 
        if(p.items && p.items.length > 0) {
            const list = document.getElementById('itemList');
            // æ—¢å­˜ã«è¿½åŠ ã™ã‚‹ã‹ã€ç½®æ›ã™ã‚‹ã‹ã¯UXæ¬¡ç¬¬ã§ã™ãŒã€ã“ã“ã§ã¯è¿½è¨˜ã«ã—ã¾ã™
            p.items.forEach(i => addItemRow(i));
        }
        if(p.weapons && p.weapons.length > 0) {
            p.weapons.forEach(w => addWeaponRow(w));
        }
        // ã‚¹ã‚­ãƒ«ã¯å…¨æ›¸ãæ›ãˆãŒå®‰å…¨
        if(p.skills) renderSkills(p.skills);

            // 1. åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åŸ‹ã‚è¾¼ã¿
            FIELD_MAPPING.forEach(f => {
                if(p[f.key]) fillIfEmpty(f.id, p[f.key]);
            });

            // 2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒã‚¤ã‚¿ãƒ«ã®åŸ‹ã‚è¾¼ã¿
            STATS_MAPPING.forEach(f => fillIfEmpty(f.id, p.stats[f.key]));
            VITALS_MAPPING.forEach(f => fillIfEmpty(f.id, p.vitals[f.key]));
            
            // 3. ãƒ¡ãƒ¢é …ç›®ã®åŸ‹ã‚è¾¼ã¿ (p.memoã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã§è¿”ã£ã¦ãã‚‹)
            Object.keys(MEMO_ID_MAP).forEach(key => {
                if(p.memo[key]) fillIfEmpty(MEMO_ID_MAP[key], p.memo[key]);
            });

            // 4. ã‚¢ã‚¤ãƒ†ãƒ 
            if(p.itemsStr) {
                const currentItems = getEl('txtItems').value;
                if(!currentItems) setVal('txtItems', p.itemsStr);
                else setVal('txtItems', currentItems + '\n' + p.itemsStr);
            }

            // 5. ç”»åƒ
            if(p.image && !getEl('previewBody').src) setSrc('previewBody', p.image);
            if(p.icon && !getEl('previewIcon').src) setSrc('previewIcon', p.icon);

            alert("ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã‚’è£œå®Œã—ã¾ã—ãŸï¼(Using Schema Parser)");
            runCalculations();
        });

        // è‡ªå‹•è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆUIåˆ¶å¾¡ã®ãŸã‚ã“ã“ã¯localã«æ®‹ã™ï¼‰
        function runCalculations() {
            const age = parseInt(getEl('inpAge')?.value)||0;
            const edu = parseInt(getEl('s_edu')?.value)||0;
            const eduArea = getEl('eduCheckArea');
            const eduMsg = getEl('eduMsg');
            if(eduArea) {
                if(edu>0 && age>0) {
                    const minAge=edu+6;
                    eduArea.style.display='block';
                    if(age<minAge){ eduMsg.className='warn-text'; eduMsg.textContent=`âš ï¸ å¹´é½¢ä¸è¶³ (EDU${edu}ãªã‚‰æœ€ä½${minAge}æ­³)`; }
                    else { eduMsg.className='calc-val'; eduMsg.textContent=`âœ… OK (æœ€ä½${minAge}æ­³)`; }
                } else eduArea.style.display='none';
            }
            const h = parseFloat(getEl('inpHeight')?.value), w = parseFloat(getEl('inpWeight')?.value);
            if(h>0 && w>0) {
                const bmi = w/((h/100)**2);
                getEl('outBMI').textContent = `${bmi.toFixed(1)}`;
            }
        }
        ['inpAge','inpHeight','inpWeight','s_edu'].forEach(id=>getEl(id)?.addEventListener('input', runCalculations));

        getEl('btnCreateNew').addEventListener('click', ()=>{
            const id=crypto.randomUUID();
            // æ–°è¦ä½œæˆæ™‚ã‚‚åŸºæœ¬æ§‹é€ ã¯Schemaæº–æ‹ ãŒæœ›ã¾ã—ã„ãŒã€ç©ºã§ã‚ˆã„ã®ã§ç°¡æ˜“åˆæœŸåŒ–
            allData[id]={id, name:"æ–°è¦ã‚­ãƒ£ãƒ©", stats:{}, vitals:{}, items:[], scenarioList:[]};
            currentId=id; renderSelect(); loadCharacterToForm(allData[id]);
        });
        getEl('btnDelete').addEventListener('click', async ()=>{
            if(!currentId)return;
            if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { delete allData[currentId]; location.reload(); }
        });
    </script>
</body>
</html>