<!-- --- START OF FILE list.html --- -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQUAD SELECTION</title>
    
    <!-- ゲーミング/SF風フォント -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700&family=Rajdhani:wght@600;700&family=Teko:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- ヘッダーCSS (あれば) -->
    <link href="list/header.css" rel="stylesheet">

    <style>
        /* --- Cyberpunk Theme Variables --- */
        :root {
            --bg-dark: #08080a;
            --card-w: 280px;
            --card-h: 580px;
            --gap: 50px;
            
            --neon-cyan: #00f3ff;
            --neon-magenta: #ff0055;
            --neon-yellow: #fcee0a;
            --glass: rgba(20, 20, 25, 0.8);
            
            --font-head: 'Rajdhani', sans-serif;
            --font-ui: 'Teko', sans-serif;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            font-family: 'Noto Sans JP', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex; flex-direction: column;
            color: #fff;
            perspective: 1000px;
        }

        /* --- 背景: デジタルグリッド --- */
        .bg-grid {
            position: absolute; inset: -50%;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.1) 1px, transparent 1px);
            background-size: 60px 60px;
            transform: rotateX(60deg);
            animation: gridMove 10s linear infinite;
            pointer-events: none; z-index: 0;
            mask-image: radial-gradient(ellipse at center, black 30%, transparent 70%);
        }
        @keyframes gridMove {
            0% { transform: rotateX(60deg) translateY(0); }
            100% { transform: rotateX(60deg) translateY(60px); }
        }

        /* --- ヘッダー --- */
        .ui-header {
            height: 70px; width: 100%; z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 40px; box-sizing: border-box;
            background: linear-gradient(180deg, rgba(0,0,0,0.8), transparent);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header-title {
            font-family: var(--font-head); font-size: 2rem; letter-spacing: 0.1em;
            background: linear-gradient(90deg, #fff, var(--neon-cyan));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 15px var(--neon-cyan);
        }
        .header-status {
            font-family: var(--font-ui); color: var(--neon-cyan); font-size: 1.2rem;
            animation: pulse 2s infinite;
        }

        /* --- メインステージ --- */
        .stage-wrapper {
            flex: 1; width: 100%; position: relative;
            display: flex; align-items: center; justify-content: center;
            perspective: 1200px; /* 3D空間の深さ */
            z-index: 10;
        }

        .scroll-container {
            display: flex; align-items: center;
            padding: 0 calc(50vw - var(--card-w) / 2);
            width: 100%; height: 100%;
            overflow-x: auto; scroll-behavior: smooth;
            scrollbar-width: none;
            padding-top: 40px;
        }
        .scroll-container::-webkit-scrollbar { display: none; }

        /* --- キャラクターカード --- */
        .char-card {
            flex: 0 0 var(--card-w);
            height: var(--card-h);
            margin: 0 var(--gap);
            position: relative;
            transform-style: preserve-3d; /* 重要 */
            cursor: pointer;
            opacity: 0; /* 初期状態は非表示 */
            /* 登場アニメーションはJSで制御 */
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .char-card.active {
            animation: holoSpawn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* カードのホバーアクション */
        .char-card:hover {
            z-index: 50;
        }
        .char-card:hover .monitor-layer {
            transform: translateZ(0) scale(1.05);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.3);
        }
        .char-card:hover .figure-layer {
            transform: translateZ(80px) scale(1.1) translateY(-10px);
            filter: drop-shadow(0 20px 30px rgba(0,0,0,0.8));
        }
        .char-card:hover .info-layer {
            transform: translateZ(60px) translateX(-15px);
            border-color: var(--neon-cyan);
            color: #fff;
        }

        /* --- Layer 1: 背景モニター --- */
        .monitor-layer {
            position: absolute; inset: 0; bottom: 15%; /* 足元を空ける */
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 4px;
            overflow: hidden;
            transform: translateZ(0);
            transition: 0.4s;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 85% 100%, 0 100%); /* テック風カット */
        }
        .monitor-bg {
            width: 100%; height: 100%;
            background-size: cover; background-position: top center;
            opacity: 0.5; filter: grayscale(100%) contrast(1.2);
            transition: 0.5s;
        }
        .monitor-scanline {
            position: absolute; inset: 0;
            background: linear-gradient(transparent 50%, rgba(0,0,0,0.5) 50%);
            background-size: 100% 4px;
            pointer-events: none; opacity: 0.7;
        }
        
        .char-card:hover .monitor-bg {
            opacity: 0.8; filter: grayscale(0%); transform: scale(1.1);
        }

        /* --- Layer 2: 情報タグ --- */
        .info-layer {
            position: absolute; top: 30px; left: -15px;
            padding: 10px 5px;
            background: rgba(10,10,12,0.9);
            border-left: 4px solid #555;
            display: flex; flex-direction: column; align-items: center;
            transform: translateZ(40px);
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            transition: 0.4s;
            backdrop-filter: blur(4px);
        }
        .info-job {
            writing-mode: vertical-rl; font-family: var(--font-head); font-size: 0.8rem;
            color: #888; letter-spacing: 0.2em; margin-bottom: 5px;
        }
        .info-name {
            writing-mode: vertical-rl; text-orientation: upright;
            font-family: 'Noto Sans JP'; font-weight: 700; font-size: 1.2rem;
            letter-spacing: 0.2em;
        }

        /* --- Layer 3: フィギュア & 台座 --- */
        .figure-wrapper {
            position: absolute; inset: 0;
            pointer-events: none;
            transform-style: preserve-3d;
            z-index: 10;
        }

        /* ホログラム台座 */
        .base-plate {
            position: absolute; bottom: 20px; left: 50%;
            width: 200px; height: 200px;
            transform: translateX(-50%) rotateX(70deg) translateZ(20px);
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.1);
            background: radial-gradient(circle, rgba(0, 243, 255, 0.1) 0%, transparent 60%);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.05);
            transition: 0.4s;
        }
        .base-ring {
            position: absolute; inset: 10px; border-radius: 50%;
            border: 1px dashed var(--neon-cyan); opacity: 0.3;
            animation: spin 8s linear infinite;
        }

        /* 立ち絵本体 */
        .figure-layer {
            position: absolute; bottom: 40px; left: 50%;
            width: auto; height: 65%; /* カードに対する高さ比率 */
            transform: translateX(-50%) translateZ(60px); /* 画面から飛び出す配置 */
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.6));
            transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            object-fit: contain;
        }

        /* --- UI Controls --- */
        .nav-btn {
            position: absolute; top: 50%; width: 60px; height: 100px;
            transform: translateY(-50%);
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: rgba(255,255,255,0.2); cursor: pointer;
            z-index: 200; transition: 0.3s;
            text-shadow: 0 0 10px #000;
        }
        .nav-btn:hover { color: var(--neon-cyan); text-shadow: 0 0 20px var(--neon-cyan); scale: 1.1; }
        .nav-btn.prev { left: 20px; }
        .nav-btn.next { right: 20px; }

        .click-area { position: absolute; inset: 0; z-index: 100; transform: translateZ(100px); cursor: pointer; }
        
        .edit-btn {
            position: absolute; top: 10px; right: 10px;
            background: #000; border: 1px solid #444; color: #888;
            font-family: var(--font-ui); font-size: 0.8rem; padding: 2px 8px;
            transform: translateZ(90px); opacity: 0; z-index: 101; transition: 0.3s; cursor: pointer;
        }
        .char-card:hover .edit-btn { opacity: 1; }
        .edit-btn:hover { border-color: var(--neon-cyan); color: var(--neon-cyan); }

        /* --- Animations --- */
        @keyframes holoSpawn {
            0% { opacity: 0; transform: translateY(50px) scale(0.8) rotateY(10deg); filter: blur(5px); }
            100% { opacity: 1; transform: translateY(0) scale(1) rotateY(0); filter: blur(0); }
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .loading-msg {
            font-family: var(--font-head); font-size: 2rem; color: #fff;
            text-shadow: 0 0 10px var(--neon-cyan);
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>

    <script type="module">
        // ヘッダー読み込み（失敗しても止まらないようにtry-catch）
        try {
            import { initHeader } from "./header.js"; 
            initHeader();
        } catch(e) { console.log("Header module skipped"); }
    </script>

    <div class="bg-grid"></div>

    <header class="ui-header">
        <div class="header-title">SQUAD SELECTION</div>
        <div class="header-status">● SYSTEM ONLINE</div>
    </header>

    <div class="stage-wrapper">
        <div class="nav-btn prev" id="btnPrev">‹</div>
        
        <div class="scroll-container" id="stage">
            <div class="loading-msg">INITIALIZING...</div>
        </div>
        
        <div class="nav-btn next" id="btnNext">›</div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud } from "./firestore.js";

        const stage = document.getElementById('stage');

        // --- デモ用データ（Firebaseが読み込めない場合の保険） ---
        const DEMO_DATA = {
            char1: { id: 'c1', name: 'KASUMI', job: '突撃兵', image: 'https://placehold.co/300x600/1a1a2e/00f3ff?text=KASUMI' },
            char2: { id: 'c2', name: 'ALEX', job: '衛生兵', image: 'https://placehold.co/300x600/2e1a1a/ff0055?text=ALEX' },
            char3: { id: 'c3', name: 'RAY', job: '工学者', image: 'https://placehold.co/300x600/2e2e1a/fcee0a?text=RAY' },
            char4: { id: 'c4', name: 'ZED', job: '隠密', image: 'https://placehold.co/300x600/1a2e1a/00ff00?text=ZED' },
            char5: { id: 'c5', name: 'NOVA', job: '司令官', image: 'https://placehold.co/300x600/333333/ffffff?text=NOVA' },
        };

        // --- データ取得と開始処理 ---
        async function init() {
            try {
                console.log("Connecting to Database...");
                // ここで loadFromCloud を試行
                let data = null;
                
                // loadFromCloudが定義されているかチェック
                if (typeof loadFromCloud === 'function') {
                    data = await loadFromCloud();
                } else {
                    throw new Error("loadFromCloud function missing");
                }

                // データが空ならデモデータを使用
                if (!data || Object.keys(data).length === 0) {
                    console.warn("Data empty. Switching to DEMO MODE.");
                    renderList(DEMO_DATA);
                } else {
                    console.log("Data loaded successfully.");
                    renderList(data);
                }
            } catch (error) {
                console.error("Initialization Failed:", error);
                console.log("Activating Emergency Protocol (Demo Data)...");
                // エラー時もデモデータを表示して画面真っ白を防ぐ
                renderList(DEMO_DATA);
            }
        }

        // --- 描画ロジック ---
        function renderList(data) {
            stage.innerHTML = ''; // ローディング消去

            Object.values(data).forEach((char, index) => {
                const card = document.createElement('div');
                card.className = 'char-card';
                
                // 画像URL (なければプレースホルダー)
                const imgUrl = char.image || 'https://placehold.co/300x600/000/fff?text=NO+IMG';
                const jobName = char.job || 'UNKNOWN';

                // 職業ごとの色定義
                let accentColor = 'var(--neon-cyan)';
                if(jobName.includes('兵') || jobName.includes('戦')) accentColor = 'var(--neon-magenta)';
                if(jobName.includes('医') || jobName.includes('工')) accentColor = 'var(--neon-yellow)';

                card.innerHTML = `
                    <!-- 1. 背景モニター -->
                    <div class="monitor-layer">
                        <div class="monitor-bg" style="background-image: url('${imgUrl}');"></div>
                        <div class="monitor-scanline"></div>
                    </div>

                    <!-- 2. 情報タグ -->
                    <div class="info-layer" style="border-left-color: ${accentColor}; color: ${accentColor};">
                        <span class="info-job">${jobName}</span>
                        <span class="info-name">${char.name}</span>
                    </div>

                    <!-- 3. フィギュア & 台座 -->
                    <div class="figure-wrapper">
                        <div class="base-plate" style="border-color: ${accentColor}; box-shadow: 0 0 10px ${accentColor};">
                            <div class="base-ring" style="border-color: ${accentColor};"></div>
                        </div>
                        <img src="${imgUrl}" class="figure-layer" alt="${char.name}" onerror="this.style.opacity='0'">
                    </div>

                    <!-- 4. UI -->
                    <div class="edit-btn">EDIT</div>
                    <div class="click-area"></div>
                `;

                // 画像編集
                card.querySelector('.edit-btn').onclick = (e) => {
                    e.stopPropagation();
                    const newUrl = prompt("新しい画像URL:", char.image || "");
                    if(newUrl) {
                        char.image = newUrl;
                        if(typeof saveToCloud === 'function') {
                            saveToCloud(char).then(() => location.reload());
                        } else {
                            alert("デモモードのため保存されません");
                        }
                    }
                };

                // 詳細遷移
                card.querySelector('.click-area').onclick = () => {
                    window.location.href = `character/detail/detail.html?id=${char.id}`;
                };

                stage.appendChild(card);

                // 順番にアニメーション起動 (ホログラム出現風)
                setTimeout(() => {
                    card.classList.add('active');
                }, index * 150); // 150msずつずらす
            });
        }

        // --- 実行 ---
        init();

        // --- スクロール制御 ---
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');
        const SCROLL_AMT = 330;

        btnNext.onclick = () => stage.scrollBy({ left: SCROLL_AMT, behavior: 'smooth' });
        btnPrev.onclick = () => stage.scrollBy({ left: -SCROLL_AMT, behavior: 'smooth' });
        
        // マウスホイール横スクロール
        stage.addEventListener('wheel', (e) => {
            e.preventDefault();
            stage.scrollLeft += e.deltaY;
        });

    </script>
</body>
</html>