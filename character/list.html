<!-- --- START OF FILE list.html --- -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQUAD SELECTION</title>
    
    <!-- SF/ゲーム風フォント -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700&family=Rajdhani:wght@600;700&family=Teko:wght@500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #050508;
            --card-width: 260px;
            --card-height: 520px;
            --depth-spacing: 80px; /* スクリーンと立ち絵の距離 */
            
            --neon-blue: #00f3ff;
            --neon-red: #ff0055;
            --neon-yellow: #ffd700;
            
            --font-ui: 'Rajdhani', sans-serif;
            --font-jp: 'Noto Sans JP', sans-serif;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 100%, #1a1a20 0%, #000 80%);
            font-family: var(--font-jp);
            overflow: hidden;
            height: 100vh;
            display: flex; flex-direction: column;
            color: #fff;
        }

        /* --- UI ヘッダー --- */
        .game-ui-header {
            height: 60px; width: 100%; z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 40px; box-sizing: border-box;
            background: linear-gradient(180deg, rgba(0,0,0,0.9), transparent);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .ui-title { font-family: var(--font-ui); font-size: 1.5rem; letter-spacing: 0.2em; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); }

        /* --- 3Dステージ --- */
        .stage-viewport {
            flex: 1; width: 100%; position: relative;
            display: flex; align-items: center; justify-content: center;
            perspective: 1500px; /* 奥行きを強調 */
            overflow: hidden;
        }

        /* 床のグリッド */
        .floor-grid {
            position: absolute; bottom: -20vh; left: -50%; width: 200%; height: 100vh;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.1) 1px, transparent 1px);
            background-size: 80px 80px;
            transform: rotateX(80deg);
            pointer-events: none; z-index: 0;
            mask-image: radial-gradient(ellipse at center, black 40%, transparent 80%);
            animation: floorScroll 5s linear infinite;
        }
        @keyframes floorScroll { from { background-position: 0 0; } to { background-position: 0 80px; } }

        .scroll-rail {
            display: flex; align-items: center;
            padding: 0 calc(50vw - var(--card-width) / 2);
            width: 100%; height: 100%;
            overflow-x: auto; scroll-behavior: smooth;
            scrollbar-width: none;
            padding-top: 50px; /* 視点調整 */
            transform-style: preserve-3d;
        }
        .scroll-rail::-webkit-scrollbar { display: none; }

        /* --- キャラクターユニット (親コンテナ) --- */
        .char-unit {
            flex: 0 0 var(--card-width);
            height: var(--card-height);
            margin: 0 60px;
            position: relative;
            transform-style: preserve-3d; /* 必須: 子要素を3D配置 */
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            cursor: pointer;
        }

        .char-unit:hover {
            transform: scale(1.05); /* 全体を少し拡大 */
            z-index: 50;
        }

        /* === 構成要素1: 背面スクリーン (奥) === */
        .back-screen {
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 75%; /* 足元を空ける */
            background: #111;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            transform: translateZ(0px); /* 基準面 */
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            transition: 0.3s;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 85% 100%, 0 100%);
        }
        .screen-image {
            width: 100%; height: 100%;
            background-size: cover; background-position: top center;
            opacity: 0.4; filter: grayscale(100%) contrast(1.2);
            transition: 0.5s;
        }
        /* スクリーンの走査線 */
        .screen-scanline {
            position: absolute; inset: 0;
            background: linear-gradient(transparent 50%, rgba(0,0,0,0.5) 50%);
            background-size: 100% 4px; pointer-events: none;
        }

        /* === 構成要素2: 立ち絵フィギュア (手前) === */
        /* スクリーンから独立させるためのラッパー */
        .figure-wrapper {
            position: absolute; bottom: 0; left: 50%;
            width: 100%; height: 100%;
            transform: translateX(-50%) translateZ(var(--depth-spacing)); /* スクリーンより手前に配置 */
            pointer-events: none;
            transform-style: preserve-3d;
            z-index: 10;
        }

        /* フィギュア本体 */
        .char-figure {
            position: absolute; bottom: 30px; left: 50%;
            height: 420px; /* スクリーンの枠をはみ出すサイズ */
            width: auto;
            transform: translateX(-50%);
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.8));
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* === 構成要素3: 台座 (足元) === */
        .base-platform {
            position: absolute; bottom: 20px; left: 50%;
            width: 180px; height: 180px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 243, 255, 0.1) 0%, transparent 60%);
            border: 1px solid rgba(0, 243, 255, 0.2);
            transform: translateX(-50%) rotateX(70deg) translateZ(calc(var(--depth-spacing) - 20px));
            /* 台座はスクリーンの手前、フィギュアの直下に配置 */
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.05);
            transition: 0.3s;
        }
        .base-center {
            position: absolute; top: 50%; left: 50%; width: 60%; height: 60%;
            border-radius: 50%; border: 1px dashed rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            animation: spin 10s linear infinite;
        }

        /* === 構成要素4: 情報UI (浮遊) === */
        .info-tag {
            position: absolute; top: 20px; left: -20px;
            background: rgba(10,10,12,0.95);
            border-left: 3px solid #555;
            padding: 10px 5px;
            display: flex; flex-direction: column; align-items: center;
            transform: translateZ(40px); /* スクリーンとフィギュアの中間 */
            box-shadow: 5px 5px 15px rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            transition: 0.3s;
        }
        .info-job { writing-mode: vertical-rl; font-family: var(--font-ui); font-size: 0.7rem; color: #888; letter-spacing: 0.2em; margin-bottom: 5px; }
        .info-name { writing-mode: vertical-rl; text-orientation: upright; font-family: var(--font-jp); font-weight: 700; font-size: 1.1rem; letter-spacing: 0.2em; }

        /* --- アクション & アニメーション --- */
        .char-unit:hover .back-screen { border-color: var(--neon-blue); box-shadow: 0 0 40px rgba(0, 243, 255, 0.2); }
        .char-unit:hover .screen-image { opacity: 0.8; filter: grayscale(0%); transform: scale(1.1); }
        
        /* ホバー時: フィギュアがさらに手前に浮き出る */
        .char-unit:hover .char-figure {
            transform: translateX(-50%) translateY(-10px) translateZ(40px) scale(1.05);
            filter: drop-shadow(0 20px 30px rgba(0,0,0,0.9));
        }
        .char-unit:hover .base-platform {
            border-color: var(--neon-blue);
            background: radial-gradient(circle, rgba(0, 243, 255, 0.3) 0%, transparent 70%);
            box-shadow: 0 0 50px var(--neon-blue);
        }
        .char-unit:hover .info-tag { border-left-color: var(--neon-blue); color: #fff; transform: translateZ(60px) translateX(-5px); }

        /* UIボタン */
        .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 80px; height: 120px;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: rgba(255,255,255,0.2); cursor: pointer; z-index: 200;
        }
        .nav-arrow:hover { color: var(--neon-blue); text-shadow: 0 0 20px var(--neon-blue); }
        .nav-arrow.prev { left: 10px; } .nav-arrow.next { right: 10px; }

        .click-layer { position: absolute; inset: 0; z-index: 100; transform: translateZ(200px); cursor: pointer; }
        .edit-badge {
            position: absolute; top: 10px; right: 10px;
            background: #000; color: #888; font-size: 0.8rem; padding: 2px 8px; border: 1px solid #444;
            transform: translateZ(150px); opacity: 0; z-index: 101; transition: 0.3s; cursor: pointer;
        }
        .char-unit:hover .edit-badge { opacity: 1; }

        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        .error-msg { color: #ff0055; font-size: 1.5rem; text-shadow: 0 0 10px red; }
    </style>
</head>
<body>

    <div class="game-ui-header">
        <div class="ui-title">AGENT // DATABASE</div>
        <div style="font-family:'Teko'; color:#00f3ff;">SYSTEM: ONLINE</div>
    </div>

    <div class="stage-viewport">
        <div class="floor-grid"></div> <!-- 床 -->
        
        <div class="nav-arrow prev" id="btnPrev">‹</div>
        
        <div class="scroll-rail" id="stage">
            <div style="color:#666; font-family:'Teko'; font-size:2rem;">CONNECTING...</div>
        </div>
        
        <div class="nav-arrow next" id="btnNext">›</div>
    </div>

    <script type="module">
        // ★重要: importエラーを回避するための動的読み込み
        // 外部ファイルが死んでいても処理を止めない
        let firestore = null;
        try {
            // firestore.jsが同じフォルダにあると仮定して読み込み試行
            firestore = await import('./firestore.js');
        } catch (e) {
            console.warn("Firestore module not found. Switching to offline mode.");
        }

        const stage = document.getElementById('stage');

        // デモ用データ (通信エラー時の保険)
        const DEMO_AGENTS = {
            1: { id: '01', name: 'AKIRA', job: '突撃兵', image: 'https://placehold.co/300x700/111/00f3ff?text=AKIRA' },
            2: { id: '02', name: 'LUNA', job: '衛生兵', image: 'https://placehold.co/300x700/221/ff0055?text=LUNA' },
            3: { id: '03', name: 'GHOST', job: '隠密', image: 'https://placehold.co/300x700/112/ffd700?text=GHOST' },
            4: { id: '04', name: 'TITAN', job: '重装兵', image: 'https://placehold.co/300x700/222/ffffff?text=TITAN' },
        };

        async function initSystem() {
            let data = null;

            // 1. データ取得試行
            if (firestore && firestore.loadFromCloud) {
                try {
                    data = await firestore.loadFromCloud();
                } catch (err) { console.error("Cloud load failed", err); }
            }

            // 2. データが無ければデモデータ使用
            if (!data || Object.keys(data).length === 0) {
                console.log("Using Demo Data");
                renderCards(DEMO_AGENTS, false); // false = 保存機能無効
            } else {
                console.log("Cloud Data Loaded");
                renderCards(data, true);
            }
        }

        function renderCards(data, canSave) {
            stage.innerHTML = '';
            
            Object.values(data).forEach((char, idx) => {
                const unit = document.createElement('div');
                unit.className = 'char-unit';
                
                // 画像URL
                const img = char.image || 'https://placehold.co/300x700/000/666?text=NO+IMG';
                const job = char.job || 'UNKNOWN';

                // HTML構築: スクリーンとフィギュアを完全に別要素にする
                unit.innerHTML = `
                    <!-- 1. 奥のスクリーン (顔拡大・枠内) -->
                    <div class="back-screen">
                        <div class="screen-image" style="background-image: url('${img}');"></div>
                        <div class="screen-scanline"></div>
                    </div>

                    <!-- 2. 中間の情報タグ -->
                    <div class="info-tag">
                        <span class="info-job">${job}</span>
                        <span class="info-name">${char.name}</span>
                    </div>

                    <!-- 3. 手前の台座 -->
                    <div class="base-platform">
                        <div class="base-center"></div>
                    </div>

                    <!-- 4. 最前面のフィギュア (枠外・独立) -->
                    <div class="figure-wrapper">
                        <img src="${img}" class="char-figure" alt="${char.name}" onerror="this.style.opacity='0'">
                    </div>

                    <!-- 5. UI -->
                    <div class="edit-badge">EDIT</div>
                    <div class="click-layer"></div>
                `;

                // 画像編集 (保存可能な場合のみ)
                const editBtn = unit.querySelector('.edit-badge');
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    const newUrl = prompt("画像URLを入力:", char.image || "");
                    if(newUrl && canSave && firestore) {
                        char.image = newUrl;
                        firestore.saveToCloud(char).then(() => location.reload());
                    } else if(newUrl) {
                        alert("デモモードのため保存できませんが、見た目はこうなります。");
                        unit.querySelector('.char-figure').src = newUrl;
                        unit.querySelector('.screen-image').style.backgroundImage = `url('${newUrl}')`;
                    }
                };

                // 詳細遷移
                unit.querySelector('.click-layer').onclick = () => {
                    window.location.href = `character/detail/detail.html?id=${char.id}`;
                };

                stage.appendChild(unit);
                
                // 出現アニメーション
                unit.style.opacity = '0';
                unit.style.transform = 'translateY(50px) rotateY(10deg)';
                setTimeout(() => {
                    unit.style.opacity = '1';
                    unit.style.transform = 'translateY(0) rotateY(0)';
                }, idx * 100);
            });
        }

        // 初期化実行
        initSystem();

        // スクロール制御
        const btnNext = document.getElementById('btnNext');
        const btnPrev = document.getElementById('btnPrev');
        btnNext.onclick = () => stage.scrollBy({ left: 320, behavior: 'smooth' });
        btnPrev.onclick = () => stage.scrollBy({ left: -320, behavior: 'smooth' });
        stage.addEventListener('wheel', (e) => { e.preventDefault(); stage.scrollLeft += e.deltaY; });

    </script>
</body>
</html>