--- START OF FILE dialogue.html ---

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dialogue Maker</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f4f8;
            --main-color: #ff6b6b; /* POP RED */
            --sub-color: #4ecdc4;   /* POP TEAL */
            --accent: #ffe66d;      /* POP YELLOW */
            --text: #2d3436;
            --bubble-bg: #ffffff;
        }
        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--sub-color) 1px, transparent 1px);
            background-size: 20px 20px; /* „Éâ„ÉÉ„ÉàÊüÑ */
            color: var(--text);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            margin: 0; padding: 40px 10px;
            display: flex; flex-direction: column; align-items: center;
        }

        .container {
            width: 100%; max-width: 900px;
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 30px;
            border: 4px solid var(--text);
        }

        h2 {
            text-align: center; font-size: 2rem; color: var(--main-color);
            text-shadow: 2px 2px 0px var(--text);
            margin-top: 0; letter-spacing: 0.1em;
        }

        /* Tabs */
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
        .tab-btn {
            background: var(--text); color: #fff; border: none;
            padding: 10px 25px; border-radius: 30px; font-weight: bold;
            cursor: pointer; transition: transform 0.2s;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        .tab-btn.active {
            background: var(--main-color); transform: scale(1.1); box-shadow: 3px 3px 0 var(--text);
        }
        .tab-btn:hover { opacity: 0.9; }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; animation: popIn 0.4s; }
        @keyframes popIn { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* Section Headers */
        .section-header {
            background: var(--accent); color: var(--text);
            display: inline-block; padding: 5px 20px; border-radius: 15px;
            border: 2px solid var(--text); font-weight: bold; margin: 30px 0 15px;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
        }

        /* Bubble Input Styling */
        .bubble-group { margin-bottom: 20px; }
        .bubble-label {
            font-size: 0.9rem; font-weight: bold; color: var(--sub-color); margin-bottom: 5px; display: block;
        }
        .bubble-input {
            width: 100%; height: 80px;
            border: 2px solid #ddd; border-radius: 15px;
            padding: 15px; font-size: 14px; box-sizing: border-box;
            background: var(--bubble-bg);
            transition: 0.3s; resize: vertical;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            position: relative;
        }
        .bubble-input:focus {
            border-color: var(--sub-color); outline: none;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
        }
        /* Âêπ„ÅçÂá∫„Åó„ÅÆ„Åó„Å£„ÅΩÔºàË£ÖÈ£æÔºâ */
        .bubble-wrapper { position: relative; }
        .bubble-wrapper::after {
            content: ''; position: absolute; bottom: -10px; left: 30px;
            border-width: 10px 10px 0; border-style: solid;
            border-color: var(--bubble-bg) transparent; display: block; width: 0;
            z-index: 2;
        }
        .bubble-wrapper::before {
            content: ''; position: absolute; bottom: -13px; left: 28px;
            border-width: 12px 12px 0; border-style: solid;
            border-color: #ddd transparent; display: block; width: 0;
            z-index: 1;
        }
        .bubble-input:focus + .bubble-tail::before { border-top-color: var(--sub-color); }

        /* Grid Layout */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        /* Action Buttons */
        .action-btn {
            width: 100%; padding: 15px;
            background: var(--main-color); color: #fff;
            border: 3px solid var(--text); border-radius: 10px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
            box-shadow: 5px 5px 0 var(--text);
            margin-top: 30px; transition: 0.2s;
        }
        .action-btn:active { transform: translate(2px, 2px); box-shadow: 3px 3px 0 var(--text); }
        .add-btn { background: var(--sub-color); margin-bottom: 20px; font-size: 1rem; }

        /* DUO Specific */
        .duo-row {
            background: #fff; border: 2px dashed #ccc; border-radius: 10px;
            padding: 15px; margin-bottom: 15px; position: relative;
        }
        .duo-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .situation-select {
            padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-family: inherit;
        }
        .del-btn {
            background: #ff6b6b; color: white; border: none;
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            font-weight: bold; line-height: 1;
        }
        .duo-grid { display: grid; grid-template-columns: 40px 1fr 1fr; gap: 10px; align-items: center; }
        .char-icon {
            width: 30px; height: 30px; background: #ddd; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666;
        }

        /* Select Box */
        .big-select {
            width: 100%; padding: 12px; font-size: 16px; border-radius: 10px;
            border: 2px solid var(--text); background: white; font-family: inherit;
            margin-bottom: 20px;
        }

        @media (max-width: 700px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>üí¨ DIALOGUE MAKER</h2>
        <div id="auth-status" style="text-align:center; margin-bottom:10px; font-size:12px;">Connecting...</div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('solo')">üë§ „ÇΩ„É≠Âè∞Ë©û (Solo)</button>
            <button class="tab-btn" onclick="switchTab('duo')">üë• DUO (Êéõ„ÅëÂêà„ÅÑ)</button>
        </div>

        <!-- === SOLO PANEL === -->
        <div id="panel-solo" class="panel active">
            <select id="char-select-solo" class="big-select" onchange="loadSoloData()">
                <option value="">„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Å≠</option>
            </select>

            <!-- JS„ÅßËá™ÂãïÁîüÊàê„Åô„Çã„Åü„ÇÅ„ÅÆ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº -->
            <div id="solo-form-area"></div>

            <button class="action-btn" onclick="saveSolo()">SAVE SETTINGS !</button>
        </div>

        <!-- === DUO PANEL === -->
        <div id="panel-duo" class="panel">
            <div class="grid-2" style="margin-bottom: 20px;">
                <div>
                    <span class="bubble-label">CHAR A („ÅÇ„Å™„Åü)</span>
                    <select id="char-a" class="big-select" onchange="loadDuoData()"><option value="">--</option></select>
                </div>
                <div>
                    <span class="bubble-label">CHAR B (Áõ∏Êâã)</span>
                    <select id="char-b" class="big-select" onchange="loadDuoData()"><option value="">--</option></select>
                </div>
            </div>

            <div id="conv-list"></div>
            
            <button class="action-btn add-btn" onclick="addConvRow()">+ „Éë„Çø„Éº„É≥„ÇíËøΩÂä† (Add Pattern)</button>
            <button class="action-btn" onclick="saveDuo()">SAVE CONVERSATION !</button>
        </div>

        <a href="../zo.html" style="display:block; text-align:center; margin-top:20px; color:#888; text-decoration:none;">‚Üê Êàª„Çã</a>
    </div>

    <script type="module">
        import { login, monitorAuth, loadFromCloud, saveToCloud } from "./firestore.js";
        import { DIALOGUE_MAPPING, DUO_SITUATIONS, createDuoConversationRecord, updateDuoConversation } from "./data/dialogue.js";

        let allData = {};
        let currentUser = null;

        // --- ÂàùÊúüÂåñ & Ë™çË®º ---
        monitorAuth(async (user) => {
            const el = document.getElementById('auth-status');
            if (user) {
                currentUser = user;
                el.textContent = "LOGIN: " + user.displayName;
                el.style.color = "#4ecdc4";
                await initData();
            } else {
                el.textContent = "CLICK TO LOGIN";
                el.style.cursor = "pointer"; el.style.color = "#ff6b6b";
                el.onclick = login;
            }
        });

        async function initData() {
            const data = await loadFromCloud();
            if (!data) return;
            allData = data;
            
            const opts = ['<option value="">„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Å≠</option>'];
            Object.values(data).forEach(c => opts.push(`<option value="${c.name}">${c.name}</option>`));
            
            document.getElementById('char-select-solo').innerHTML = opts.join('');
            document.getElementById('char-a').innerHTML = opts.join('');
            document.getElementById('char-b').innerHTML = opts.join('');

            // „ÇΩ„É≠„Éï„Ç©„Éº„É†„ÅÆËá™ÂãïÁîüÊàê (JS„ÅßHTML„Çí‰Ωú„Çã)
            renderSoloForm();
        }

        window.switchTab = (mode) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            
            if(mode === 'solo') {
                document.querySelector('button[onclick="switchTab(\'solo\')"]').classList.add('active');
                document.getElementById('panel-solo').classList.add('active');
            } else {
                document.querySelector('button[onclick="switchTab(\'duo\')"]').classList.add('active');
                document.getElementById('panel-duo').classList.add('active');
            }
        };

        // --- SOLO LOGIC ---

        function renderSoloForm() {
            const container = document.getElementById('solo-form-area');
            let html = "";
            
            // „Ç´„ÉÜ„Ç¥„É™„Åî„Å®„Å´„Ç∞„É´„Éº„Éî„É≥„Ç∞„Åô„Çã„Åü„ÇÅ„ÅÆÁ∞°Êòì„É≠„Ç∏„ÉÉ„ÇØ
            const categories = {
                "DAILY": ["txtDialogueDefault", "txtDialogueMorning", "txtDialogueDay", "txtDialogueNight", "txtDialogueWait", "txtDialogueAfk"],
                "RELATION": ["txtDialogueAboutOthers", "txtDialogueThanks", "txtDialogueApology", "txtDialogueLove", "txtDialogueDuo"],
                "BATTLE": ["txtDialogueBattleStart", "txtDialogueBattleCrit", "txtDialogueBattleFumble", "txtDialogueLowSan", "txtDialogueInsanity"]
            };

            for (const [catName, fieldIds] of Object.entries(categories)) {
                html += `<div class="section-header">${catName}</div>`;
                html += `<div class="grid-2">`; // Âü∫Êú¨„ÅØ2„Ç´„É©„É†
                
                fieldIds.forEach(id => {
                    const map = DIALOGUE_MAPPING.find(m => m.id === id);
                    if(map) {
                        // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÔºàË¶ãÊú¨Ôºâ„ÅÆË®≠ÂÆö
                        let ph = "";
                        if(map.key.includes("Wait")) ph = "‰æãÔºö„ÇìÔºü„Åæ„Å†„Åã„Å™...\n‰æãÔºö„Åä„Éº„ÅÑÔºÅ";
                        if(map.key.includes("Afk")) ph = "‰æãÔºözZz... (Â±ÖÁú†„Çä)\n‰æãÔºöËÄÉ„Åà‰∫ã„Çí„Åó„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å†„ÄÇ";
                        if(map.key.includes("About")) ph = "‰æãÔºö„ÅÇ„ÅÑ„Å§„ÅØÈù¢ÁôΩ„ÅÑÂ•¥„Å†„Çà„ÄÇ\n‰æãÔºö[To:Alice] „Ç¢„É™„Çπ„ÅÆ„ÅîÈ£Ø„ÅØÁæéÂë≥„Åó„ÅÑ„Çì„Å†„ÄÇ";

                        html += `
                            <div class="bubble-group">
                                <label class="bubble-label">${map.label}</label>
                                <div class="bubble-wrapper">
                                    <textarea id="${map.id}" class="bubble-input" placeholder="${ph}"></textarea>
                                </div>
                            </div>
                        `;
                    }
                });
                html += `</div>`;
            }
            container.innerHTML = html;
        }
        
        window.loadSoloData = () => {
            const name = document.getElementById('char-select-solo').value;
            DIALOGUE_MAPPING.forEach(field => {
                const el = document.getElementById(field.id);
                if (!el) return;
                if (name && allData[name]) {
                    el.value = allData[name][field.key] || "";
                } else {
                    el.value = "";
                }
            });
        };

        window.saveSolo = async () => {
            const name = document.getElementById('char-select-solo').value;
            if (!name) return alert("„Ç≠„É£„É©„ÇíÈÅ∏„Çì„Åß„Å≠ÔºÅ");
            const c = allData[name];
            DIALOGUE_MAPPING.forEach(field => {
                const el = document.getElementById(field.id);
                if (el) c[field.key] = el.value;
            });
            await saveToCloud(c);
            alert("‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ‚ú®");
        };

        // --- DUO LOGIC ---

        window.addConvRow = (data = {}) => {
            const aVal = data.a || "";
            const bVal = data.b || "";
            const sitVal = data.situation || "Êó•Â∏∏ (Normal)";

            const div = document.createElement('div'); div.className = 'duo-row';
            
            // „Ç∑„ÉÅ„É•„Ç®„Éº„Ç∑„Éß„É≥ÈÅ∏ÊäûËÇ¢„ÅÆÁîüÊàê
            let sitOpts = DUO_SITUATIONS.map(s => 
                `<option value="${s}" ${s === sitVal ? 'selected' : ''}>${s}</option>`
            ).join('');

            div.innerHTML = `
                <div class="duo-header">
                    <select class="situation-select sit-tag">${sitOpts}</select>
                    <button class="del-btn" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
                <div class="duo-grid">
                    <div class="char-icon">A</div>
                    <div class="bubble-wrapper"><textarea class="bubble-input txt-a" placeholder="A„ÅÆÂè∞Ë©û">${aVal}</textarea></div>
                </div>
                <div class="duo-grid" style="margin-top:10px;">
                    <div class="char-icon" style="background:var(--text);color:#fff;">B</div>
                    <div class="bubble-wrapper"><textarea class="bubble-input txt-b" placeholder="B„ÅÆÂè∞Ë©û">${bVal}</textarea></div>
                </div>
            `;
            document.getElementById('conv-list').appendChild(div);
        };

        window.loadDuoData = () => {
            const nA = document.getElementById('char-a').value;
            const nB = document.getElementById('char-b').value;
            const list = document.getElementById('conv-list');
            list.innerHTML = "";
            
            if (!nA || !nB || nA === nB) return;

            const cA = allData[nA];
            if (cA.duo_conversations) {
                const pair = cA.duo_conversations.find(p => p.partner === nB);
                if (pair && pair.scripts) {
                    pair.scripts.forEach(s => window.addConvRow(s));
                    return;
                }
            }
            window.addConvRow(); // ÂàùÊúüË°®Á§∫Áî®
        };

        window.saveDuo = async () => {
            const nA = document.getElementById('char-a').value;
            const nB = document.getElementById('char-b').value;
            if (!nA || !nB || nA === nB) return alert("„Éö„Ç¢„ÅåÁÑ°Âäπ„Å†„Çàüí¶");

            const scripts = [];
            document.querySelectorAll('.duo-row').forEach(row => {
                const a = row.querySelector('.txt-a').value;
                const b = row.querySelector('.txt-b').value;
                const situation = row.querySelector('.sit-tag').value;
                
                if(a || b) {
                    // „Ç∑„ÉÅ„É•„Ç®„Éº„Ç∑„Éß„É≥„ÇÇÂê´„ÇÅ„Å¶‰øùÂ≠ò
                    scripts.push({ a, b, situation });
                }
            });

            const duoRecord = createDuoConversationRecord(nB, scripts);
            // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            allData[nA] = updateDuoConversation(allData[nA], duoRecord);
            
            await saveToCloud(allData[nA]);
            alert(`[${nA}] „Å® [${nB}] „ÅÆ‰ºöË©±„Çí‰øùÂ≠ò„Åó„Åü„ÇàÔºÅüíï`);
        };
    </script>
</body>
</html>